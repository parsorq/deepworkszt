<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/sf-pro-display">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap">
<style>
    /* --- 1. SYSTEM CORE: Variables & Global Resets --- */
    :root {
        --bg-canvas: #0B0E14; 
        --card-bg: #161B22;
        --panel-bg: #161B22; 
        --border: rgba(27, 34, 44, 0.9); 
        --text-main: #F0F9FF; 
        --text-dim: #8a95a6; 
        --accent-cyan: rgba(0, 242, 254, 0.7);
        --accent-blue: rgba(79, 172, 254, 0.7);
        --accent-emerald: rgba(0, 255, 135, 0.7);
        --btn-accent-bg: rgba(0, 255, 135, 0.08);
        --btn-accent-border: rgba(0, 255, 135, 0.2);
        --btn-accent-text: rgba(255, 255, 255, 0.82);
        --btn-accent-bg-strong: rgba(0, 255, 135, 0.14);
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-serif: "Playfair Display", "SF Pro Display", serif;
        --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    * {
        font-family: var(--font-sans) !important;
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
    }

body { 
    margin: 0; 
    background: var(--bg-canvas); 
    background-image: radial-gradient(circle at 50% 10%, #121622 0%, #0B0E14 100%);
    /* Removed flex centering to prevent layout jitter */
    height: 100vh; 
    overflow: hidden; 
    font-size: 13px;
    line-height: 1.6;
}

    #ledger-container::-webkit-scrollbar {
        width: 6px;
    }
    #ledger-container::-webkit-scrollbar-track {
        background: transparent;
    }
    #ledger-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    #ledger-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

/* --- 2. SHELL ARCHITECTURE: Fixed Grid Layout --- */
#tablet-shell { 
    display: grid; 
    grid-template-columns: 1fr 340px; /* Force the 2-column split */
    grid-template-rows: 100%;
    width: 98vw; 
    height: 95vh; 
    background: var(--bg-canvas); 
    border-radius: 36px; 
    border: 0.5px solid #1B222C; 
    overflow: hidden;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 50px 100px rgba(0,0,0,0.8);
    z-index: 1;
}

#content-area { 
    display: flex; 
    flex-direction: column; 
    padding: 40px; 
    overflow: hidden; 
    border-right: 0.5px solid #1B222C;
    position: relative; /* Anchor for ledger items */
}

#engine-sidebar {
    height: 100%;
    background: rgba(22, 27, 34, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 40px 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    overflow-y: auto;
    border-left: 1px solid rgba(0, 242, 254, 0.22);
    box-shadow: inset 0 0 0 1px rgba(0, 242, 254, 0.06);
}

    /* --- 3. NAVIGATION & IDENTITY: Brand and Controls --- */
    .header-top { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 24px; 
    }

    .brand, h1, #day-title {
        color: #B1BDD3 !important;
        font-family: var(--font-serif) !important;
        letter-spacing: 0.01em;
    }

    .brand {
        font-size: 18px;
        letter-spacing: 3px;
        text-transform: uppercase;
        opacity: 0.75;
        font-weight: 700;
    }

    .nav-tabs { 
        display: flex; 
        background: rgba(255, 255, 255, 0.08); 
        border-radius: 10px; 
        margin-bottom: 30px; 
        align-self: flex-start; 
        padding: 2px; 
        border: 0.5px solid var(--border);
    }

    .tab { 
        padding: 8px 18px; 
        font-size: 13px; 
        font-weight: 500; 
        cursor: pointer; 
        border-radius: 8px; 
        color: rgba(255, 255, 255, 0.5); 
        transition: 0.2s;
    }

    .tab.active { 
        background: rgba(255, 255, 255, 0.15); 
        color: #ffffff; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }

    .config-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 6px;
        font-family: "SF Mono", monospace;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.6);
        transition: all 0.2s ease;
        text-transform: uppercase;
    }

    .config-button:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #ffffff;
    }

    /* --- 4. DAILY LEDGER ARCHITECTURE: Grid & Interactive Blocks --- */
    #ledger-container {
        user-select: none;
        -webkit-user-select: none;
        overflow-y: auto; 
        flex: 1; 
        padding: 20px 20px 20px 60px; 
        position: relative;
    }

    .hour-row {
        display: flex;
        height: 100px; 
        border: none !important;
        background: transparent !important;
        position: relative;
        align-items: flex-start;
        cursor: crosshair;
    }

    .hour-label {
        color: rgba(255, 255, 255, 0.5) !important;
        font-family: 'SF Mono', monospace;
        font-size: 16px; 
        font-weight: 600;
        z-index: 2;
        padding-top: 10px;
        width: 60px;
    }

.block-space {
    position: absolute;
    left: 100px; /* Aligned with grid */
    right: 20px;  /* Pushed to the far right of the pane */
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%) !important;
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border-radius: 6px; 
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    display: flex;
    flex-direction: row; /* CRITICAL: Side-by-side columns */
    justify-content: space-between;
    align-items: stretch;
    padding: 0 !important; /* Managed by internal columns now */
    box-sizing: border-box;
    z-index: 30 !important;
    pointer-events: all !important; 
    cursor: pointer;
    overflow: hidden; /* Keeps the "receipt" column contained */
    transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s ease;
}

.block-space:hover {
    border-color: rgba(255, 255, 255, 0.12) !important;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.22);
    transform: translateY(-1px);
    cursor: grab;
}

.block-space * {
    cursor: inherit;
}

#block-context-menu button,
#quick-create-menu button {
    transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease, color 0.12s ease;
}

#block-context-menu button:hover,
#quick-create-menu button:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.18);
    color: rgba(255, 255, 255, 0.9);
}

#block-context-menu button:active,
#quick-create-menu button:active {
    transform: scale(0.98);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.08) inset;
}

.ledger-events-col,
.events-hit-layer {
    cursor: crosshair;
}

body.block-hover:not(.dragging) .ledger-events-col,
body.block-hover:not(.dragging) .events-hit-layer {
    cursor: grab;
}

body.dragging .ledger-events-col,
body.dragging .events-hit-layer {
    cursor: grabbing;
}

.block-space.block-hover {
    border-color: rgba(255, 255, 255, 0.12) !important;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.22);
    transform: translateY(-1px);
}

.block-space.block-moving {
    border-color: rgba(0, 122, 255, 0.6) !important;
    box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.4) inset;
}

body.dragging .block-space,
body.dragging .reminder-marker {
    cursor: grabbing !important;
}


/* Two-column ledger layout */
.ledger-grid {
    display: grid;
    grid-template-columns: 1fr 200px;
    gap: 0;
    height: 100%;
}

.ledger-events-col {
    position: relative;
    border-right: 1px solid rgba(255, 255, 255, 0.05);
    z-index: 2;
}

.ledger-transactions-col {
    position: relative;
    padding-left: 12px;
    z-index: 1;
}

.transaction-marker {
    position: absolute;
    right: 0;
    left: 12px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 4px;
    font-size: 11px;
    pointer-events: all;
    border-left: 2px solid transparent;
}

.transaction-marker.income {
    border-left-color: rgba(50, 215, 75, 0.5);
}

.transaction-marker.expense {
    border-left-color: rgba(255, 59, 48, 0.5);
}

    .type-pill {
        font-size: 9px;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3) !important;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
    }

    .type-pill-active {
        background: var(--pill-color) !important;
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .finance-meta-outer {
        position: absolute;
        right: 25px; 
        width: 150px;
        text-align: right;
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 13px;
        z-index: 10;
        pointer-events: none;
    }

    #time-now-line {
        position: absolute;
        left: 80px;
        right: 20px;
        height: 2px;
        background: linear-gradient(90deg, #ff3b30 0%, #ff3b30 100%);
        box-shadow: 0 0 12px rgba(255, 59, 48, 0.5);
        z-index: 100;
        pointer-events: none;
        transition: top 1s linear;
    }

    #time-now-line::before {
        content: '';
        position: absolute;
        left: -10px;
        top: -4px;
        width: 10px;
        height: 10px;
        background: #ff3b30;
        border-radius: 50%;
        box-shadow: 0 0 8px rgba(255, 59, 48, 0.6);
    }

.ghost-selection {
    position: absolute;
    left: 80px;
    right: 12px;
    background: rgba(0, 122, 255, 0.06);
    border-left: 3px solid #007AFF;
    border-radius: 6px;
    z-index: 50;
    pointer-events: none;
}

    /* --- 5. ENGINE SIDEBAR: Real-time Context & Focus --- */
    #engine-sidebar {
        background: transparent;
        border-left: 1px solid rgba(255, 255, 255, 0.08);
        padding: 40px 24px;
    }

    .timer-card {
        background: rgba(255, 255, 255, 0.03); 
        backdrop-filter: blur(30px) saturate(150%);
        -webkit-backdrop-filter: blur(30px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 28px;
        padding: 30px 20px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .timer-val { 
        color: #ffffff !important; 
        font-size: 38px; 
        margin: 15px 0;
    }

    .intent-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: 20px;
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
        margin-top: 12px;
    }

#graph-stage {
    flex: none; /* Don't let flexbox squish it */
    height: 180px; /* Fixed height for stability */
    background: rgba(255, 255, 255, 0.01) !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    border-radius: 20px;
    position: relative; /* REQUIRED to anchor the label */
    overflow: hidden;
    background-image: radial-gradient(rgba(0, 122, 255, 0.1) 1px, transparent 0) !important;
    background-size: 24px 24px !important;
    margin-top: 20px;
}

/* Add this new rule to your CSS to center the label inside the stage */
#graph-stage span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'SF Mono', monospace;
    font-size: 10px;
    color: var(--accent-blue);
    letter-spacing: 3px;
    text-transform: uppercase;
    opacity: 0.5;
    pointer-events: none;
}

    /* --- 6. MODAL SYSTEM: Centered Glass Panel --- */
#modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.meeting-panel {
    background: var(--card-bg) !important;
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 0.5px solid #1B222C;
    border-radius: 28px;
    padding: 32px;
    width: 100%;
    max-width: 680px;
    height: 85vh;
    overflow-y: auto;
    box-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset;
    animation: modalSlideIn 0.3s cubic-bezier(0.2, 0, 0, 1);
}

/* Edit Meeting: 3 areas — top fixed, middle flexible+scrollable, bottom fixed */
.meeting-panel--editor {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 85vh;
}

.meeting-panel--editor .meeting-panel-header,
.meeting-panel--editor #fixed-fields-container {
    flex: 0 0 auto;
}

.meeting-panel--editor .meeting-panel-body {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 2px 4px 4px;
    width: 100%;
    align-items: start;
    align-content: start;
}

.meeting-panel--editor .meeting-panel-footer {
    flex: 0 0 auto;
}

@keyframes modalSlideIn {
    from { transform: scale(0.95) translateY(20px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
}

/* Date Navigation */
.date-nav {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-nav-btn {
    background: rgba(255,255,255,0.08);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    color: rgba(255,255,255,0.6);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.date-nav-btn:hover {
    background: rgba(255,255,255,0.15);
    color: white;
}

.date-nav-btn:active {
    transform: scale(0.95);
}

.date-display-main {
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    min-width: 100px;
    text-align: center;
}

    .panel-section {
        background: var(--card-bg) !important;
        border: 0.5px solid #1B222C !important;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .meeting-panel textarea {
        width: 100%; height: 120px;
        background: #161B22 !important;
        border: 0.5px solid #1B222C !important;
        border-radius: 14px; padding: 18px; color: #ffffff;
        outline: none; resize: none; transition: all 0.3s ease;
        box-sizing: border-box;
    }

    .meeting-panel textarea:focus {
        background: rgba(22, 27, 34, 0.9) !important;
        border-color: var(--accent-cyan) !important;
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--accent-cyan) !important;
        box-shadow: 0 0 0 1px rgba(0, 242, 254, 0.5), 0 0 14px rgba(0, 255, 135, 0.2);
    }

    .active-input-row {
        box-shadow: 0 0 0 1px rgba(0, 255, 135, 0.45), 0 0 18px rgba(0, 255, 135, 0.25);
    }

    .panel-section--expandable {
        border-color: rgba(255,255,255,0.04) !important;
        box-shadow: none !important;
    }

    .data-row {
        background: transparent !important;
        border: 0.5px solid #1B222C !important;
    }

    .reminder-marker {
        cursor: pointer !important;
        transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        pointer-events: auto;
    }
    .reminder-marker:hover {
        transform: translateY(-1px);
        background: rgba(255,255,255,0.03);
        border-color: rgba(255,255,255,0.08);
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .reminder-layer {
        position: absolute;
        inset: 0;
        z-index: 800;
        pointer-events: none;
    }

    @keyframes spark {
        0% { transform: scale(0.6); opacity: 0.9; }
        100% { transform: scale(2.2); opacity: 0; }
    }
    .input-spark {
        position: fixed;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent-emerald);
        box-shadow: 0 0 10px rgba(0, 255, 135, 0.8);
        pointer-events: none;
        animation: spark 500ms ease-out forwards;
        z-index: 5000;
    }

    @keyframes savePulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 255, 135, 0.6); border-color: var(--accent-emerald); }
        100% { box-shadow: none; border-color: var(--accent-cyan); }
    }
    .save-pulse {
        animation: savePulse 700ms ease-out 1;
    }

    /* --- 7. UTILITIES & TYPOGRAPHY: Global Overrides --- */
    h1, .brand, .tab, .session-label, .p-label, .timer-val, h2 {
        font-weight: 700 !important;
        letter-spacing: -0.02em;
    }
    *[style*="SF Mono"] {
        font-family: var(--font-mono) !important;
    }

    .p-label, label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 10px;
    opacity: 0.5;
    }

    .modal-title-input {
    caret-color: var(--accent-blue);
    }

    .modal-title-input::placeholder {
        color: rgba(255, 255, 255, 0.15);
    }

    .session-label {
        font-size: 18px !important;
    }

    .btn-focus { 
        width: 100%; padding: 16px; border-radius: 12px; border: none; 
        background: var(--text-main); color: #000; font-weight: 700; 
        cursor: pointer; font-size: 12px; transition: opacity 0.2s;
    }

    .btn-focus:active { opacity: 0.8; }

    #monthly-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }

    @keyframes modalScale {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

/* Container to keep squircle and menu aligned */
.type-lockup-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* The Menu: Positioned below with a vertical stack */
#type-selector-expanded {
    display: none; 
    position: absolute !important;
    top: 50px; /* Sits exactly below the 44px squircle */
    left: 0 !important;
    flex-direction: column; /* Stack vertically */
    width: 120px;
    background: rgba(28, 28, 30, 0.98) !important;
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 14px;
    padding: 6px;
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
}

/* List items inside the menu */
.initial-opt {
    width: 100%;
    padding: 10px 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    border-radius: 8px;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.5);
    transition: all 0.2s;
}

.initial-opt:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}


/* Note Popover (Google Sheets style) */
.preread-note-overlay {
    position: absolute;
    background: #1c1c1e;
    border: 1px solid var(--accent-blue);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    z-index: 3000;
    width: 300px;
    display: none;
}

/* Agenda List Styling */
.agenda-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

/* Cash Flow Grid */
.cashflow-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 15px;
}

.cash-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    font-size: 10px;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
}

/* Real-time Ticker */
#burn-ticker {
    font-family: 'SF Mono', monospace;
    color: rgba(50, 215, 75, 0.7);
    font-size: 14px;
    background: rgba(50, 215, 75, 0.08);
    padding: 4px 10px;
    border-radius: 6px;
}


/* --- Agenda Scrolling System --- */
    .agenda-scroll-container {
        max-height: 288px; /* Approx 48px * 6 items */
        overflow-y: auto;
        padding-right: 8px;
        margin-bottom: 12px;
    }

    /* Match the Ledger scrollbar style */
    .agenda-scroll-container::-webkit-scrollbar { width: 4px; }
    .agenda-scroll-container::-webkit-scrollbar-track { background: transparent; }
    .agenda-scroll-container::-webkit-scrollbar-thumb { 
        background: rgba(255, 255, 255, 0.1); 
        border-radius: 10px; 
    }

    .agenda-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }

    .agenda-row:hover { background: rgba(255, 255, 255, 0.02); }

    .agenda-number {
        font-family: 'SF Mono', monospace;
        font-size: 10px;
        color: var(--accent-blue);
        opacity: 0.6;
        width: 20px;
    }

    .agenda-input {
        background: transparent;
        border: none;
        color: white;
        font-size: 13px;
        width: 100%;
        outline: none;
    }

    .add-point-btn {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.4);
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
    }

    .add-point-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent-blue);
        color: white;
    }

body.logged-out #tablet-shell {
    display: none;
}
    

/* Ensure only the active tab is visible and takes up the full viewport space */
.view-content { 
    display: none; 
    height: 100%; 
    flex-direction: column; 
    overflow: hidden; 
    padding-bottom: 20px;
}

.view-content.active { 
    display: flex !important; 
    flex-direction: column;
    height: 100%;
}

/* This is the "kill switch" for inactive views */
.view-content:not(.active) {
    display: none !important;
}

/* Prevents the viewport from becoming a scroll-pit for the whole page */
#viewport {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden; 
    min-height: 0; 
}

#weekly-columns, #monthly-grid, #yearly-grid {
    overflow-y: auto;
    padding-right: 10px;
    scrollbar-width: thin;
}

/* Breathing Colons */
.colon-breathe {
    animation: breathe 2s infinite ease-in-out;
}

@keyframes breathe {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
}

/* Creation Animation (Top to Bottom Wipe) */
.block-creation-anim {
    animation: wipeDown 0.5s cubic-bezier(0.2, 0, 0, 1) forwards;
    transform-origin: top;
}

@keyframes wipeDown {
    from { transform: scaleY(0); opacity: 0; }
    to { transform: scaleY(1); opacity: 1; }
}

/* Subtle Financial Buttons */
.tx-btn {
    flex: 1;
    height: 44px;
    background: transparent;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tx-neg { border: 1px solid rgba(255, 69, 58, 0.2); color: rgba(255, 69, 58, 0.5); }
.tx-neg:hover { background: rgba(255, 69, 58, 0.08); color: rgba(255, 69, 58, 0.8); border-color: rgba(255, 69, 58, 0.6); }

.tx-pos { border: 1px solid rgba(50, 215, 75, 0.2); color: rgba(50, 215, 75, 0.5); }
.tx-pos:hover { background: rgba(50, 215, 75, 0.08); color: rgba(50, 215, 75, 0.8); border-color: rgba(50, 215, 75, 0.6); }

/* Subtle Select Dropdown */
.subtle-select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    outline: none;
    appearance: none;
}
    

</style>


</head>

<body class="mode-architect lens-both logged-out">
<div id="tablet-shell">
    <div id="content-area">
        <div class="header-top">
            <div class="brand" style="display:flex; align-items:center; gap:8px;">
                <img src="assets/logsztv7.png" alt="logszt mark" style="height: 49px; opacity: 0.5; mix-blend-mode: screen; background: transparent; display: block;">
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="font-size: 9px; letter-spacing: 1px; color: rgba(255,255,255,0.4); text-transform: uppercase; font-weight: 700;">Level</div>
                    <select class="config-button" id="cfg-level" onchange="ENGINE.setLevel(this.value)" style="appearance: none;">
                        <option value="INDIVIDUAL">INDIVIDUAL</option>
                        <option value="TEAM">TEAM</option>
                        <option value="INSTITUTION">INSTITUTION</option>
                    </select>
                </div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="font-size: 9px; letter-spacing: 1px; color: rgba(255,255,255,0.4); text-transform: uppercase; font-weight: 700;">Role</div>
                    <select class="config-button" id="cfg-role" onchange="ENGINE.setRole(this.value)" style="appearance: none;">
                        <option value="ARCHITECT">ARCHITECT</option>
                        <option value="SUPERVISOR">SUPERVISOR</option>
                    </select>
                </div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="font-size: 9px; letter-spacing: 1px; color: rgba(255,255,255,0.4); text-transform: uppercase; font-weight: 700;">Lens</div>
                    <select class="config-button" id="cfg-lens" onchange="ENGINE.setLens(this.value)" style="appearance: none;">
                        <option value="PROD">PROD</option>
                        <option value="FINANCE">FINANCE</option>
                        <option value="BOTH">BOTH</option>
                    </select>
                </div>
                <button class="config-button" onclick="ENGINE.openSettings()" aria-label="Settings" style="background: transparent; border: none; font-size: 22px; width: 36px; height: 44px; padding: 0; display: inline-flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.6); margin-top: 14px;">⚙︎</button>
            </div>
        </div>

        <nav class="nav-tabs">
            <div class="tab" onclick="ENGINE.switchTab('year', this)">Yearly Audit</div>
            <div class="tab" onclick="ENGINE.switchTab('month', this)">Monthly Ledger</div>
            <div class="tab" onclick="ENGINE.switchTab('week', this)">Weekly Tactical</div>
            <div class="tab active" onclick="ENGINE.switchTab('day', this)">Daily Ledger</div>
        </nav>

<div id="viewport">
    <div id="day-view" class="view-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 id="day-title" style="margin: 0;">Daily Ledger</h1>
            <div class="date-nav">
                <div style="display:flex; flex-direction:column; align-items:center; gap: 10px;">
                    <span id="current-date-display" class="date-display-main">2026-01-30</span>
                    <div style="display:flex; align-items:center; gap: 12px; margin-top: 2px;">
                        <button class="date-nav-btn" onclick="ENGINE.navigateDate(-1)">‹</button>
                        <button class="date-nav-btn" onclick="ENGINE.goToToday()" style="background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 0 4px;">Today</button>
                        <button class="date-nav-btn" onclick="ENGINE.navigateDate(1)">›</button>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; height: calc(100% - 60px); gap: 16px;">
            <div id="ledger-wrapper" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
                <div id="ledger-container" 
                     style="overflow-y: auto; flex: 1; padding: 20px 20px 20px 60px; position: relative; cursor: crosshair;">
                </div>
            </div>
            <div id="graph-stage" style="height: 180px; flex-shrink: 0;">
                <span>Audit Lens Stage</span>
            </div>
        </div>
    </div>

    <div id="week-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Weekly Tactical</h1>
            <div style="font-family:'SF Mono'; font-size: 12px; color: rgba(0,255,135,0.6);">WEEK 05 / 2026</div>
        </div>
        <div id="weekly-columns" style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 10px; flex: 1; overflow-y: auto;"></div>
    </div>

    <div id="month-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Monthly Analysis</h1>
            <div id="month-burn-total" style="font-family:'SF Mono'; font-weight:700; color: rgba(0,255,135,0.6);">TOTAL: $0.00</div>
        </div>
        <div id="monthly-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; flex: 1; overflow-y: auto;"></div>
    </div>

    <div id="year-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Yearly Audit</h1>
            <div style="font-family:'SF Mono'; font-size: 12px; color: var(--text-dim);">FY_2026_STRATEGY</div>
        </div>
        <div id="yearly-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; flex: 1; overflow-y: auto;"></div>
    </div>
</div>
        
    </div>

<aside id="engine-sidebar" style="background: rgba(22,27,34,0.6); backdrop-filter: blur(10px); border-left: 1px solid rgba(0,242,254,0.2); display: flex; flex-direction: column; padding: 30px 20px; position: relative;">

    <div style="margin-bottom: 22px; text-align: center;">
        <div id="clock-display" style="font-size: 42px; font-weight: 200; color: white; letter-spacing: -1px; opacity: 0.9;">16:07:22</div>
        <div id="date-display" style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 5px; letter-spacing: 1px;">
            03 FEB 2026 // SYSTEM_ACTIVE
        </div>
    </div>

    <div style="margin-bottom: 30px;">
        <label class="p-label" style="font-size: 9px; opacity: 0.4; margin-bottom: 8px; display: block;">ALL-DAY REMINDERS</label>
        <div id="all-day-reminders" style="display:flex; flex-direction:column; gap: 6px;"></div>
    </div>

    <div style="margin-bottom: 30px;">
        <label class="p-label" style="font-size: 9px; opacity: 0.4; margin-bottom: 8px; display: block;">STRATEGIC CONTEXT</label>
        <textarea id="sidebar-notes" 
            style="width: 100%; height: 100px; background: #161B22; border: 0.5px solid #1B222C; border-radius: 8px; color: var(--text-main); padding: 12px; font-size: 13px; outline: none; resize: none;" 
            placeholder="Capture thoughts..."></textarea>
    </div>

    <div style="margin-bottom: 40px;">
        <button id="commence-btn" class="btn-focus" style="width: 100%; height: 50px; background: linear-gradient(90deg, #00F2FE, #4FACFE); color: #0B0E14; font-weight: 700; border-radius: 10px; margin-bottom: 15px; border: none; cursor: pointer;" onclick="ENGINE.commence()">START</button>
        
        <div class="search-container" style="position: relative;">
            <input type="text" id="project-search" 
                style="width: 100%; background: #161B22; border: 0.5px solid #1B222C; height: 40px; border-radius: 8px; padding: 0 15px; color: var(--text-main); font-size: 12px;" 
                placeholder="Search Projects..."
                onkeyup="ENGINE.filterProjects(this.value)">
            </div>

        <div id="active-intent-panel" style="margin-top: 15px; padding: 15px; background: rgba(0,242,254,0.05); border-left: 2px solid #00F2FE; border-radius: 4px;">
            <div style="font-size: 10px; color: #00F2FE; font-weight: 800; margin-bottom: 4px;">ACTIVE_INTENT</div>
            <div id="active-intent-label" style="font-size: 13px; color: white; font-weight: 500;">Infrastructure Refactoring</div>
        </div>
    </div>

    <div style="margin-top: auto; border-top: 0.5px solid #1B222C; padding-top: 25px;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="ENGINE.quickTx(-1)" style="flex: 1; height: 44px; background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); border-radius: 10px; font-size: 20px; font-weight: 700; letter-spacing: 1px;">-</button>
            <button onclick="ENGINE.quickTx(1)" style="flex: 1; height: 44px; background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); border-radius: 10px; font-size: 20px; font-weight: 700; letter-spacing: 1px;">+</button>
        </div>

        <div id="recent-transactions" style="display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto;">
        </div>

        <button onclick="ENGINE.openAudit()" style="width: 100%; margin-top: 20px; background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding: 10px; border-radius: 6px; font-size: 10px; font-weight: 800; letter-spacing: 1px;">AUDIT LEDGER</button>

        <div id="system-health" style="margin-top: 18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:10px; letter-spacing:1px; color: rgba(177,189,211,0.8);">
                <span>HOURS LOGGED</span>
                <span id="system-health-value">0.0h / 24h</span>
            </div>
            <div style="height: 6px; margin-top: 8px; background: rgba(255,255,255,0.05); border-radius: 999px; overflow: hidden; border: 0.5px solid #1B222C;">
                <div id="system-health-bar" style="height: 100%; width: 92%; background: linear-gradient(90deg, #00F2FE, #4FACFE, #00FF87); box-shadow: 0 0 10px rgba(0,242,254,0.4);"></div>
            </div>
        </div>
    </div>
</aside>
</div>

<script>
const GOOGLE_CLIENT_ID = window.LOGSZT_CONFIG?.googleClientId
    || localStorage.getItem('LOGSZT_GOOGLE_CLIENT_ID')
    || '942992080405-taq2kl6gche5fk591eib692abi7svvb8.apps.googleusercontent.com';
const MASTER_REGISTRY_SHEET_ID = window.LOGSZT_CONFIG?.masterRegistrySheetId
    || '1t9WclgP_VyDu4BWyyvnAFjVza7p5fuwJ73X6t5NAGs8';
const USER_TEMPLATE_SHEET_ID = window.LOGSZT_CONFIG?.userTemplateSheetId
    || '1-HtYYGeSRQdSf0gH3Fpudi_nBuLl6jJnZZQjSKHp7pw';
const ENGINE_USER_FILE_NAME = 'ENGINE_USER_DATA_V1';
const GOOGLE_SCOPES = [
    'https://www.googleapis.com/auth/drive.file',
    'https://www.googleapis.com/auth/drive.metadata.readonly',
    'https://www.googleapis.com/auth/spreadsheets',
    'openid',
    'email',
    'profile'
].join(' ');
const GOOGLE_DISCOVERY_DOCS = [
    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
    'https://sheets.googleapis.com/$discovery/rest?version=v4'
];

let googleTokenClient = null;
let googleAccessToken = null;
let googleReadyPromise = null;
let googleReady = false;
let loginOverlay = null;

function loadGoogleScript(src) {
    return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
            const isApi = src.includes('apis.google.com');
            const isGis = src.includes('accounts.google.com');
            if ((isApi && window.gapi) || (isGis && window.google)) {
                resolve();
                return;
            }
            existing.addEventListener('load', resolve, { once: true });
            existing.addEventListener('error', reject, { once: true });
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.defer = true;
        script.onload = () => {
            script.dataset.loaded = 'true';
            resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function ensureGoogleReady() {
    if (googleReadyPromise) return googleReadyPromise;
    if (!GOOGLE_CLIENT_ID) {
        const message = 'Missing Google configuration. Set LOGSZT_GOOGLE_CLIENT_ID in localStorage.';
        setLoginStatus(message, true);
        return Promise.reject(new Error(message));
    }
    googleReadyPromise = Promise.all([
        loadGoogleScript('https://apis.google.com/js/api.js').then(() => {
            return new Promise((resolve) => {
                gapi.load('client', async () => {
                    await gapi.client.init({ discoveryDocs: GOOGLE_DISCOVERY_DOCS });
                    resolve();
                });
            });
        }),
        loadGoogleScript('https://accounts.google.com/gsi/client').then(() => {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const waitForGsi = () => {
                    if (window.google?.accounts?.oauth2) {
                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: GOOGLE_SCOPES,
                            callback: () => {}
                        });
                        resolve();
                        return;
                    }
                    attempts += 1;
                    if (attempts > 40) {
                        reject(new Error('Google Identity Services failed to load.'));
                        return;
                    }
                    setTimeout(waitForGsi, 50);
                };
                waitForGsi();
            });
        })
    ]).then(() => {
        googleReady = true;
    });
    return googleReadyPromise;
}

function setLoginStatus(message, isError = false) {
    const status = document.getElementById('engine-login-status');
    if (!status) return;
    status.textContent = message;
    status.style.color = isError ? '#ff453a' : 'rgba(255,255,255,0.7)';
}

async function fetchUserProfile() {
    const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: `Bearer ${googleAccessToken}` }
    });
    if (!res.ok) {
        throw new Error('Unable to load user profile.');
    }
    return res.json();
}

async function validateMasterRegistry(email) {
    const range = 'A:Z';
    const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: MASTER_REGISTRY_SHEET_ID,
        range
    });
    const rows = res.result.values || [];
    const target = email.trim().toLowerCase();
    return rows.some((row) =>
        row.some((cell) => String(cell || '').trim().toLowerCase() === target)
    );
}

async function handleLogin(promptMode = 'consent') {
    await ensureGoogleReady();
    return new Promise((resolve, reject) => {
        if (!googleTokenClient) {
            reject(new Error('Google sign-in is not ready. Refresh and try again.'));
            return;
        }
        const timeoutId = setTimeout(() => {
            reject(new Error('Google sign-in timed out. Check popup blockers or privacy settings.'));
        }, 15000);
        googleTokenClient.callback = async (response) => {
            clearTimeout(timeoutId);
            if (response.error) {
                const details = response.error_description || response.error;
                reject(new Error(`Google sign-in failed: ${details}`));
                return;
            }
            googleAccessToken = response.access_token;
            gapi.client.setToken({ access_token: googleAccessToken });
            try {
                const profile = await fetchUserProfile();
                const allowed = await validateMasterRegistry(profile.email);
                if (!allowed) {
                    reject(new Error('Access denied by Master Registry. Add your email to the registry sheet.'));
                    return;
                }
                ENGINE.userEmail = profile.email;
                localStorage.setItem('ENGINE_LAST_USER', profile.email);
                await ENGINE.init();
                document.body.classList.remove('logged-out');
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        googleTokenClient.requestAccessToken({ prompt: promptMode });
    });
}

function handleLoginInteractive(promptMode = 'select_account') {
    return new Promise((resolve, reject) => {
        if (!googleReady || !googleTokenClient) {
            reject(new Error('Google services are still loading. Please click Log in again.'));
            return;
        }
        const timeoutId = setTimeout(() => {
            reject(new Error('Google sign-in timed out. Check popup blockers or privacy settings.'));
        }, 15000);
        googleTokenClient.callback = async (response) => {
            clearTimeout(timeoutId);
            if (response.error) {
                const details = response.error_description || response.error;
                reject(new Error(`Google sign-in failed: ${details}`));
                return;
            }
            googleAccessToken = response.access_token;
            gapi.client.setToken({ access_token: googleAccessToken });
            try {
                const profile = await fetchUserProfile();
                const allowed = await validateMasterRegistry(profile.email);
                if (!allowed) {
                    reject(new Error('Access denied by Master Registry. Add your email to the registry sheet.'));
                    return;
                }
                ENGINE.userEmail = profile.email;
                localStorage.setItem('ENGINE_LAST_USER', profile.email);
                await ENGINE.init();
                document.body.classList.remove('logged-out');
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        googleTokenClient.requestAccessToken({ prompt: promptMode });
    });
}

function showLoginUI() {
    if (document.getElementById('engine-login-overlay')) return;
    document.body.classList.add('logged-out');
    loginOverlay = document.createElement('div');
    loginOverlay.id = 'engine-login-overlay';
    loginOverlay.style.cssText = `
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.65);
        z-index: 2000;
        backdrop-filter: blur(12px);
    `;
    loginOverlay.innerHTML = `
        <div style="width: 100%; max-width: 420px; background: rgba(20,20,24,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 28px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.6);">
            <div style="font-size: 14px; letter-spacing: 2px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 10px;">SECURE ACCESS</div>
            <div style="font-size: 22px; color: #ffffff; font-weight: 700; margin-bottom: 10px;">Authenticate with Google</div>
            <div id="engine-login-status" style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 20px;">Sign in to sync with your Sheets ledger.</div>
            <div id="engine-login-config" style="display: none; margin-bottom: 16px; text-align: left;">
                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Google client ID (stored locally)</div>
                <input id="engine-google-client-id" placeholder="Google Client ID" style="width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 10px; border-radius: 8px; font-size: 11px; outline: none; margin-bottom: 8px;">
                <button id="engine-login-save-config" style="width: 100%; padding: 8px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.16); border-radius: 8px; color: white; font-weight: 700; font-size: 10px; cursor: pointer;">Save client ID</button>
            </div>
            <button id="engine-login-btn" style="width: 100%; padding: 12px 16px; background: var(--btn-accent-bg-strong); border: 1px solid var(--btn-accent-border); border-radius: 10px; color: var(--btn-accent-text); font-weight: 700; cursor: pointer;">Sign in</button>
        </div>
    `;
    document.body.appendChild(loginOverlay);

    const btn = document.getElementById('engine-login-btn');
    const configPanel = document.getElementById('engine-login-config');
    const saveConfigBtn = document.getElementById('engine-login-save-config');
    const clientIdInput = document.getElementById('engine-google-client-id');
    const configMissing = !GOOGLE_CLIENT_ID;

    if (configMissing && configPanel) {
        configPanel.style.display = 'block';
        if (clientIdInput && GOOGLE_CLIENT_ID) clientIdInput.value = GOOGLE_CLIENT_ID;
    }
    btn.disabled = true;
    btn.style.opacity = '0.6';
    setLoginStatus('Loading Google services...');
    ensureGoogleReady().then(async () => {
        const lastUser = localStorage.getItem('ENGINE_LAST_USER');
        if (lastUser) {
            setLoginStatus('Checking existing session...');
            try {
                await handleLogin('');
                loginOverlay.remove();
                return;
            } catch (err) {
                setLoginStatus('Sign in to sync with your Sheets ledger.');
            }
        } else {
            setLoginStatus('Sign in to sync with your Sheets ledger.');
        }
        btn.disabled = false;
        btn.style.opacity = '1';
    }).catch((err) => {
        setLoginStatus(err?.message || 'Unable to load Google services. Check blockers or network.', true);
        btn.disabled = true;
        btn.style.opacity = '0.6';
    });
    if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', () => {
            const clientId = clientIdInput ? clientIdInput.value.trim() : '';
            if (!clientId) {
                setLoginStatus('Please enter the Google Client ID.', true);
                return;
            }
            localStorage.setItem('LOGSZT_GOOGLE_CLIENT_ID', clientId);
            setLoginStatus('Config saved. Reloading...', false);
            window.location.reload();
        });
    }
    btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        setLoginStatus('Connecting to Google...');
        try {
            if (!googleReady || !googleTokenClient) {
                setLoginStatus('Loading Google services... click Log in again.', false);
                ensureGoogleReady().catch((err) => {
                    setLoginStatus(err?.message || 'Unable to load Google services. Check blockers or network.', true);
                });
                btn.disabled = false;
                btn.style.opacity = '1';
                return;
            }
            await handleLoginInteractive('select_account');
            loginOverlay.remove();
        } catch (err) {
            console.error('Login failed:', err);
            const message = err && err.message ? err.message : 'Unknown error. Check console.';
            setLoginStatus(`Login failed: ${message}`, true);
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    });
}

const ENGINE = {
    role: 'ARCHITECT',
    lens: 'BOTH',
    scope: 'INDIVIDUAL',
    activeType: 'MEETING',
    activeTypeContext: { isRemote: true },
    rates: { INDIVIDUAL: 150, TEAM: 1200, INSTITUTION: 8500 },
    selectedDate: new Date().toISOString().split('T')[0],
    currentEventIdx: null, // Track which event is being edited
    quickCreateStartH: null,
    dragHasMoved: false,
    dragStartClient: null,
    dragPointerId: null,
    hoverBlockEl: null,
    moveEventIdx: null,
    moveDurationH: null,
    moveBlockEl: null,
    moveOffsetH: 0,
    moveStartH: null,
    isMoving: false,
    moveType: null,
    moveTxIdx: null,
    moveTxEl: null,
    moveTxPointerId: null,
    moveTxTempH: null,
    undoStack: [],
    undoLimit: 30,

    db: {},
    transactions: [],
    teams: [],
    profiles: [],
    institutions: [],
    projects: [],
    categories: [],
    subcategories: [],
    userEmail: null,
    userSheetId: null,
    sheetInfo: null,
    metaSaveTimer: null,
    sheetNames: {
        events: 'Events',
        transactions: 'Transactions',
        meta: 'Meta',
        teams: 'Teams',
        profiles: 'Profiles',
        institutions: 'Institutions',
        projects: 'Projects',
        categories: 'Categories',
        subcategories: 'Subcategories'
    },

    isDragging: false,
    dragStartH: null,
    dragEndH: null,
    meetingStartTime: null,
    burnRatePerSecond: 0,
    notesHistory: [],
    activeBurnRate: 150,
    currentNet: 23550.00,
    isMeetingActive: false,
    GRID_TOP_OFFSET: 0,
    HOUR_HEIGHT: 100,
    nextEventId: 100, // For generating unique IDs
    editMeetingWidgets: { stakeholders: true, agenda: true, timeblockExpenses: true },
    editMeetingDraftWidgets: {},
    expandedWidget: null,


async init() {
    await this.loadData();
    this.injectStyles();
    this.syncConfigControls();
    this.bindTransactionInputs();
    this.bindInputEffects();
    this.updateDateDisplay();
    this.render();
    this.renderTransactions();
    this.updatePanelContext();
    this.initFinancialPulse();
    this.startTimelineUpdater();
    this.bindLedgerInteractions();

    // Global listeners for smooth drag
    window.addEventListener('mousemove', (e) => this.handleMouseMove(e));
    window.addEventListener('mouseup', () => this.handleMouseUp());
    document.addEventListener('pointermove', (e) => this.handlePointerMove(e), true);
    document.addEventListener('pointerup', (e) => this.handlePointerUp(e), true);
    document.addEventListener('pointercancel', (e) => this.handlePointerUp(e), true);

    // Global capture handlers for ledger interactions
    document.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        if (e.pointerType === 'mouse' && e.ctrlKey) return;
        if (e.target.closest('#quick-create-menu')) return;
        if (e.target.closest('#block-context-menu')) return;
        if (this.getReminderAtPoint(e.clientX, e.clientY) !== null) return;
        if (e.target.closest('.reminder-marker')) return;
        if (e.target.closest('.transaction-marker')) return;
        if (e.target.closest('[data-block-idx]')) return;
        const bounds = this.getEventsBounds();
        if (!bounds) return;
        if (e.clientX < bounds.left || e.clientX > bounds.right || e.clientY < bounds.top || e.clientY > bounds.bottom) return;
        this.startDragFromEvent(e);
    }, true);
    document.addEventListener('contextmenu', (e) => {
        const bounds = this.getEventsBounds();
        if (!bounds) return;
        if (e.clientX < bounds.left || e.clientX > bounds.right || e.clientY < bounds.top || e.clientY > bounds.bottom) return;
        this.handleContextMenu(e);
    }, true);
    document.addEventListener('mousedown', (e) => {
        this.hideMenusOnOutsideClick(e);
    }, true);
    document.addEventListener('pointerdown', (e) => {
        this.hideMenusOnOutsideClick(e);
    }, true);
    document.addEventListener('wheel', () => {
        this.hideAllMenus();
    }, true);
    document.addEventListener('keydown', () => {
        this.hideAllMenus();
    }, true);
    window.addEventListener('resize', () => {
        this.hideAllMenus();
    });
    document.addEventListener('keydown', (e) => {
        const isUndo = (e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'z';
        if (!isUndo) return;
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
            return;
        }
        e.preventDefault();
        this.undoLastAction();
    });
    document.addEventListener('mousemove', (e) => {
        this.updateBlockHover(e.clientX, e.clientY);
    }, true);
    document.addEventListener('dblclick', (e) => {
        if (e.button !== 0) return;
        if (e.target.closest('#quick-create-menu')) return;
        if (e.target.closest('#block-context-menu')) return;
        const bounds = this.getEventsBounds();
        if (!bounds) return;
        if (e.clientX < bounds.left || e.clientX > bounds.right || e.clientY < bounds.top || e.clientY > bounds.bottom) return;
        e.preventDefault();
        e.stopPropagation();
        this.hideQuickCreateMenu();
        this.hideBlockMenu();
        const eventIdx = this.getEventAtPoint(e.clientX, e.clientY);
        if (eventIdx !== null) {
            this.openMeeting(eventIdx);
            return;
        }
        const startH = this.getHourAtClientY(e.clientY);
        if (startH !== null) this.showQuickCreateMenu(e.clientX, e.clientY, startH);
    }, true);

    // Modal close on Esc key
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('modal-overlay');
            if (modal && modal.style.display === 'flex') {
                this.closeModal();
            }
        }
    });

    // Modal close on click outside
    const modal = document.getElementById('modal-overlay');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeModal();
            }
        });
    }

    const settingsOverlay = document.getElementById('settings-overlay');
    if (settingsOverlay) {
        settingsOverlay.addEventListener('click', (e) => {
            if (e.target === settingsOverlay) {
                this.closeSettings();
            }
        });
    }

    const editMeetingSettingsOverlay = document.getElementById('edit-meeting-settings-overlay');
    if (editMeetingSettingsOverlay) {
        editMeetingSettingsOverlay.addEventListener('click', (e) => {
            if (e.target === editMeetingSettingsOverlay) {
                this.closeEditMeetingSettings();
            }
        });
    }

    const editOverlay = document.getElementById('edit-entity-overlay');
    if (editOverlay) {
        editOverlay.addEventListener('click', (e) => {
            if (e.target === editOverlay) {
                this.closeEditEntity();
            }
        });
    }

    const transactionOverlay = document.getElementById('transaction-overlay');
    if (transactionOverlay) {
        transactionOverlay.addEventListener('click', (e) => {
            if (e.target === transactionOverlay) {
                this.closeTransactionModal();
            }
        });
    }

    const auditOverlay = document.getElementById('audit-overlay');
    if (auditOverlay) {
        auditOverlay.addEventListener('click', (e) => {
            if (e.target === auditOverlay) {
                this.closeAudit();
            }
        });
    }

    // Initial timeline position
    setTimeout(() => this.updateTimeline(true), 100);
},

syncConfigControls() {
    const level = document.getElementById('cfg-level');
    const role = document.getElementById('cfg-role');
    const lens = document.getElementById('cfg-lens');
    if (level) level.value = this.scope;
    if (role) role.value = this.role;
    if (lens) lens.value = this.lens;
},

// Date Navigation
navigateDate(delta) {
    const current = new Date(this.selectedDate);
    current.setDate(current.getDate() + delta);
    this.selectedDate = current.toISOString().split('T')[0];
    this.updateDateDisplay();
    this.renderDay();
},

updateDateDisplay() {
    const el = document.getElementById('current-date-display');
    if (el) el.textContent = this.selectedDate;
},

goToToday() {
    this.selectedDate = new Date().toISOString().split('T')[0];
    this.updateDateDisplay();
    this.renderDay();
    this.updateTimeline(true);
},

// Persistent red line updater
startTimelineUpdater() {
    // Update every second for smooth movement
    setInterval(() => {
        this.updateTimeline(false);
    }, 1000);
},

// Delete event functionality
async deleteCurrentEvent() {
    if (this.currentEventIdx === null) return;

    const events = this.db[this.selectedDate];
    if (!events || !events[this.currentEventIdx]) return;

    const [removed] = events.splice(this.currentEventIdx, 1);
    if (removed) {
        this.recordUndo({ type: 'deleteEvent', event: { ...removed } });
    }
    if (events.length === 0) delete this.db[this.selectedDate];

    if (removed && removed.id) {
        await this.deleteEventById(removed.id);
    }

    this.closeModal();
    this.renderDay();
},

// Generate unique event ID
generateEventId() {
    return `evt-${Date.now()}-${this.nextEventId++}`;
},

// Render recent transactions in sidebar
renderTransactions() {
    const container = document.getElementById('recent-transactions');
    if (!container) return;

    const recentTx = this.transactions.slice(0, 3);
    container.innerHTML = recentTx.map(tx => {
        const idx = this.transactions.indexOf(tx);
        const categoryLabel = (tx.category || tx.subcategory)
            ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
            : '';
        return `
        <div onclick="ENGINE.openTransactionModalWithData('${this.escapeAttribute(tx.id)}', ${idx})" class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-radius: 6px; cursor: pointer;">
            <div>
                <div style="font-size: 11px; color: white; font-weight: 500;">${this.escapeHTML(tx.item || tx.desc)}</div>
                <div style="font-size: 9px; color: rgba(255,255,255,0.4); font-family: 'SF Mono';">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
            </div>
            <div style="font-family: 'SF Mono'; font-size: 12px; font-weight: 600; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                ${tx.amount >= 0 ? '+' : ''}${this.formatAmount(tx.amount)}
            </div>
        </div>
    `;
    }).join('');
},

// Add a new transaction
addTransaction(desc, amount, category = 'General', subcategory = '', date = null, time = null, eventId = '', item = '', description = '') {
    const now = new Date();
    const txDate = date || this.formatDate(now.toISOString().split('T')[0]);
    const txTime = time || now.toTimeString().slice(0, 5);
    const parsedAmount = this.parseAmount(amount);
    if (parsedAmount === null) return;
    const tx = {
        id: `tx-${Date.now()}`,
        date: txDate,
        time: txTime,
        desc,
        item: item || '',
        description: description || '',
        amount: parsedAmount,
        category,
        subcategory: subcategory || '',
        eventId: eventId || ''
    };
    this.transactions.unshift(tx);
    this.recordUndo({ type: 'addTransaction', txId: tx.id });
    this.sortTransactions();
    this.currentNet += tx.amount;
    void this.saveTransaction(tx);
    this.renderTransactions();
    return tx;
},

sortTransactions() {
    this.transactions.sort((a, b) => {
        const aStamp = `${a.date} ${a.time || '00:00'}`;
        const bStamp = `${b.date} ${b.time || '00:00'}`;
        return bStamp.localeCompare(aStamp);
    });
},

// Quick transaction buttons
quickTx(sign) {
    this.openTransactionModal(sign);
},

updateLifeClock() {
    const now = new Date();
    const blocks = this.db[this.selectedDate] || [];
    
    // Sum allocated time from blocks (ms)
    const allocatedMs = blocks.reduce((acc, b) => acc + (b.end - b.start) * 3600000, 0);
    
    // Current time in ms since start of day
    const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const currentTimeMs = now.getTime() - dayStart;
    
    // Available Life = Current Time - Used Time
    const lifeClockMs = Math.max(0, currentTimeMs - allocatedMs);
    
    // Formatting
    const hrs = Math.floor(lifeClockMs / 3600000).toString().padStart(2, '0');
    const mins = Math.floor((lifeClockMs % 3600000) / 60000).toString().padStart(2, '0');
    const secs = Math.floor((lifeClockMs % 60000) / 1000).toString().padStart(2, '0');

    const clockEl = document.getElementById('clock-display');
    if (clockEl) {
        // Toggle breathing class on colons if session is active
        const colonClass = this.isMeetingActive ? 'class="colon-breathe"' : '';
        clockEl.innerHTML = `${hrs}<span ${colonClass}>:</span>${mins}<span ${colonClass}>:</span>${secs}`;
    }
},

    
    
initFinancialPulse() {
    // 1. Prevent multiple intervals from running simultaneously
    if (this.fiscalInterval) clearInterval(this.fiscalInterval);

    // 2. Inject Styles safely (singleton pattern)
    if (!document.getElementById('engine-pulse-styles')) {
        const style = document.createElement('style');
        style.id = 'engine-pulse-styles';
        style.innerHTML = `
            @keyframes pulse-red {
                0%, 100% { color: #00FF87; opacity: 1; }
                50% { color: #ff453a; opacity: 0.7; }
            }
            @keyframes liquidFlow {
                0% { background-position: 0% 50%; }
                100% { background-position: 200% 50%; }
            }
            .burning { animation: pulse-red 1.5s ease-in-out infinite; }
            .progress-line { 
                position: absolute; bottom: 0; left: 0; height: 4px; 
                background: linear-gradient(90deg, #00F2FE, #4FACFE, #00FF87);
                background-size: 200% 100%;
                transition: width 1s linear; 
                animation: liquidFlow 3s linear infinite;
                box-shadow: 0 0 12px rgba(0, 242, 254, 0.5);
            }
        `;
        document.head.appendChild(style);
    }

    // 3. Set up the execution loop
    this.fiscalInterval = setInterval(() => {
        if (!this.isMeetingActive) {
            const sideBurn = document.getElementById('sidebar-burn');
            if (sideBurn) sideBurn.classList.remove('burning');
            return;
        }

        const totalBudget = 25000;
        const burnPerSec = this.activeBurnRate / 3600;
        
        // Update Internal State
        this.currentNet -= burnPerSec;

        // --- DOM UPDATES ---

        // A. Update Sidebar Text & Animation
        const sideBurn = document.getElementById('sidebar-burn');
        if (sideBurn) {
            sideBurn.innerText = `BURN: $${burnPerSec.toFixed(4)}/SEC`;
            sideBurn.classList.add('burning');
        }

        // B. Update Graph Stage (The Audit Lens)
        const stage = document.getElementById('graph-stage');
        if (stage) {
            const percent = (this.currentNet / totalBudget) * 100;
            
            // Update or Create the progress line
            let line = stage.querySelector('.progress-line');
            if (!line) {
                line = document.createElement('div');
                line.className = 'progress-line';
                stage.appendChild(line);
            }
            line.style.width = `${percent}%`;

            // Update the Label
            const label = stage.querySelector('span');
            if (label) label.innerText = `FISCAL_STABILITY: ${percent.toFixed(2)}%`;
        }

        // C. Update Ledger Display (If viewing the Ledger)
        const netDisplay = document.getElementById('net-remaining-display');
        if (netDisplay) {
            netDisplay.innerText = `$${this.currentNet.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        } else {
            // If we are in another tab, update the sidebar's net display instead
            const sideNet = document.getElementById('sidebar-net-total');
            if (sideNet) sideNet.innerText = `$${Math.floor(this.currentNet).toLocaleString()}`;
        }

        // 4. Auto-save meta periodically without spamming the API
        if (Math.floor(Date.now() / 1000) % 10 === 0) {
            this.queueMetaSave();
        }

    }, 1000);
},

setBurnGear(val) {
    const parsed = this.parseAmount(val);
    if (parsed === null) return;
    this.activeBurnRate = parsed;
},

handleMouseDown(e) {
    this.hideBlockMenu();
    if (e.target.closest('#quick-create-menu')) return;
    if (e.target.closest('#block-context-menu')) return;
    this.startDragFromEvent(e);
},

handleMouseMove(e) {
    if (this.moveTxIdx !== null) {
        if (this.moveTxPointerId !== null && e.pointerId !== this.moveTxPointerId) return;
        const bounds = this.getTransactionsBounds();
        if (!bounds) return;
        const relativeY = e.clientY - bounds.top;
        const rawH = relativeY / this.HOUR_HEIGHT;
        const clamped = Math.max(0, Math.min(24, rawH));
        const step = 0.25;
        const snapped = Math.round(clamped / step) * step;
        if (this.moveTxEl) {
            this.moveTxEl.style.top = `${snapped * this.HOUR_HEIGHT}px`;
        }
        this.moveTxTempH = snapped;
        return;
    }
    if (this.isMoving) {
        if (this.dragPointerId !== null && e.pointerId !== this.dragPointerId) return;
        const eventsCol = document.querySelector('.ledger-events-col');
        if (!eventsCol) return;
        const rect = eventsCol.getBoundingClientRect();
        const relativeY = e.clientY - rect.top;
        const rawH = relativeY / this.HOUR_HEIGHT;
        const duration = this.moveDurationH || 0.25;
        let start = rawH - (this.moveOffsetH || 0);
        start = Math.max(0, Math.min(24 - duration, start));
        this.moveStartH = start;
        this.dragStartH = start;
        this.dragEndH = start + duration;
        requestAnimationFrame(() => this.updateGhost());
        return;
    }

    if (!this.isDragging) return;
    if (this.dragPointerId !== null && e.pointerId !== this.dragPointerId) return;

    const container = document.getElementById('ledger-container');
    if (!container) return;

    const eventsCol = document.querySelector('.ledger-events-col');
    if (!eventsCol) return;
    const rect = eventsCol.getBoundingClientRect();
    const relativeY = e.clientY - rect.top;

    const rawH = relativeY / this.HOUR_HEIGHT;
    if (this.dragStartClient) {
        const dx = Math.abs(e.clientX - this.dragStartClient.x);
        const dy = Math.abs(e.clientY - this.dragStartClient.y);
        this.dragHasMoved = dx > 3 || dy > 3 || Math.abs(rawH - this.dragStartH) > 0.02;
    } else {
        this.dragHasMoved = true;
    }
    // Constrain to 0-24 hour range
    this.dragEndH = Math.max(0, Math.min(24, rawH));

    // Use requestAnimationFrame for smooth updates
    requestAnimationFrame(() => this.updateGhost());
},

    handleMouseOver(h, isHalf) {
        if (!this.isDragging) return;
        const val = isHalf ? h + 0.5 : h;
        if (this.dragEndH === val) return;
        this.dragEndH = val;
        this.renderDay();
    },

handleMouseUp() {
    if (this.moveTxIdx !== null) {
        this.finishMoveTransaction();
        return;
    }
    if (this.isMoving) {
        this.finishMoveEvent();
        return;
    }
    if (!this.isDragging) return;
    const step = 0.25; // 15 min increments
    let start = Math.round(Math.min(this.dragStartH, this.dragEndH) / step) * step;
    let end = Math.round(Math.max(this.dragStartH, this.dragEndH) / step) * step;

    // Only create a block if the user actually dragged
    if (!this.dragHasMoved && start === end) {
        this.isDragging = false;
        document.body.classList.remove('dragging');
        this.dragStartH = null;
        this.dragEndH = null;
        this.dragHasMoved = false;
        this.dragStartClient = null;
        const ghost = document.getElementById('ghost-selection');
        if (ghost) ghost.style.display = 'none';
        this.renderDay();
        return;
    }
    if (start === end) {
        end = Math.min(24, start + 0.25);
    }

    if (!this.db[this.selectedDate]) this.db[this.selectedDate] = [];

    const hasOverlap = this.db[this.selectedDate].some(s => s.type !== 'REMINDER' && (start < s.end && end > s.start));

    if (!hasOverlap && (end - start) >= 0.25) {
        const newEvent = {
            id: this.generateEventId(),
            start,
            end,
            label: "New Session",
            type: 'MEETING',
            isNew: true,
            date: this.selectedDate,
            agenda: '',
            stakeholders: '',
            notes: '',
            budget: '',
            allDay: false,
            widgets: {}
        };
        this.db[this.selectedDate].push(newEvent);
        this.recordUndo({ type: 'addEvent', event: { ...newEvent } });
        void this.saveEvent(newEvent);
    }

    // Clean up drag state
    this.isDragging = false;
    document.body.classList.remove('dragging');
    this.dragStartH = null;
    this.dragEndH = null;
    this.dragHasMoved = false;
    this.dragStartClient = null;

    // Hide the ghost
    const ghost = document.getElementById('ghost-selection');
    if (ghost) ghost.style.display = 'none';

    this.renderDay();
},

updateGhost() {
    // Find the events column to append ghost to
    const eventsCol = document.querySelector('.ledger-events-col');
    if (!eventsCol) return;

    let g = document.getElementById('ghost-selection');
    if (!g) {
        g = document.createElement('div');
        g.id = 'ghost-selection';
        g.className = 'ghost-selection';
        eventsCol.appendChild(g);
    } else if (g.parentElement !== eventsCol) {
        eventsCol.appendChild(g);
    }

    if (!this.isDragging && !this.isMoving) {
        g.style.display = 'none';
        return;
    }

    const step = 0.25;
    const topH = Math.round(Math.min(this.dragStartH, this.dragEndH) / step) * step;
    let bottomH = Math.round(Math.max(this.dragStartH, this.dragEndH) / step) * step;
    if (topH === bottomH) bottomH += 0.25;
    const duration = bottomH - topH;

    g.style.display = 'block';
    g.innerHTML = '';

    if (this.isMoving && this.moveType === 'reminder') {
        g.style.top = `${(topH * this.HOUR_HEIGHT) - 6}px`;
        g.style.height = `16px`;
        g.style.left = 'auto';
        g.style.right = '22px';
        g.style.padding = '2px 6px';
        g.style.borderRadius = '6px';
        g.style.background = 'rgba(255,255,255,0.03)';
        g.style.border = '1px solid rgba(255,255,255,0.08)';
        g.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    } else {
        g.style.left = '80px';
        g.style.right = '12px';
        g.style.padding = '0';
        g.style.borderRadius = '0';
        g.style.top = `${topH * this.HOUR_HEIGHT}px`;
        g.style.height = `${duration * this.HOUR_HEIGHT}px`;
        g.style.background = 'rgba(255,255,255,0.02)';
        g.style.border = 'none';
        g.style.borderLeft = '2px solid rgba(0,122,255,0.6)';
        g.style.boxShadow = '0 0 0 1px rgba(255,255,255,0.04) inset';
    }
},

handleContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    this.hideQuickCreateMenu();
    this.hideBlockMenu();

    const reminderIdx = this.getReminderAtPoint(e.clientX, e.clientY);
    if (reminderIdx !== null) {
        this.showBlockMenu(e.clientX, e.clientY, reminderIdx);
        return;
    }
    const eventIdx = this.getEventAtPoint(e.clientX, e.clientY);
    if (eventIdx !== null) {
        this.showBlockMenu(e.clientX, e.clientY, eventIdx);
        return;
    }
    const startH = this.getHourAtClientY(e.clientY);
    if (startH !== null) this.showQuickCreateMenu(e.clientX, e.clientY, startH);
},
    
getEventsBounds() {
    const eventsCol = document.querySelector('.ledger-events-col');
    if (!eventsCol) return null;
    return eventsCol.getBoundingClientRect();
},

getHourAtClientY(clientY) {
    const bounds = this.getEventsBounds();
    if (!bounds) return null;
    if (clientY < bounds.top || clientY > bounds.bottom) return null;
    const offsetY = clientY - bounds.top;
    const rawH = offsetY / this.HOUR_HEIGHT;
    return Math.max(0, Math.min(24, rawH));
},

startDragFromEvent(e) {
    if (this.isDragging) return;
    if (e.button !== 0) return;
    const bounds = this.getEventsBounds();
    if (!bounds) return;
    if (e.clientX < bounds.left || e.clientX > bounds.right || e.clientY < bounds.top || e.clientY > bounds.bottom) return;
    if (this.getReminderAtPoint(e.clientX, e.clientY) !== null) return;
    this.hideQuickCreateMenu();
    const startH = this.getHourAtClientY(e.clientY);
    if (startH === null) return;
    this.isDragging = true;
    document.body.classList.add('dragging');
    this.dragStartH = startH;
    this.dragEndH = startH;
    this.dragHasMoved = false;
    this.dragStartClient = { x: e.clientX, y: e.clientY };
    if (e.pointerId !== undefined) {
        this.dragPointerId = e.pointerId;
        if (e.target && e.target.setPointerCapture) {
            try { e.target.setPointerCapture(e.pointerId); } catch (_) {}
        }
    }
    e.preventDefault();
    requestAnimationFrame(() => this.updateGhost());
},

getEventAtPoint(clientX, clientY) {
    const elements = document.elementsFromPoint(clientX, clientY);
    const block = elements.find((el) => el && el.closest && el.closest('[data-block-idx]'));
    if (block && block.closest) {
        const container = block.closest('[data-block-idx]');
        if (container && container.dataset && container.dataset.blockIdx !== undefined) {
            const idx = parseInt(container.dataset.blockIdx, 10);
            if (!Number.isNaN(idx)) return idx;
        }
    }
    return null;
},

getReminderAtPoint(clientX, clientY) {
    const elements = document.elementsFromPoint(clientX, clientY);
    const reminder = elements.find((el) => el && el.closest && el.closest('[data-reminder-idx]'));
    if (reminder && reminder.closest) {
        const container = reminder.closest('[data-reminder-idx]');
        if (container && container.dataset && container.dataset.reminderIdx !== undefined) {
            const idx = parseInt(container.dataset.reminderIdx, 10);
            if (!Number.isNaN(idx)) return idx;
        }
    }
    return null;
},

getTransactionsBounds() {
    const col = document.querySelector('.ledger-transactions-col');
    if (!col) return null;
    return col.getBoundingClientRect();
},

updateBlockHover(clientX, clientY) {
    if (this.isDragging) return;
    const bounds = this.getEventsBounds();
    if (!bounds) return;
    if (clientX < bounds.left || clientX > bounds.right || clientY < bounds.top || clientY > bounds.bottom) {
        this.clearBlockHover();
        return;
    }
    const elements = document.elementsFromPoint(clientX, clientY);
    if (elements.some((el) => el && el.closest && el.closest('.reminder-marker'))) {
        this.clearBlockHover();
        return;
    }
    const blockEl = elements.find((el) => el && el.closest && el.closest('[data-block-idx]'));
    const container = blockEl && blockEl.closest ? blockEl.closest('[data-block-idx]') : null;
    if (container === this.hoverBlockEl) return;
    this.clearBlockHover();
    if (container) {
        this.hoverBlockEl = container;
        this.hoverBlockEl.classList.add('block-hover');
        document.body.classList.add('block-hover');
    }
},

clearBlockHover() {
    if (this.hoverBlockEl) {
        this.hoverBlockEl.classList.remove('block-hover');
        this.hoverBlockEl = null;
    }
    document.body.classList.remove('block-hover');
},

startMoveEvent(idx, blockEl) {
    this.clearMoveState();
    const events = this.db[this.selectedDate] || [];
    const ev = events[idx];
    if (!ev || ev.type === 'REMINDER') return;
    this.moveEventIdx = idx;
    this.moveDurationH = Math.max(0.25, (ev.end - ev.start));
    this.moveBlockEl = blockEl || null;
    if (this.moveBlockEl) this.moveBlockEl.classList.add('block-moving');
},

clearMoveState() {
    if (this.moveBlockEl) this.moveBlockEl.classList.remove('block-moving');
    this.moveEventIdx = null;
    this.moveDurationH = null;
    this.moveBlockEl = null;
    this.moveOffsetH = 0;
    this.moveStartH = null;
    this.moveType = null;
},

recordUndo(action) {
    if (!action) return;
    this.undoStack.push(action);
    if (this.undoStack.length > this.undoLimit) this.undoStack.shift();
},

undoLastAction() {
    const action = this.undoStack.pop();
    if (!action) return;
    if (action.type === 'addEvent' && action.event) {
        const events = this.db[action.event.date] || [];
        const idx = events.findIndex((ev) => ev.id === action.event.id);
        if (idx >= 0) {
            events.splice(idx, 1);
            if (events.length === 0) delete this.db[action.event.date];
        }
        if (action.event.id) {
            void this.deleteEventById(action.event.id);
        }
        this.renderDay();
        return;
    }
    if (action.type === 'deleteEvent' && action.event) {
        if (!this.db[action.event.date]) this.db[action.event.date] = [];
        this.db[action.event.date].push(action.event);
        void this.saveEvent(action.event);
        this.renderDay();
        return;
    }
    if (action.type === 'moveEvent') {
        const events = this.db[action.date] || [];
        const ev = events.find((item) => item.id === action.id);
        if (ev) {
            ev.start = action.fromStart;
            ev.end = action.fromEnd;
            void this.saveEvent(ev);
            this.renderDay();
        }
        return;
    }
    if (action.type === 'addTransaction' && action.txId) {
        const idx = this.transactions.findIndex((tx) => tx.id === action.txId);
        if (idx >= 0) {
            const [removed] = this.transactions.splice(idx, 1);
            if (removed && removed.id) {
                void this.deleteTransactionById(removed.id);
            }
        }
        this.renderTransactions();
        this.renderDay();
        return;
    }
    if (action.type === 'deleteTransaction' && action.tx) {
        this.transactions.push(action.tx);
        void this.saveTransaction(action.tx);
        this.sortTransactions();
        this.renderTransactions();
        this.renderDay();
        return;
    }
    if (action.type === 'moveTransaction') {
        const tx = this.transactions.find((item) => item.id === action.id);
        if (tx) {
            tx.time = action.fromTime;
            void this.saveTransaction(tx);
            this.sortTransactions();
            this.renderTransactions();
            this.renderDay();
        }
    }
},

startMoveTransaction(idx, el, e) {
    if (this.moveTxIdx !== null) return;
    const tx = this.transactions[idx];
    if (!tx) return;
    this.moveTxIdx = idx;
    this.moveTxEl = el || null;
    this.moveTxPointerId = e.pointerId !== undefined ? e.pointerId : null;
    this.moveTxTempH = null;
    document.body.classList.add('dragging');
    if (e.pointerId !== undefined && e.target && e.target.setPointerCapture) {
        try { e.target.setPointerCapture(e.pointerId); } catch (_) {}
    }
    e.preventDefault();
},

finishMoveTransaction() {
    const idx = this.moveTxIdx;
    if (idx === null || !this.transactions[idx]) {
        this.moveTxIdx = null;
        this.moveTxEl = null;
        this.moveTxPointerId = null;
        document.body.classList.remove('dragging');
        return;
    }
    const targetH = typeof this.moveTxTempH === 'number' ? this.moveTxTempH : null;
    if (targetH === null) {
        this.moveTxIdx = null;
        this.moveTxEl = null;
        this.moveTxPointerId = null;
        document.body.classList.remove('dragging');
        this.renderDay();
        return;
    }
    const hours = Math.floor(targetH);
    const minutes = Math.round((targetH - hours) * 60);
    const time = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    const prevTime = this.transactions[idx].time;
    this.transactions[idx].time = time;
    this.recordUndo({ type: 'moveTransaction', id: this.transactions[idx].id, fromTime: prevTime });
    void this.saveTransaction(this.transactions[idx]);
    this.sortTransactions();
    this.renderTransactions();
    this.renderDay();
    this.moveTxIdx = null;
    this.moveTxEl = null;
    this.moveTxPointerId = null;
    this.moveTxTempH = null;
    document.body.classList.remove('dragging');
},

applyMoveToTime(clientY) {
    const events = this.db[this.selectedDate] || [];
    const idx = this.moveEventIdx;
    if (idx === null || !events[idx]) {
        this.clearMoveState();
        return;
    }
    const startH = this.getHourAtClientY(clientY);
    if (startH === null) {
        this.clearMoveState();
        return;
    }
    const step = 0.25;
    const duration = this.moveDurationH || 0.25;
    let start = Math.round(startH / step) * step;
    let end = Math.min(24, start + duration);
    if (end - start < 0.25) end = Math.min(24, start + 0.25);
    if (end > 24) {
        end = 24;
        start = Math.max(0, end - duration);
    }
    const overlap = this.moveType === 'reminder'
        ? false
        : events.some((ev, i) => {
            if (i === idx || ev.type === 'REMINDER') return false;
            return start < ev.end && end > ev.start;
        });
    if (overlap) {
        this.clearMoveState();
        return;
    }
    events[idx].start = start;
    events[idx].end = end;
    this.clearMoveState();
    void this.saveEvent(events[idx]);
    this.renderDay();
},

startMoveDrag(idx, blockEl, e, mode = 'block') {
    const events = this.db[this.selectedDate] || [];
    const ev = events[idx];
    if (!ev) return;
    if (mode === 'block' && ev.type === 'REMINDER') return;
    if (mode === 'reminder' && ev.type !== 'REMINDER') return;
    this.clearMoveState();
    this.isMoving = true;
    document.body.classList.add('dragging');
    this.moveEventIdx = idx;
    this.moveDurationH = Math.max(0.25, (ev.end - ev.start));
    this.moveBlockEl = blockEl || null;
    if (this.moveBlockEl) this.moveBlockEl.classList.add('block-moving');
    this.moveType = mode;
    const startH = this.getHourAtClientY(e.clientY);
    this.moveOffsetH = startH !== null ? (startH - ev.start) : 0;
    this.moveStartH = ev.start;
    this.dragPointerId = e.pointerId !== undefined ? e.pointerId : null;
    if (e.pointerId !== undefined && e.target && e.target.setPointerCapture) {
        try { e.target.setPointerCapture(e.pointerId); } catch (_) {}
    }
    e.preventDefault();
},

finishMoveEvent() {
    const events = this.db[this.selectedDate] || [];
    const idx = this.moveEventIdx;
    const duration = this.moveDurationH || 0.25;
    if (idx === null || !events[idx]) {
        this.clearMoveState();
        this.isMoving = false;
        document.body.classList.remove('dragging');
        return;
    }
    const step = 0.25;
    let start = this.moveStartH !== null ? this.moveStartH : events[idx].start;
    start = Math.round(start / step) * step;
    let end = Math.min(24, start + duration);
    if (end - start < 0.25) end = Math.min(24, start + 0.25);
    if (end > 24) {
        end = 24;
        start = Math.max(0, end - duration);
    }
    const overlap = this.moveType === 'reminder'
        ? false
        : events.some((ev, i) => {
            if (i === idx || ev.type === 'REMINDER') return false;
            return start < ev.end && end > ev.start;
        });
    this.isMoving = false;
    document.body.classList.remove('dragging');
    this.clearMoveState();
    if (overlap) {
        const ghost = document.getElementById('ghost-selection');
        if (ghost) ghost.style.display = 'none';
        this.renderDay();
        return;
    }
    const prevStart = events[idx].start;
    const prevEnd = events[idx].end;
    events[idx].start = start;
    events[idx].end = end;
    this.recordUndo({ type: 'moveEvent', id: events[idx].id, date: events[idx].date, fromStart: prevStart, fromEnd: prevEnd });
    void this.saveEvent(events[idx]);
    const ghost = document.getElementById('ghost-selection');
    if (ghost) ghost.style.display = 'none';
    this.renderDay();
},

handlePointerMove(e) {
    this.handleMouseMove(e);
},

handlePointerUp(e) {
    if (this.dragPointerId !== null && e.pointerId !== this.dragPointerId) return;
    this.handleMouseUp();
    this.dragPointerId = null;
},

showBlockMenu(x, y, idx) {
    let menu = document.getElementById('block-context-menu');
    if (!menu) {
        menu = document.createElement('div');
        menu.id = 'block-context-menu';
        menu.style.cssText = 'position: fixed; z-index: 2000; background: rgba(20,20,20,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 6px; min-width: 120px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);';
        document.body.appendChild(menu);
    }
    menu.innerHTML = `
        <button onclick="event.stopPropagation(); event.preventDefault(); ENGINE.hideBlockMenu(); ENGINE.openMeeting(${idx});" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.75); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Edit</button>
        <button onclick="event.stopPropagation(); event.preventDefault(); ENGINE.hideBlockMenu(); ENGINE.deleteEvent(${idx});" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.55); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Delete</button>
    `;
    const menuRect = menu.getBoundingClientRect();
    const left = Math.min(window.innerWidth - menuRect.width - 12, Math.max(12, x));
    const top = Math.min(window.innerHeight - menuRect.height - 12, Math.max(12, y));
    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.display = 'flex';
},

hideBlockMenu() {
    const menu = document.getElementById('block-context-menu');
    if (menu) menu.style.display = 'none';
},

showTransactionMenu(x, y, idx) {
    let menu = document.getElementById('transaction-context-menu');
    if (!menu) {
        menu = document.createElement('div');
        menu.id = 'transaction-context-menu';
        menu.style.cssText = 'position: fixed; z-index: 2000; background: rgba(20,20,20,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 6px; min-width: 120px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);';
        document.body.appendChild(menu);
    }
    menu.innerHTML = `
        <button onclick="event.stopPropagation(); event.preventDefault(); ENGINE.hideTransactionMenu(); ENGINE.openTransactionModalWithData('', ${idx});" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.75); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Edit</button>
        <button onclick="event.stopPropagation(); event.preventDefault(); ENGINE.hideTransactionMenu(); ENGINE.deleteTransaction(${idx});" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.55); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Delete</button>
    `;
    const menuRect = menu.getBoundingClientRect();
    const left = Math.min(window.innerWidth - menuRect.width - 12, Math.max(12, x));
    const top = Math.min(window.innerHeight - menuRect.height - 12, Math.max(12, y));
    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.display = 'flex';
},

hideTransactionMenu() {
    const menu = document.getElementById('transaction-context-menu');
    if (menu) menu.style.display = 'none';
},

showQuickCreateMenu(x, y, startH) {
    this.quickCreateStartH = startH;
    this.hideBlockMenu();
    let menu = document.getElementById('quick-create-menu');
    if (!menu) {
        menu = document.createElement('div');
        menu.id = 'quick-create-menu';
        menu.style.cssText = 'position: fixed; z-index: 2000; background: rgba(20,20,20,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 6px; display: flex; flex-direction: column; gap: 6px; min-width: 140px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);';
        menu.innerHTML = `
            <button onclick="ENGINE.createQuickEvent('REMINDER')" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.85); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Reminder</button>
            <button onclick="ENGINE.createQuickEvent('TASK')" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.85); padding: 8px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer;">Task</button>
        `;
        document.body.appendChild(menu);
    }
    const menuRect = menu.getBoundingClientRect();
    const left = Math.min(window.innerWidth - menuRect.width - 12, Math.max(12, x));
    const top = Math.min(window.innerHeight - menuRect.height - 12, Math.max(12, y));
    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.display = 'flex';
},

hideQuickCreateMenu() {
    const menu = document.getElementById('quick-create-menu');
    if (menu) menu.style.display = 'none';
},

hideAllMenus() {
    this.hideBlockMenu();
    this.hideQuickCreateMenu();
    this.hideTransactionMenu();
},

hideMenusOnOutsideClick(e) {
    const menu = document.getElementById('block-context-menu');
    if (menu && menu.style.display === 'flex' && !e.target.closest('#block-context-menu')) {
        this.hideBlockMenu();
    }
    const quick = document.getElementById('quick-create-menu');
    if (quick && quick.style.display === 'flex' && !e.target.closest('#quick-create-menu')) {
        this.hideQuickCreateMenu();
    }
    const txMenu = document.getElementById('transaction-context-menu');
    if (txMenu && txMenu.style.display === 'flex' && !e.target.closest('#transaction-context-menu')) {
        this.hideTransactionMenu();
    }
},

createQuickEvent(type) {
    this.hideQuickCreateMenu();
    const startH = typeof this.quickCreateStartH === 'number' ? this.quickCreateStartH : 0;
    const step = 0.25;
    const start = Math.round(startH / step) * step;
    const end = type === 'REMINDER' ? start : Math.min(24, start + 0.25);
    if (!this.db[this.selectedDate]) this.db[this.selectedDate] = [];
    const event = {
        id: this.generateEventId(),
        start,
        end,
        label: type === 'REMINDER' ? 'New Reminder' : 'New Task',
        type,
        isNew: true,
        date: this.selectedDate,
        agenda: '',
        stakeholders: '',
        notes: '',
        budget: '',
        allDay: false,
        widgets: {}
    };
    this.db[this.selectedDate].push(event);
    this.recordUndo({ type: 'addEvent', event: { ...event } });
    void this.saveEvent(event);
    this.activeType = type;
    this.renderDay();
    this.openMeeting(this.db[this.selectedDate].length - 1);
},
    
    cycle(prop) {
        const options = {
            scope: ['INDIVIDUAL', 'TEAM', 'INSTITUTION'],
            role: ['ARCHITECT', 'SUPERVISOR'],
            lens: ['PROD', 'FINANCE', 'BOTH']
        };
        let current = this[prop];
        let idx = (options[prop].indexOf(current) + 1) % options[prop].length;
        let next = options[prop][idx];
        
        if(prop === 'scope') this.setLevel(next);
        if(prop === 'role') this.setRole(next);
        if(prop === 'lens') this.setLens(next);
    },

setLevel(level) {
    this.scope = level;
    this.activeBurnRate = this.rates[level]; // THIS LINE IS VITAL
    
    const select = document.getElementById('cfg-level');
    if (select) select.value = level;
    
    this.render();
},

    setRole(role) {
        this.role = role;
        const select = document.getElementById('cfg-role');
        if (select) select.value = role;
        this.render();
    },

    setLens(lens) {
        this.lens = lens;
        const select = document.getElementById('cfg-lens');
        if (select) select.value = lens;
        document.body.className = `mode-${this.role.toLowerCase()} lens-${lens.toLowerCase()}`;
        this.render();
    },

switchTab(view, el) {
    // 1. Clear all active states
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
    
    // 2. Activate current
    el.classList.add('active');
    const target = document.getElementById(view + '-view');
    if (target) target.classList.add('active');

    // 3. Trigger specific renders
    if (view === 'day') this.renderDay();
    if (view === 'week') this.renderWeek();
    if (view === 'month') this.renderMonth();
    if (view === 'year') this.renderYear();
},

renderAuditGraph() {
    const stage = document.getElementById('graph-stage');
    if (!stage) return;
    
    const total = 25000;
    const percent = Math.max(0, (this.currentNet / total) * 100);
    
    // Clear and redraw with z-index protection
    stage.style.position = "relative";
    stage.innerHTML = `
        <div style="position:absolute; bottom:0; left:0; width:100%; height:4px; background:rgba(255,255,255,0.05);">
        </div>
        
        <div style="position:absolute; bottom:0; left:0; width:${percent}%; height:4px; background: var(--btn-accent-bg-strong); box-shadow: 0 0 12px rgba(0,255,135,0.35); transition: width 0.5s ease; z-index: 2;">
        </div>

    `;
},
    
    render() {
        this.renderDay();
        this.renderMonth();
        this.renderYear();
    },

    toggleTypeMenu() {
      const menu = document.getElementById('type-selector-expanded');
      if (!menu) return;
      
      const isHidden = menu.style.display === 'none' || menu.style.display === '';
      
      if (isHidden) {
          menu.style.display = 'flex';
          menu.animate([
              { opacity: 0, transform: 'translateY(-10px)' },
              { opacity: 1, transform: 'translateY(0)' }
          ], { duration: 200, easing: 'cubic-bezier(0.2, 0, 0, 1)' });
      } else {
          menu.style.display = 'none';
      }
    },

    setType(type) {
        this.activeType = type;
        const avatar = document.getElementById('avatar-main-initial');
        const trigger = document.getElementById('type-avatar-trigger');
        const colors = { MEETING: '#007AFF', REMINDER: '#32D74B', TASK: '#FF3B30', EVENT: '#FF9500' };
        const typeDisplay = document.getElementById('active-type-text');
        if (typeDisplay) typeDisplay.innerText = type;
        
        if (avatar) avatar.innerText = type.charAt(0);
        if (trigger) {
            trigger.style.color = colors[type];
            trigger.style.borderColor = colors[type];
        }

        document.getElementById('type-selector-expanded').style.display = 'none';
        this.updatePanelContext();
    },

    // Helper to add new agenda items dynamically
    addAgendaPoint() {
        const list = document.getElementById('agenda-items-list');
        const count = list.children.length + 1;
        const div = document.createElement('div');
        div.style.cssText = "display:flex; align-items:center; gap:12px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03);";
        div.innerHTML = `
            <span style="font-family:'SF Mono'; font-size:10px; color:#007AFF; opacity:0.4;">0${count}</span>
            <input type="text" placeholder="Set objective..." style="flex:1; background:transparent; border:none; color:white; font-size:13px; outline:none; opacity:0.8;">
            <div style="width:12px; height:12px; border: 1px solid rgba(255,255,255,0.1); border-radius:3px;"></div>
        `;
        list.appendChild(div);
    },

    // Financial Actions
    addExpense() { this.openTransactionModal(-1); },
    addIncome() { this.openTransactionModal(1); },
    audit() { alert("Strategic Audit Log: 24h cycle verified."); },
    openAudit() {
        const overlay = document.getElementById('audit-overlay');
        if (!overlay) return;
        this.renderAudit();
        overlay.style.display = 'flex';
    },

    closeAudit() {
        const overlay = document.getElementById('audit-overlay');
        if (overlay) overlay.style.display = 'none';
    },

    renderAudit() {
        const list = document.getElementById('audit-transaction-list');
        if (!list) return;
        if (!this.transactions.length) {
            list.innerHTML = '<div style="color: rgba(255,255,255,0.4); font-size: 12px;">No transactions yet.</div>';
            return;
        }
    list.innerHTML = this.transactions.map(tx => {
        const categoryLabel = (tx.category || tx.subcategory)
            ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
            : '';
        return `
        <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 10px 12px; border-radius: 8px;">
            <div>
                <div style="font-size: 12px; color: white; font-weight: 600;">${this.escapeHTML(tx.item || tx.desc)}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.4); font-family: 'SF Mono';">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
            </div>
            <div style="font-family:'SF Mono'; font-size: 12px; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                ${tx.amount >= 0 ? '+' : ''}${this.formatAmount(tx.amount)}
            </div>
        </div>
    `;
    }).join('');
    },
    
closeModal() {
    this.isMeetingActive = false;
    this.currentEventIdx = null;
    this.expandedWidget = null;
    this.closeEditMeetingSettings();
    const modal = document.getElementById('modal-overlay');
    if (modal) modal.style.display = 'none';

    // Reset sidebar button
    const btn = document.querySelector('.btn-focus');
    if (btn) {
        btn.innerText = "START";
        btn.style.background = "white";
        btn.style.color = "black";
    }
},

expandWidget(id) {
    if (!['notes', 'stakeholders', 'agenda', 'timeblockExpenses'].includes(id)) return;
    this.expandedWidget = id;
    this.applyExpandedWidget();
},

collapseWidget() {
    this.expandedWidget = null;
    this.applyExpandedWidget();
},

openMeetingUrl() {
    const el = document.getElementById('modal-location');
    if (!el) return;
    let u = (el.value || '').trim();
    if (!u) return;
    if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
    window.open(u, '_blank');
},

applyExpandedWidget() {
    const backBar = document.getElementById('widget-back-bar');
    const notes = document.getElementById('widget-notes');
    const urlRow = document.getElementById('widget-url-row');
    const url = document.getElementById('widget-url');
    const stakeholders = document.getElementById('widget-stakeholders');
    const agenda = document.getElementById('widget-agenda');
    const timeblockExpenses = document.getElementById('widget-timeblockExpenses');
    const show = (el, display = '') => { if (el) el.style.display = display || ''; };
    const hide = (el) => { if (el) el.style.display = 'none'; };

    if (!this.expandedWidget) {
        show(backBar, 'none');
        show(notes); show(urlRow, 'grid'); show(url); show(stakeholders); show(agenda); show(timeblockExpenses);
        return;
    }
    show(backBar, 'flex');
    const exp = this.expandedWidget;
    if (exp === 'notes') {
        show(notes); hide(urlRow); hide(agenda); hide(timeblockExpenses);
    } else if (exp === 'stakeholders') {
        hide(notes); show(urlRow, 'grid'); hide(url); show(stakeholders); hide(agenda); hide(timeblockExpenses);
    } else if (exp === 'agenda') {
        hide(notes); hide(urlRow); show(agenda); hide(timeblockExpenses);
    } else if (exp === 'timeblockExpenses') {
        hide(notes); hide(urlRow); hide(agenda); show(timeblockExpenses);
    }
},

injectStyles() {
    if (document.getElementById('engine-core-styles')) return;
    const style = document.createElement('style');
    style.id = 'engine-core-styles';
    style.innerHTML = `
        @keyframes breathe { ... }
        .breathing-roi { ... }
        #agenda-items-list::-webkit-scrollbar { ... }
        .widget-header-row:hover .widget-header-symbol { color: rgba(255,255,255,0.95); opacity: 1; }
    `;
    document.head.appendChild(style);
},

updatePanelContext() {
    const container = document.getElementById('dynamic-fields-container');
    const fixedContainer = document.getElementById('fixed-fields-container');
    const modalTitle = document.getElementById('modal-main-title');
    const activeColor = { MEETING: '#007AFF', REMINDER: '#32D74B', TASK: '#FF3B30', EVENT: '#FF9500' }[this.activeType];
    
    // --- 0. INTERACTION LAYER FIX ---
    // Ensure the modal layer doesn't intercept drag events meant for the ledger
    container.style.pointerEvents = "none"; 
    container.style.zIndex = "100"; // High visual priority
    
    const now = new Date();
    const todayISO = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    const events = this.db[this.selectedDate] || [];
    const activeEvent = this.currentEventIdx !== null ? events[this.currentEventIdx] : null;
    const eventDate = activeEvent?.date || this.selectedDate || todayISO;
    const eventStart = activeEvent ? this.decimalToTime(activeEvent.start) : currentTime;
    const eventEnd = activeEvent ? this.decimalToTime(activeEvent.end) : this.decimalToTime(Math.min(24, (now.getHours() + 1)));
    const agendaItems = activeEvent?.agenda ? activeEvent.agenda.split('|').filter(Boolean) : [];
    const stakeholderItems = activeEvent?.stakeholders ? activeEvent.stakeholders.split('|').filter(Boolean) : [];
    const noteItems = activeEvent?.notes ? activeEvent.notes.split('|').filter(Boolean) : [];
    const noteDisplayItems = noteItems.length ? [...noteItems].reverse() : [];
    const eventBudget = activeEvent?.budget || '';
    const widgetTitleColor = 'rgba(122,162,255,0.85)';
    const headerLabel = this.activeType === 'REMINDER'
        ? 'Reminder'
        : (this.activeType === 'TASK' ? 'Task' : 'Timeblock');
    const titlePlaceholder = this.activeType === 'REMINDER'
        ? 'Add a reminder title'
        : (this.activeType === 'TASK' ? 'Add a task title' : 'Add a clear session title');

    modalTitle.innerText = `${activeEvent ? 'EDIT' : 'NEW'} ${this.activeType}`;

    if (ENGINE.activeTypeContext.isRemote === undefined) ENGINE.activeTypeContext.isRemote = true;
    const isRemote = ENGINE.activeTypeContext.isRemote;

    let headerHtml = '';
    let html = '';
    
    // --- 1. HEADER (Strategic Objective) ---
    headerHtml += `
        <div style="grid-column: span 2; pointer-events: all; display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 12px; padding: 0 4px;">
            <div style="flex: 1;">
                <label style="color: ${activeColor}; font-weight: 800; font-size: 10px; letter-spacing: 2px; text-transform:uppercase;">${headerLabel}</label>
                <input id="strategic-objective-input" type="text" value="${activeEvent?.label || `New ${headerLabel}`}" placeholder="${titlePlaceholder}" 
                       style="background:transparent; border:none; color:white; font-size:30px; font-weight:700; width:100%; outline:none; letter-spacing: -1px;">
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                <div style="display: flex; gap: 8px; align-items:center;">
                    <input id="timeblock-date" type="date" value="${this.formatDate(eventDate)}" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'SF Mono'; font-size: 12px; padding: 7px 10px; border-radius: 8px; width: 140px;">
                    ${this.activeType === 'REMINDER' ? `<label style="display:flex; align-items:center; gap:6px; font-size:10px; color: rgba(255,255,255,0.6);">
                        <input id="timeblock-all-day" type="checkbox" ${activeEvent?.allDay ? 'checked' : ''} />
                        All day
                    </label>` : ''}
                    <input id="timeblock-start" type="text" value="${eventStart}" placeholder="HH:MM" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'SF Mono'; font-size: 12px; padding: 7px 10px; border-radius: 8px; width: 90px; ${this.activeType === 'REMINDER' && activeEvent?.allDay ? 'display:none;' : ''}">
                    <input id="timeblock-end" type="text" value="${eventEnd}" placeholder="HH:MM" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'SF Mono'; font-size: 12px; padding: 7px 10px; border-radius: 8px; width: 90px; ${this.activeType === 'REMINDER' && activeEvent?.allDay ? 'display:none;' : ''}">
                </div>
                <div id="timeblock-duration" style="font-family:'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.5); ${this.activeType === 'REMINDER' ? 'display:none;' : ''}">
                    ${this.getDurationLabel(eventStart, eventEnd)}
                </div>
            </div>
        </div>
    `;

    const showTimeblockDetails = this.activeType !== 'REMINDER';
    const showStakeholders = showTimeblockDetails && this.getWidgetVisible('stakeholders', activeEvent);
    const showAgenda = showTimeblockDetails && this.getWidgetVisible('agenda', activeEvent);
    const showTimeblockExpenses = showTimeblockDetails && this.getWidgetVisible('timeblockExpenses', activeEvent);
    html += `
        <div id="widget-back-bar" style="display:none; grid-column: span 2; pointer-events: all; margin-bottom: 8px;">
            <button type="button" onclick="ENGINE.collapseWidget()" style="display:flex; align-items:center; gap:6px; background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 600; cursor: pointer; padding: 6px 0;">
                <span style="font-size:14px;">←</span> Back to session
            </button>
        </div>
        <div id="widget-notes" style="grid-column: span 2; pointer-events: all; margin-bottom: ${showTimeblockDetails ? '6px' : '0'};">
            <div class="panel-section" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column;">
                <div class="widget-header-row" role="button" tabindex="0" title="See more (focus this widget)" onclick="ENGINE.expandWidget('notes')" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; cursor: pointer;">
                    <label style="color: ${widgetTitleColor}; font-size: 9px; font-weight: 800; text-transform:uppercase; opacity: 0.85;">${this.activeType === 'REMINDER' ? 'Reminder Notes' : 'Quick Notes'}</label>
                    <span class="widget-header-symbol" style="color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 700; line-height: 1; transition: color 0.15s, opacity 0.15s;">⤢</span>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <input id="timeblock-notes-input" placeholder="Capture a quick note or decision..." style="flex:1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 8px 12px; color: white; font-size: 12px; outline:none;">
                    <button onclick="ENGINE.saveSession()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); font-size:10px; font-weight:800; padding:0 12px; border-radius:8px; cursor:pointer;">ADD</button>
                </div>
                <div id="timeblock-notes-history" style="display:flex; flex-direction:column; gap:4px; max-height: 48px; overflow-y:auto;">
                    ${noteDisplayItems.length ? noteDisplayItems.map(note => `
                        <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 9px 12px; color: rgba(255,255,255,0.85); font-size: 12px;">
                            ${note}
                        </div>
                    `).join('') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No notes yet.</div>'}
                </div>
            </div>
        </div>
    `;

    // --- 3. MEETING URL / LOCATION (full width when Stakeholders off) + STAKEHOLDERS ---
    if (showTimeblockDetails) {
        html += `
        <div id="widget-url-row" style="grid-column: span 2; pointer-events: all; display: grid; grid-template-columns: ${showStakeholders ? '1.2fr 0.8fr' : '1fr'}; gap: 10px; margin-bottom: ${showAgenda || showTimeblockExpenses ? '4px' : '0'}; margin-top: 0; align-items: start;">
            <div id="widget-url" style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.03); padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); min-height: 72px; min-width: 0; ${!showStakeholders ? 'grid-column: 1 / -1;' : ''}">
                <div style="display: flex; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 8px; flex-shrink: 0;">
                    <button type="button" onclick="ENGINE.activeTypeContext.isRemote = !ENGINE.activeTypeContext.isRemote; ENGINE.updatePanelContext();" 
                            style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); cursor: pointer; padding: 6px 10px; border-radius: 6px; font-size: 14px; color: rgba(255,255,255,0.7); transition: all 0.15s;">
                        ${isRemote ? '🌐' : '📍'}
                    </button>
                </div>
                <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px;">
                    <label style="color: ${widgetTitleColor}; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8;">${isRemote ? 'Meeting URL' : 'Location'}</label>
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <input type="text" id="modal-location" value="${isRemote ? 'deepworkszt.vercel.app' : 'Conference Room A'}" 
                               style="flex: 1; min-width: 0; background: transparent; border: none; color: ${isRemote ? 'rgba(88, 166, 255, 0.95)' : 'rgba(255,255,255,0.9)'}; font-size: 13px; outline: none; font-family: 'SF Mono', monospace; box-sizing: border-box; ${isRemote ? 'text-decoration: underline; text-underline-offset: 2px;' : ''}">
                        ${isRemote ? `<a href="#" id="modal-location-open" onclick="ENGINE.openMeetingUrl(); return false;" style="font-size: 11px; font-weight: 600; color: rgba(88, 166, 255, 0.9); text-decoration: none; white-space: nowrap; flex-shrink: 0;">Open ↗</a>` : ''}
                    </div>
                </div>
            </div>
            ${showStakeholders ? `
            <div id="widget-stakeholders" class="panel-section panel-section--expandable" style="pointer-events: all; background: rgba(255,255,255,0.02); border-radius: 16px; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.03); height: 84px; display:flex; flex-direction:column; overflow:hidden;">
                <div class="widget-header-row" role="button" tabindex="0" title="See more (focus this widget)" onclick="ENGINE.expandWidget('stakeholders')" style="display:flex; align-items:center; justify-content:space-between; font-size: 11px; font-weight: 800; letter-spacing: 1px; color:${widgetTitleColor}; opacity:0.85; flex:0 0 auto; cursor: pointer;">
                    <span style="display:flex; align-items:center; gap:8px;">
                        Stakeholders
                        <span style="font-size:9px; color: rgba(255,255,255,0.4); font-weight:700;">Optional</span>
                    </span>
                    <span class="widget-header-symbol" style="color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 700; line-height: 1; transition: color 0.15s, opacity 0.15s;">⤢</span>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top: 2px;">
                    <span onclick="ENGINE.addStakeholder()" style="color: rgba(0,255,135,0.7); font-size:9px; font-weight:800; cursor:pointer;">+ INVITE</span>
                </div>
                <div id="stakeholder-list" class="internal-scroll" style="overflow-y: auto; display:flex; flex-direction:column; gap:4px; margin-top: 2px; flex:1 1 auto; min-height: 0; height: 42px;">
                    ${(stakeholderItems.length ? stakeholderItems : ['']).map(name => `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="color:${activeColor};">●</span>
                            <input type="text" value="${name}" placeholder="Name or org..." style="flex:1; background:transparent; border:none; color:white; font-size:12px; outline:none;">
                        </div>
                    `).join('')}
                </div>
            </div>` : ''}
        </div>
    `;
    }

    // --- 4. SESSION AGENDA (widget, top-aligned) ---
    if (showAgenda) {
        html += `
            <div id="widget-agenda" class="panel-section panel-section--expandable" style="grid-column: span 2; pointer-events: all; background: rgba(255,255,255,0.02); border-radius: 20px; padding: 8px 14px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: ${showTimeblockExpenses ? '4px' : '0'};">
                <div class="widget-header-row" role="button" tabindex="0" title="See more (focus this widget)" onclick="ENGINE.expandWidget('agenda')" style="display:flex; align-items:center; justify-content:space-between; font-size: 11px; font-weight: 800; letter-spacing: 1px; color:${widgetTitleColor}; opacity:0.85; cursor: pointer;">
                    <span style="display:flex; align-items:center; gap:8px;">
                        Session Agenda
                        <span style="font-size:9px; color: rgba(255,255,255,0.4); font-weight:700;">Optional</span>
                    </span>
                    <span class="widget-header-symbol" style="color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 700; line-height: 1; transition: color 0.15s, opacity 0.15s;">⤢</span>
                </div>
                <div style="display:flex; justify-content:flex-end; margin: 4px 0 2px;">
                    <button onclick="ENGINE.addAgendaPoint()" style="background:transparent; border:none; color: rgba(0,255,135,0.7); font-size:9px; font-weight:800; cursor:pointer;">+ ADD POINT</button>
                </div>
                <div id="agenda-items-list" class="internal-scroll" style="display: flex; flex-direction: column; height: 46px; overflow-y: auto;">
                    ${(agendaItems.length ? agendaItems : ['']).map((item, i) => `
                        <div style="display:flex; align-items:center; gap:10px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03);">
                            <span style="font-family:'SF Mono'; font-size:10px; color:${activeColor}; opacity:0.4;">0${i + 1}</span>
                            <input type="text" value="${item}" placeholder="Decision, objective, or question..." style="flex:1; background:transparent; border:none; color:white; font-size:13px; outline:none; opacity:0.85;">
                            <div style="width:12px; height:12px; border: 1px solid rgba(255,255,255,0.1); border-radius:3px;"></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    if (showTimeblockExpenses) {
        // --- 6. TIMEBLOCK EXPENSES (widget, top-aligned) ---
        const expenseItems = activeEvent ? this.getEventExpenses(activeEvent.id) : [];
        const expenseDisplayItems = [...expenseItems].reverse();
        html += `
            <div id="widget-timeblockExpenses" class="panel-section panel-section--expandable" style="grid-column: span 2; pointer-events: all; background: rgba(255,255,255,0.015); border-radius: 20px; padding: 8px 14px; border: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 4px; margin-bottom: 0;">
                <div class="widget-header-row" role="button" tabindex="0" title="See more (focus this widget)" onclick="ENGINE.expandWidget('timeblockExpenses')" style="display:flex; align-items:center; justify-content:space-between; font-size: 11px; font-weight: 800; letter-spacing: 1px; color:${widgetTitleColor}; opacity:0.85; cursor: pointer;">
                    <span style="display:flex; align-items:center; gap:8px;">
                        Timeblock Expenses
                        <span style="font-size:9px; color: rgba(255,255,255,0.4); font-weight:700;">Optional</span>
                    </span>
                    <span class="widget-header-symbol" style="color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 700; line-height: 1; transition: color 0.15s, opacity 0.15s;">⤢</span>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 0.6fr; gap: 8px; margin-top: 2px; align-items: start;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span style="font-family:'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.45);">Transaction</span>
                            <span id="timeblock-expense-type" style="color: rgba(255,255,255,0.7); font-size: 11px; font-family:'SF Mono';">Expense</span>
                        </div>
                        <div id="timeblock-expense-sign" data-sign="-1" style="display:flex; gap:6px; align-items:center;">
                            <button onclick="ENGINE.setTimeblockExpenseSign(-1)" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: rgba(255,255,255,0.8); font-size:12px; font-weight:800; width: 48px; height: 28px; border-radius:6px; cursor:pointer;">−</button>
                            <button onclick="ENGINE.setTimeblockExpenseSign(1)" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); font-size:12px; font-weight:800; width: 48px; height: 28px; border-radius:6px; cursor:pointer;">+</button>
                        </div>
                    </div>
                    <div></div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div style="font-family:'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.45);">Budget</div>
                        <input id="timeblock-budget" type="text" value="${this.escapeAttribute(eventBudget)}" placeholder="0.00" style="width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:6px 8px; border-radius: 8px; font-size: 11px; outline:none;">
                        <div id="timeblock-budget-diff" style="font-family:'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px;">
                            remaining: <span id="timeblock-budget-diff-value">0.00</span>
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 0.6fr; gap: 8px; margin-top: 4px;">
                    <input id="timeblock-expense-item" placeholder="Item" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                    <input id="timeblock-expense-desc" placeholder="Description" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                    <input id="timeblock-expense-amount" placeholder="0.00" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin-top: 4px; align-items:center;">
                    <select id="timeblock-expense-category" class="subtle-select"></select>
                    <select id="timeblock-expense-subcategory" class="subtle-select"></select>
                    <button onclick="ENGINE.addTimeblockExpense()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); font-size:10px; font-weight:800; padding:0 12px; border-radius:8px; cursor:pointer; height: 34px;">ADD</button>
                </div>
                <div id="timeblock-expense-list" class="internal-scroll" style="display:flex; flex-direction:column; gap: 6px; height: 56px; overflow-y: auto; margin-top: 4px;">
                    ${expenseDisplayItems.length ? expenseDisplayItems.map(tx => {
                        const categoryLabel = (tx.category || tx.subcategory)
                            ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
                            : '';
                        return `
                        <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 8px 10px; border-radius: 8px;">
                            <div>
                                <div style="font-size: 11px; color:white; font-weight:600;">${this.escapeHTML(tx.item || tx.desc)}</div>
                                <div style="font-family:'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.4);">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
                            </div>
                            <div style="font-family:'SF Mono'; font-size: 11px; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                                ${tx.amount >= 0 ? '+' : '-'}${this.formatAmount(Math.abs(tx.amount))}
                            </div>
                        </div>
                    `;
                    }).join('') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No expenses.</div>'}
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between; margin-top: 4px;">
                    <span style="font-size:9px; color: rgba(255,255,255,0.45); font-weight:700; letter-spacing:1px;">SESSION TRANSACTIONS</span>
                    <span style="font-size:9px; color: rgba(255,255,255,0.35); font-weight:700;">All</span>
                </div>
                <div id="timeblock-transaction-ledger" class="internal-scroll" style="display:flex; flex-direction:column; gap: 4px; height: 48px; overflow-y: auto;">
                    ${expenseDisplayItems.length ? expenseDisplayItems.map(tx => {
                        const categoryLabel = (tx.category || tx.subcategory)
                            ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
                            : '';
                        return `
                        <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 6px 8px; border-radius: 8px;">
                            <div>
                                <div style="font-size: 10px; color:white; font-weight:600;">${this.escapeHTML(tx.item || tx.desc)}</div>
                                <div style="font-family:'SF Mono'; font-size: 8px; color: rgba(255,255,255,0.4);">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
                            </div>
                            <div style="font-family:'SF Mono'; font-size: 10px; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                                ${tx.amount >= 0 ? '+' : '-'}${this.formatAmount(Math.abs(tx.amount))}
                            </div>
                        </div>
                    `;
                    }).join('') : '<div style="color: rgba(255,255,255,0.4); font-size: 10px;">No transactions yet.</div>'}
                </div>
            </div>
        `;
    }
    
    if (fixedContainer) fixedContainer.innerHTML = headerHtml;
    container.innerHTML = html;
    this.applyExpandedWidget();
    const dateInput = document.getElementById('timeblock-date');
    const startInput = document.getElementById('timeblock-start');
    const endInput = document.getElementById('timeblock-end');
    const allDayInput = document.getElementById('timeblock-all-day');
    const durationLabel = document.getElementById('timeblock-duration');
    const expenseItemInput = document.getElementById('timeblock-expense-item');
    const expenseAmountInput = document.getElementById('timeblock-expense-amount');
    const expenseCategorySelect = document.getElementById('timeblock-expense-category');
    const expenseSubcategorySelect = document.getElementById('timeblock-expense-subcategory');
    if (expenseAmountInput && !expenseAmountInput.value) expenseAmountInput.value = this.formatAmount(0);
    if (expenseCategorySelect && expenseSubcategorySelect) {
        const defaultCategory = this.categories.find(item => item.name === 'Timeblock') ? 'Timeblock' : '';
        this.initCategoryDropdowns(expenseCategorySelect, expenseSubcategorySelect, defaultCategory, '');
    }
    if (allDayInput && allDayInput.checked) {
        if (startInput) startInput.style.display = 'none';
        if (endInput) endInput.style.display = 'none';
        if (durationLabel) durationLabel.style.display = 'none';
    }
    const updateDuration = () => {
        if (durationLabel && startInput && endInput) {
            durationLabel.textContent = this.getDurationLabel(startInput.value, endInput.value);
        }
    };
    if (container && container.dataset.scrollBound !== 'true') {
        container.dataset.scrollBound = 'true';
        container.addEventListener('wheel', (e) => {
            if (!(e.target instanceof HTMLElement)) return;
            const inner = e.target.closest('.internal-scroll');
            if (inner) {
                const atTop = inner.scrollTop <= 0;
                const atBottom = inner.scrollTop + inner.clientHeight >= inner.scrollHeight - 1;
                if ((e.deltaY < 0 && !atTop) || (e.deltaY > 0 && !atBottom)) {
                    return;
                }
            }
            e.preventDefault();
        }, { passive: false });
    }
    const applyTimeChanges = () => {
        if (!activeEvent) return;
        const targetDate = this.formatDate(dateInput ? dateInput.value : this.selectedDate);
        const isAllDay = allDayInput ? allDayInput.checked : false;
        const startTime = startInput && !isAllDay ? startInput.value : '00:00';
        const endTime = endInput && !isAllDay ? endInput.value : '00:00';
        const startDec = this.timeToDecimal(startTime);
        const endDec = this.timeToDecimal(endTime);

        if (this.activeType === 'REMINDER') {
            activeEvent.start = isAllDay ? 0 : startDec;
            activeEvent.end = isAllDay ? 0 : startDec;
        } else {
            activeEvent.start = startDec;
            activeEvent.end = endDec;
        }
        activeEvent.allDay = isAllDay;

        const fromDate = activeEvent.date || this.selectedDate;
        if (targetDate && targetDate !== fromDate) {
            const fromList = this.db[fromDate] || [];
            const fromIdx = fromList.indexOf(activeEvent);
            if (fromIdx > -1) fromList.splice(fromIdx, 1);
            if (!this.db[targetDate]) this.db[targetDate] = [];
            this.db[targetDate].push(activeEvent);
            activeEvent.date = targetDate;
            this.selectedDate = targetDate;
            this.currentEventIdx = this.db[targetDate].indexOf(activeEvent);
            this.updateDateDisplay();
        }

        this.renderDay();
    };
    if (startInput) startInput.addEventListener('input', updateDuration);
    if (endInput) endInput.addEventListener('input', updateDuration);
    if (dateInput) {
        dateInput.addEventListener('change', () => {
            dateInput.value = this.formatDate(dateInput.value);
            applyTimeChanges();
        });
        dateInput.addEventListener('blur', () => {
            dateInput.value = this.formatDate(dateInput.value);
            applyTimeChanges();
        });
    }
    if (startInput) {
        startInput.addEventListener('change', applyTimeChanges);
        startInput.addEventListener('blur', applyTimeChanges);
    }
    if (endInput) {
        endInput.addEventListener('change', applyTimeChanges);
        endInput.addEventListener('blur', applyTimeChanges);
    }
    if (allDayInput) {
        allDayInput.addEventListener('change', () => {
            if (startInput) startInput.style.display = allDayInput.checked ? 'none' : '';
            if (endInput) endInput.style.display = allDayInput.checked ? 'none' : '';
            if (durationLabel) durationLabel.style.display = allDayInput.checked ? 'none' : 'block';
            applyTimeChanges();
        });
    }
    const modalInputs = container ? container.querySelectorAll('input, textarea') : [];
    modalInputs.forEach((input) => {
        input.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            if (input.id === 'timeblock-expense-item' || input.id === 'timeblock-expense-desc' || input.id === 'timeblock-expense-amount') {
                e.preventDefault();
                this.addTimeblockExpense();
                return;
            }
            if (input.id === 'timeblock-notes-input') {
                e.preventDefault();
                this.saveSession();
                return;
            }
            e.preventDefault();
            this.saveSession();
        });
    });
    const budgetInput = document.getElementById('timeblock-budget');
    if (budgetInput) {
        const syncBudgetAndRemaining = () => {
            const events = this.db[this.selectedDate] || [];
            const event = this.currentEventIdx !== null ? events[this.currentEventIdx] : null;
            if (event) event.budget = budgetInput.value.trim();
            this.renderPanelExpenses();
        };
        budgetInput.addEventListener('input', syncBudgetAndRemaining);
        budgetInput.addEventListener('blur', syncBudgetAndRemaining);
    }
},

    
// --- Restored Helper Methods ---

setLocMode(mode) {
    const input = document.getElementById('modal-location');
    if (!input) return;
    ENGINE.activeTypeContext.isRemote = (mode === 'web');
    this.updatePanelContext();
},

addStakeholder() {
    const list = document.getElementById('stakeholder-list');
    if (!list) return;
    const div = document.createElement('div');
    div.style.cssText = "display:flex; align-items:center; gap:8px;";
    div.innerHTML = `<span style="color:${this.activeType === 'MEETING' ? '#007AFF' : '#FF9500'};">●</span><input type="text" placeholder="Stakeholder..." style="flex:1; background:transparent; border:none; color:white; font-size:11px; outline:none;">`;
    list.appendChild(div);
},

saveSession() {
    const titleInput = document.getElementById('strategic-objective-input');
    const title = titleInput ? titleInput.value : "New Infrastructure Session";
    const dateInput = document.getElementById('timeblock-date');
    const startInput = document.getElementById('timeblock-start');
    const endInput = document.getElementById('timeblock-end');
    const allDayInput = document.getElementById('timeblock-all-day');
    const notesInput = document.getElementById('timeblock-notes-input');
    const budgetInput = document.getElementById('timeblock-budget');
    const agendaInputs = document.querySelectorAll('#agenda-items-list input');
    const stakeholderInputs = document.querySelectorAll('#stakeholder-list input');

    const targetDate = this.formatDate(dateInput ? dateInput.value : this.selectedDate);
    const isAllDay = allDayInput ? allDayInput.checked : false;
    const startTime = startInput && !isAllDay ? startInput.value : '00:00';
    const endTime = endInput && !isAllDay ? endInput.value : '00:00';
    const startDec = this.timeToDecimal(startTime);
    const endDec = this.timeToDecimal(endTime);

    const agenda = Array.from(agendaInputs).map(input => input.value.trim()).filter(Boolean).join('|');
    const stakeholders = Array.from(stakeholderInputs).map(input => input.value.trim()).filter(Boolean).join('|');

    if (!this.db[this.selectedDate]) this.db[this.selectedDate] = [];
    const sessions = this.db[this.selectedDate];
    const targetIdx = this.currentEventIdx !== null ? this.currentEventIdx : (sessions.length - 1);
    const event = sessions[targetIdx];
    if (!event) return;

    event.label = title;
    event.type = this.activeType;
    if (this.activeType === 'REMINDER') {
        event.start = isAllDay ? 0 : startDec;
        event.end = isAllDay ? 0 : startDec;
        event.agenda = '';
        event.stakeholders = '';
    } else {
        event.start = startDec;
        event.end = endDec;
        event.agenda = this.getWidgetVisible('agenda', event) ? agenda : (event.agenda || '');
        event.stakeholders = this.getWidgetVisible('stakeholders', event) ? stakeholders : (event.stakeholders || '');
    }
    const existingNotes = event.notes ? event.notes.split('|').filter(Boolean) : [];
    const newNote = notesInput ? notesInput.value.trim() : '';
    if (newNote) existingNotes.push(newNote);
    event.notes = existingNotes.join('|');
    event.budget = this.activeType === 'REMINDER' ? '' : (this.getWidgetVisible('timeblockExpenses', event) && budgetInput ? budgetInput.value.trim() : (event.budget || ''));
    event.allDay = isAllDay;

    if (targetDate !== this.selectedDate) {
        sessions.splice(targetIdx, 1);
        if (!this.db[targetDate]) this.db[targetDate] = [];
        this.db[targetDate].push(event);
        event.date = targetDate;
        this.selectedDate = targetDate;
        this.updateDateDisplay();
    }

    void this.saveEvent(event);
    document.getElementById('modal-overlay').style.display = 'none';
    this.renderDay();
},

async ensureUserStorage() {
    if (this.userSheetId) return;
    if (!this.userEmail) {
        throw new Error('Missing user email for storage provisioning.');
    }

    const emailKey = this.userEmail.trim().toLowerCase();
    const storageKey = `ENGINE_USER_FILE_ID_${emailKey}`;
    const cachedId = localStorage.getItem(storageKey);

    if (cachedId) {
        try {
            await gapi.client.sheets.spreadsheets.get({ spreadsheetId: cachedId });
            this.userSheetId = cachedId;
        } catch (err) {
            this.userSheetId = null;
        }
    }

    if (!this.userSheetId) {
        const fileName = `${ENGINE_USER_FILE_NAME} - ${emailKey}`;
        const listRes = await gapi.client.drive.files.list({
            q: `name = '${fileName}' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false`,
            fields: 'files(id, name)',
            spaces: 'drive'
        });
        const existing = listRes.result.files && listRes.result.files[0];
        if (existing) {
            this.userSheetId = existing.id;
        } else {
            try {
                const copyRes = await gapi.client.drive.files.copy({
                    fileId: USER_TEMPLATE_SHEET_ID,
                    resource: { name: fileName, parents: ['root'] },
                    fields: 'id'
                });
                this.userSheetId = copyRes.result.id;
            } catch (err) {
                const createRes = await gapi.client.drive.files.create({
                    resource: { name: fileName, mimeType: 'application/vnd.google-apps.spreadsheet', parents: ['root'] },
                    fields: 'id'
                });
                this.userSheetId = createRes.result.id;
            }
        }
    }

    if (this.userSheetId) {
        localStorage.setItem(storageKey, this.userSheetId);
    }

    await this.ensureSheetStructure();
},

async ensureSheetStructure() {
    if (!this.userSheetId) return;
    const sheetRes = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: this.userSheetId
    });
    const sheets = sheetRes.result.sheets || [];
    const existingNames = new Set(sheets.map(s => s.properties.title));
    const requests = [];

    Object.values(this.sheetNames).forEach((title) => {
        if (!existingNames.has(title)) {
            requests.push({ addSheet: { properties: { title } } });
        }
    });

    if (requests.length) {
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: this.userSheetId,
            resource: { requests }
        });
    }

    const refreshed = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: this.userSheetId
    });
    const sheetInfo = {};
    (refreshed.result.sheets || []).forEach((sheet) => {
        sheetInfo[sheet.properties.title] = sheet.properties.sheetId;
    });
    this.sheetInfo = sheetInfo;

    await Promise.all([
        this.writeHeaders(this.sheetNames.events, ['id', 'date', 'start', 'end', 'label', 'type', 'agenda', 'stakeholders', 'notes', 'budget', 'allDay', 'widgets']),
        this.writeHeaders(this.sheetNames.transactions, ['id', 'date', 'time', 'item', 'description', 'amount', 'category', 'subcategory', 'eventId']),
        this.writeHeaders(this.sheetNames.meta, ['key', 'value']),
        this.writeHeaders(this.sheetNames.teams, ['id', 'name', 'projectId', 'profileIds', 'notes', 'createdAt', 'updatedAt']),
        this.writeHeaders(this.sheetNames.profiles, ['id', 'name', 'email', 'notes', 'createdAt', 'updatedAt']),
        this.writeHeaders(this.sheetNames.institutions, ['id', 'name', 'notes', 'createdAt', 'updatedAt']),
        this.writeHeaders(this.sheetNames.projects, ['id', 'name', 'notes', 'createdAt', 'updatedAt']),
        this.writeHeaders(this.sheetNames.categories, ['id', 'name', 'notes', 'createdAt', 'updatedAt']),
        this.writeHeaders(this.sheetNames.subcategories, ['id', 'name', 'category', 'notes', 'createdAt', 'updatedAt'])
    ]);
},

async writeHeaders(sheetName, headers) {
    if (!this.userSheetId) return;
    await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: this.userSheetId,
        range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
        valueInputOption: 'RAW',
        resource: { values: [headers] }
    });
},

async loadData() {
    await this.ensureUserStorage();
    const [eventsRes, txRes, metaRes, teamsRes, profilesRes, institutionsRes, projectsRes, categoriesRes, subcategoriesRes] = await Promise.all([
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A:L`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A:I`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.meta}!A:B`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.teams}!A:G`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.profiles}!A:F`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.institutions}!A:E`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.projects}!A:E`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.categories}!A:E`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.subcategories}!A:F`
        })
    ]);

    const eventsRows = eventsRes.result.values || [];
    const txRows = txRes.result.values || [];
    const metaRows = metaRes.result.values || [];
    const teamRows = teamsRes.result.values || [];
    const profileRows = profilesRes.result.values || [];
    const institutionRows = institutionsRes.result.values || [];
    const projectRows = projectsRes.result.values || [];
    const categoryRows = categoriesRes.result.values || [];
    const subcategoryRows = subcategoriesRes.result.values || [];

    this.db = {};
    eventsRows.slice(1).forEach((row) => {
        if (row.length < 6) return;
        const [id, date, start, end, label, type, agenda, stakeholders, notes, budget, allDay, widgetsRaw] = row;
        if (!date) return;
        let widgets = {};
        if (widgetsRaw && typeof widgetsRaw === 'string') {
            try { widgets = JSON.parse(widgetsRaw) || {}; } catch (_) {}
        }
        if (!this.db[date]) this.db[date] = [];
        const ev = {
            id,
            date,
            start: parseFloat(start),
            end: parseFloat(end),
            label,
            type,
            agenda: agenda || '',
            stakeholders: stakeholders || '',
            notes: notes || '',
            budget: budget || '',
            allDay: allDay === '1' || allDay === 'true',
            widgets
        };
        this.db[date].push(ev);
    });

    this.transactions = txRows.slice(1).map((row) => {
        if (row.length >= 9) {
            const [id, date, time, item, description, amount, category, subcategory, eventId] = row;
            return {
                id,
                date,
                time,
                desc: item || description || '',
                item: item || '',
                description: description || '',
                amount: parseFloat(String(amount || '0').replace(/,/g, '')),
                category,
                subcategory: subcategory || '',
                eventId: eventId || ''
            };
        }
        const [id, date, time, desc, amount, category, subcategory, eventId] = row;
        return {
            id,
            date,
            time,
            desc: desc || '',
            item: '',
            description: '',
            amount: parseFloat(String(amount || '0').replace(/,/g, '')),
            category,
            subcategory: subcategory || '',
            eventId: eventId || ''
        };
    }).filter(tx => tx.date);

    this.transactions.sort((a, b) => {
        const aStamp = `${a.date} ${a.time || '00:00'}`;
        const bStamp = `${b.date} ${b.time || '00:00'}`;
        return bStamp.localeCompare(aStamp);
    });

    const meta = {};
    metaRows.slice(1).forEach(([key, value]) => {
        if (key) meta[key] = value;
    });
    if (meta.currentNet) this.currentNet = parseFloat(meta.currentNet);
    if (meta.editMeetingWidgets) {
        try { this.editMeetingWidgets = JSON.parse(meta.editMeetingWidgets); } catch (_) {}
    }
    if (!this.editMeetingWidgets || typeof this.editMeetingWidgets !== 'object') {
        this.editMeetingWidgets = { stakeholders: true, agenda: true, timeblockExpenses: true };
    }

    this.projects = this.parseProjects(projectRows);
    this.teams = this.parseTeams(teamRows);
    this.profiles = this.parseProfiles(profileRows);
    this.institutions = this.parseEntities(institutionRows);
    this.categories = this.parseEntities(categoryRows);
    this.subcategories = this.parseSubcategories(subcategoryRows);
},

parseEntities(rows) {
    return rows.slice(1).map((row) => {
        const [id, name, notes, createdAt, updatedAt] = row;
        if (!id) return null;
        return { id, name, notes, createdAt, updatedAt };
    }).filter(Boolean);
},

parseTeams(rows) {
    return rows.slice(1).map((row) => {
        const [id, name, projectId, profileIds, notes, createdAt, updatedAt] = row;
        if (!id) return null;
        return { id, name, projectId, profileIds, notes, createdAt, updatedAt };
    }).filter(Boolean);
},

parseProfiles(rows) {
    return rows.slice(1).map((row) => {
        const [id, name, email, notes, createdAt, updatedAt] = row;
        if (!id) return null;
        return { id, name, email, notes, createdAt, updatedAt };
    }).filter(Boolean);
},

parseProjects(rows) {
    return rows.slice(1).map((row) => {
        const [id, name, notes, createdAt, updatedAt] = row;
        if (!id) return null;
        return { id, name, notes, createdAt, updatedAt };
    }).filter(Boolean);
},

parseSubcategories(rows) {
    return rows.slice(1).map((row) => {
        const [id, name, category, notes, createdAt, updatedAt] = row;
        if (!id) return null;
        return { id, name, category, notes, createdAt, updatedAt };
    }).filter(Boolean);
},

generateEntityId(prefix) {
    return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
},

getEntityPrefix(type) {
    if (type === 'categories') return 'category';
    if (type === 'subcategories') return 'subcategory';
    return type.slice(0, -1);
},

getSheetNameForEntity(type) {
    if (type === 'teams') return this.sheetNames.teams;
    if (type === 'profiles') return this.sheetNames.profiles;
    if (type === 'institutions') return this.sheetNames.institutions;
    if (type === 'projects') return this.sheetNames.projects;
    if (type === 'categories') return this.sheetNames.categories;
    if (type === 'subcategories') return this.sheetNames.subcategories;
    return null;
},

async saveEntity(type, entity) {
    const sheetName = this.getSheetNameForEntity(type);
    if (!sheetName || !entity || !entity.id) return;
    await this.ensureUserStorage();
    let row = [];
    if (type === 'teams') {
        row = [entity.id, entity.name, entity.projectId || '', entity.profileIds || '', entity.notes || '', entity.createdAt, entity.updatedAt];
    } else if (type === 'profiles') {
        row = [entity.id, entity.name, entity.email || '', entity.notes || '', entity.createdAt, entity.updatedAt];
    } else if (type === 'projects') {
        row = [entity.id, entity.name, entity.notes || '', entity.createdAt, entity.updatedAt];
    } else if (type === 'subcategories') {
        row = [entity.id, entity.name, entity.category || '', entity.notes || '', entity.createdAt, entity.updatedAt];
    } else {
        row = [entity.id, entity.name, entity.notes || '', entity.createdAt, entity.updatedAt];
    }
    const rowIndex = await this.findRowById(sheetName, entity.id);
    const columnCount = row.length;
    const columnEnd = String.fromCharCode(64 + columnCount);
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${sheetName}!A${rowIndex}:${columnEnd}${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${sheetName}!A:${columnEnd}`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
    this.pulseActiveInput();
},

async deleteEntity(type, id) {
    const sheetName = this.getSheetNameForEntity(type);
    if (!sheetName || !id) return;
    await this.ensureUserStorage();
    const rowIndex = await this.findRowById(sheetName, id);
    if (!rowIndex || !this.sheetInfo || !this.sheetInfo[sheetName]) return;

    await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: this.userSheetId,
        resource: {
            requests: [{
                deleteDimension: {
                    range: {
                        sheetId: this.sheetInfo[sheetName],
                        dimension: 'ROWS',
                        startIndex: rowIndex - 1,
                        endIndex: rowIndex
                    }
                }
            }]
        }
    });
},

async saveEvent(event) {
    if (!event || !event.id) return;
    await this.ensureUserStorage();
    const date = event.date || this.selectedDate;
    const widgets = event.widgets && typeof event.widgets === 'object' ? event.widgets : {};
    const row = [
        event.id,
        date,
        event.start,
        event.end,
        event.label,
        event.type,
        event.agenda || '',
        event.stakeholders || '',
        event.notes || '',
        event.budget || '',
        event.allDay ? '1' : '0',
        JSON.stringify(widgets)
    ];
    const rowIndex = await this.findRowById(this.sheetNames.events, event.id);
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A${rowIndex}:L${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A:L`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
    this.pulseActiveInput();
},

async deleteEventById(eventId) {
    if (!eventId) return;
    await this.ensureUserStorage();
    const rowIndex = await this.findRowById(this.sheetNames.events, eventId);
    if (!rowIndex || !this.sheetInfo || !this.sheetInfo[this.sheetNames.events]) return;

    await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: this.userSheetId,
        resource: {
            requests: [{
                deleteDimension: {
                    range: {
                        sheetId: this.sheetInfo[this.sheetNames.events],
                        dimension: 'ROWS',
                        startIndex: rowIndex - 1,
                        endIndex: rowIndex
                    }
                }
            }]
        }
    });
},

async saveTransaction(tx) {
    if (!tx || !tx.id) return;
    await this.ensureUserStorage();
    const row = [
        tx.id,
        this.formatDate(tx.date),
        tx.time,
        tx.item || '',
        tx.description || '',
        this.formatAmount(tx.amount),
        tx.category,
        tx.subcategory || '',
        tx.eventId || ''
    ];
    const rowIndex = await this.findRowById(this.sheetNames.transactions, tx.id);
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A${rowIndex}:I${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A:I`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
    this.pulseActiveInput();
},

async saveMeta() {
    if (!this.userSheetId) return;
    await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: this.userSheetId,
        range: `${this.sheetNames.meta}!A2:B2`,
        valueInputOption: 'RAW',
        resource: { values: [['currentNet', this.currentNet.toString()]] }
    });
},

async saveEditMeetingWidgets() {
    if (!this.userSheetId) return;
    await this.ensureUserStorage();
    const key = 'editMeetingWidgets';
    const rowIndex = await this.findRowById(this.sheetNames.meta, key);
    const row = [key, JSON.stringify(this.editMeetingWidgets)];
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.meta}!A${rowIndex}:B${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.meta}!A:B`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
},

getWidgetVisible(key, event) {
    const def = this.editMeetingWidgets && this.editMeetingWidgets[key];
    const override = event && event.widgets && event.widgets[key];
    if (override !== undefined && override !== null) return !!override;
    return def !== undefined && def !== null ? !!def : true;
},

openEditMeetingSettings() {
    const overlay = document.getElementById('edit-meeting-settings-overlay');
    if (!overlay) return;
    this.renderEditMeetingWidgets();
    overlay.style.display = 'flex';
},

closeEditMeetingSettings() {
    const overlay = document.getElementById('edit-meeting-settings-overlay');
    if (overlay) overlay.style.display = 'none';
    this.updatePanelContext();
},

renderEditMeetingWidgets() {
    const list = document.getElementById('edit-meeting-widgets-list');
    if (!list) return;
    const events = this.db[this.selectedDate] || [];
    const activeEvent = this.currentEventIdx !== null ? events[this.currentEventIdx] : null;
    const widgets = [
        { key: 'stakeholders', label: 'Stakeholders' },
        { key: 'agenda', label: 'Session Agenda' },
        { key: 'timeblockExpenses', label: 'Timeblock Expenses' }
    ];
    list.innerHTML = widgets.map(({ key, label }) => {
        const def = this.editMeetingWidgets[key] !== false;
        const override = activeEvent && activeEvent.widgets && activeEvent.widgets[key];
        const effective = this.getWidgetVisible(key, activeEvent);
        const meetingChecked = override !== undefined ? !!override : effective;
        return `
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 16px; padding: 12px 14px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
                <span style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 600;">${label}</span>
                <div style="display:flex; align-items:center; gap: 16px;">
                    <label style="display:flex; align-items:center; gap: 6px; color: rgba(255,255,255,0.5); font-size: 10px; cursor: pointer;">
                        <input type="checkbox" data-widget="${key}" data-scope="default" ${def ? 'checked' : ''}>
                        Default
                    </label>
                    <label style="display:flex; align-items:center; gap: 6px; color: rgba(255,255,255,0.5); font-size: 10px; cursor: pointer;">
                        <input type="checkbox" data-widget="${key}" data-scope="meeting" ${meetingChecked ? 'checked' : ''}>
                        This meeting
                    </label>
                </div>
            </div>
        `;
    }).join('');
    list.querySelectorAll('input[data-widget]').forEach((input) => {
        input.addEventListener('change', () => {
            const key = input.dataset.widget;
            const scope = input.dataset.scope;
            const checked = input.checked;
            if (scope === 'default') {
                this.editMeetingWidgets[key] = checked;
                void this.saveEditMeetingWidgets();
            } else {
                const events = this.db[this.selectedDate] || [];
                const activeEvent = this.currentEventIdx !== null ? events[this.currentEventIdx] : null;
                if (activeEvent) {
                    if (!activeEvent.widgets) activeEvent.widgets = {};
                    activeEvent.widgets[key] = checked;
                }
            }
            this.updatePanelContext();
        });
    });
},

queueMetaSave() {
    if (this.metaSaveTimer) return;
    this.metaSaveTimer = setTimeout(async () => {
        this.metaSaveTimer = null;
        await this.saveMeta();
    }, 10000);
},

async findRowById(sheetName, id) {
    const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: this.userSheetId,
        range: `${sheetName}!A:A`
    });
    const values = res.result.values || [];
    const rowIndex = values.findIndex((row) => row[0] === id);
    return rowIndex >= 0 ? rowIndex + 1 : null;
},
    
openMeeting(idx) {
    this.isMeetingActive = true;
    this.currentEventIdx = idx;
    document.getElementById('modal-overlay').style.display = 'flex';

    // Show delete button for existing events
    const deleteBtn = document.getElementById('delete-event-btn');
    if (deleteBtn) {
        deleteBtn.style.display = idx !== null ? 'block' : 'none';
    }

    // Update modal title based on context
    const modalTitle = document.getElementById('modal-main-title');
    const events = this.db[this.selectedDate] || [];
    if (modalTitle && events[idx]) {
        modalTitle.textContent = events[idx].label || 'Edit Session';
    }
    if (events[idx] && events[idx].type) {
        this.activeType = events[idx].type;
    }

    // Sync the sidebar button state
    const btn = document.querySelector('.btn-focus');
    if (btn) {
        btn.innerText = "TERMINATE FOCUS";
        btn.style.background = "#ff453a";
        btn.style.color = "white";
    }

    this.updatePanelContext();
},

togglePreRead(el) {
    let popover = document.getElementById('preread-popover');
    if (!popover) {
        popover = document.createElement('div');
        popover.id = 'preread-popover';
        popover.style.cssText = "position:absolute; background:#1c1c1e; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:15px; box-shadow:0 20px 40px rgba(0,0,0,0.5); z-index:3000; width:280px; display:none;";
        popover.innerHTML = `
            <label style="color:rgba(255,255,255,0.4); margin-bottom:10px; display:block; font-weight:800; font-size:9px; letter-spacing:1px;">CONTEXT / PRE-READ</label>
            <textarea style="width:100%; height:100px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); color:white; font-size:12px; border-radius:8px; padding:10px; outline:none; resize:none;" placeholder="Links or briefing notes..."></textarea>
        `;
        document.body.appendChild(popover);
    }
    
    const isHidden = popover.style.display === 'none' || popover.style.display === '';
    if (isHidden) {
        const rect = el.getBoundingClientRect();
        popover.style.display = 'block';
        popover.style.top = `${rect.bottom + 10}px`;
        popover.style.left = `${rect.left - 200}px`;
    } else {
        popover.style.display = 'none';
    }
},

    startMeetingTicker(hourlyRate) {
        const ticker = document.getElementById('burn-ticker');
        if(!ticker) return;
        const ratePerSec = hourlyRate / 3600;
        let elapsedSec = 0;
        
        if(this.tickerInterval) clearInterval(this.tickerInterval);
        
        this.tickerInterval = setInterval(() => {
            elapsedSec++;
            ticker.innerText = `$${(elapsedSec * ratePerSec).toFixed(2)} LIVE`;
        }, 1000);
    },

renderDay() {
    const events = this.db[this.selectedDate] || [];
    const container = document.getElementById('ledger-container');
    if (!container) return;

    this.HOUR_HEIGHT = 100;
    const colors = { MEETING: '#007AFF', REMINDER: '#32D74B', TASK: '#FF3B30', EVENT: '#FF9500' };

    // Format time helper
    const formatTime = (h) => {
        const hours = Math.floor(h);
        const mins = Math.round((h - hours) * 60);
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    };

    // Get transactions for today
    const todayTx = this.transactions
        .map((tx, idx) => ({ tx, idx }))
        .filter(({ tx }) => tx.date === this.selectedDate);

    // Build two-column layout
    let html = `
        <div class="ledger-grid" style="position: relative; height: ${24 * this.HOUR_HEIGHT}px;">
            <div class="ledger-events-col" style="position: relative;" onmousedown="ENGINE.handleMouseDown(event)" oncontextmenu="ENGINE.handleContextMenu(event)">
                <div id="time-now-line"></div>
                <div class="events-hit-layer"
                    style="position:absolute; inset:0; z-index:500; pointer-events:none;"></div>`;

    // Hour grid lines
    for (let h = 0; h <= 23; h++) {
        html += `
            <div class="hour-row" style="height:${this.HOUR_HEIGHT}px; border-bottom: 1px solid rgba(255,255,255,0.03); position:relative;">
                <div class="hour-label" style="width: 70px; color: rgba(255,255,255,0.12); font-family: 'SF Mono'; font-size: 10px; padding-top: 8px;">
                    ${h.toString().padStart(2, '0')}:00
                </div>
            </div>`;
    }

    // Event Blocks + Reminder Markers
    const reminderMarkers = [];
    const allDayReminders = [];
    events.forEach((session, idx) => {
        const color = colors[session.type] || colors.MEETING;
        if (session.type === 'REMINDER') {
            const label = session.label || 'Reminder';
            if (session.allDay) {
                allDayReminders.push({ idx, label, color });
            } else {
                const topPos = session.start * this.HOUR_HEIGHT;
                reminderMarkers.push(`
                    <div class="reminder-marker" data-reminder-idx="${idx}" style="position:absolute; top:${topPos - 6}px; right: 22px; height: 16px; display:flex; align-items:center; justify-content:flex-end; cursor: pointer; z-index: 950; pointer-events: auto; padding: 2px 6px; border-radius: 6px; border: 1px solid transparent;"
                        onpointerdown="event.stopPropagation(); ENGINE.startMoveDrag(${idx}, this, event, 'reminder')" onmousedown="event.stopPropagation()" onclick="event.stopPropagation(); ENGINE.openMeeting(${idx})">
                        <div style="display:flex; align-items:center; gap:8px; pointer-events:none; text-align:right;">
                            <div style="width:6px; height:6px; border-radius:50%; background:${color}; opacity:0.85; box-shadow: 0 0 0 2px rgba(255,255,255,0.04);"></div>
                            <div style="font-size:10px; color: rgba(255,255,255,0.7); font-weight:600;">${label}</div>
                            <div style="font-family:'SF Mono'; font-size:9px; color: rgba(255,255,255,0.35);">${formatTime(session.start)}</div>
                        </div>
                    </div>
                `);
            }
            session.isNew = false;
            return;
        }

        const topPos = session.start * this.HOUR_HEIGHT;
        const height = (session.end - session.start) * this.HOUR_HEIGHT;
        const duration = session.end - session.start;
        const durationStr = duration >= 1 ? `${Math.floor(duration)}h ${Math.round((duration % 1) * 60)}m` : `${Math.round(duration * 60)}m`;
        const deleteStyle = height <= 40 ? 'top: 50%; transform: translateY(-50%);' : '';
        // Responsive content based on block height
        const isCompact = height <= 35;  // 15min or less
        const isMedium = height > 35 && height <= 150;  // ~1.5h

        let blockContent = '';
        if (isCompact) {
            // Ultra-compact: label + duration
            blockContent = `
                <div style="padding: 4px 8px; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; height: 100%;">
                    <span style="color: white; font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${session.label}</span>
                    <span style="font-family: 'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.4); margin-left: 8px;">${durationStr}</span>
                </div>`;
        } else if (isMedium) {
            // Medium: type + label + time + duration
            blockContent = `
                <div style="padding: 6px 10px; pointer-events: auto; height: 100%;">
                    <div style="color: ${color}; font-size: 8px; font-weight: 800; letter-spacing: 1px;">${session.type}</div>
                    <div style="color: white; font-weight: 600; font-size: 12px; margin-top: 2px;">${session.label}</div>
                    <div style="font-family: 'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.4); margin-top: 4px;">${formatTime(session.start)} – ${formatTime(session.end)} · ${durationStr}</div>
                </div>`;
        } else {
            // Full: all info
            blockContent = `
                <div style="padding: 10px 12px; pointer-events: auto; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <div style="color: ${color}; font-size: 8px; font-weight: 800; letter-spacing: 1px; margin-bottom: 2px;">${session.type}</div>
                        <div style="color: white; font-weight: 600; font-size: 13px;">${session.label}</div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                            <span style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.4);">${formatTime(session.start)} – ${formatTime(session.end)}</span>
                            <span style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.3);">${durationStr}</span>
                        </div>
                    </div>
                </div>`;
        }

        html += `
            <div class="block-space ${session.isNew ? 'block-creation-anim' : ''}"
                data-block-idx="${idx}"
                onmousedown="event.stopPropagation()"
                onpointerdown="event.stopPropagation(); ENGINE.startMoveDrag(${idx}, this, event)"
                oncontextmenu="event.preventDefault(); event.stopPropagation(); ENGINE.handleContextMenu(event)"
                style="
                    top: ${topPos}px;
                    height: ${height}px;
                    left: 80px;
                    right: 12px;
                    border-left: 3px solid ${color};
                    position: absolute;
                    cursor: pointer;
                    z-index: 60;
                    pointer-events: all;
                ">
                ${blockContent}
            </div>`;
        session.isNew = false;
    });

    if (reminderMarkers.length) {
        html += `<div class="reminder-layer">${reminderMarkers.join('')}</div>`;
    }

    html += `</div>`; // Close events column

    // Transactions column
    html += `<div class="ledger-transactions-col" style="position: relative;">`;

    // Hour guides for transactions (no lines, just spacing)
    for (let h = 0; h <= 23; h++) {
        html += `<div style="height:${this.HOUR_HEIGHT}px;"></div>`;
    }

    // Transaction markers
    todayTx.forEach(({ tx, idx }) => {
        const [hours, mins] = String(tx.time || '00:00').split(':').map(Number);
        const timeDecimal = hours + (mins / 60);
        const topPos = timeDecimal * this.HOUR_HEIGHT;
        const isIncome = tx.amount >= 0;

        const categoryLabel = (tx.category || tx.subcategory)
            ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
            : '';
        html += `
            <div class="transaction-marker ${isIncome ? 'income' : 'expense'}" data-tx-idx="${idx}" style="top: ${topPos}px; cursor: pointer;"
                onpointerdown="event.stopPropagation(); ENGINE.startMoveTransaction(${idx}, this, event)"
                oncontextmenu="event.preventDefault(); event.stopPropagation(); ENGINE.showTransactionMenu(event.clientX, event.clientY, ${idx})">
                <div style="display:flex; align-items:center; gap:8px; font-family:'SF Mono'; font-size:10px; color: rgba(255,255,255,0.65); white-space: nowrap; overflow: hidden;">
                    <span style="color: rgba(255,255,255,0.35);">${this.escapeHTML(tx.time || '00:00')}</span>
                    <span style="color: rgba(255,255,255,0.65);">${isIncome ? '+' : ''}${this.formatAmount(tx.amount, 0)}</span>
                    ${categoryLabel ? `<span style="color: rgba(255,255,255,0.45);">• ${categoryLabel}</span>` : ''}
                </div>
            </div>`;
    });

    html += `</div></div>`; // Close transactions column and grid

    container.innerHTML = html;
    this.renderAllDayReminders(allDayReminders);
    this.updateIntegrityMeter();
    this.updateTimeline(false);
},

updateIntegrityMeter() {
    const events = this.db[this.selectedDate] || [];
    const totalHours = events.reduce((acc, event) => {
        if (!event || event.type === 'REMINDER') return acc;
        const start = parseFloat(event.start);
        const end = parseFloat(event.end);
        if (!Number.isFinite(start) || !Number.isFinite(end)) return acc;
        return acc + Math.max(0, end - start);
    }, 0);
    const clampedHours = Math.min(24, totalHours);
    const percent = Math.round((clampedHours / 24) * 100);
    const value = document.getElementById('system-health-value');
    const bar = document.getElementById('system-health-bar');
    if (value) value.textContent = `${clampedHours.toFixed(1)}h / 24h`;
    if (bar) {
        bar.style.width = `${percent}%`;
        bar.style.boxShadow = '0 0 12px rgba(0,255,135,0.35)';
    }
},

renderAllDayReminders(items) {
    const container = document.getElementById('all-day-reminders');
    if (!container) return;
    if (!items || !items.length) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.35); font-size: 11px;">No all-day reminders.</div>';
        return;
    }
    container.innerHTML = items.map(item => `
        <div onclick="ENGINE.openMeeting(${item.idx})" class="data-row" style="display:flex; align-items:center; gap:8px; padding: 6px 8px; border-radius: 8px; cursor: pointer;">
            <div style="width:6px; height:6px; border-radius:50%; background:${item.color}; opacity:0.85;"></div>
            <div style="font-size:11px; color: rgba(255,255,255,0.8); font-weight:600;">${item.label}</div>
        </div>
    `).join('');
},

// Delete event directly from block
async deleteEvent(idx) {
    const events = this.db[this.selectedDate];
    if (!events || !events[idx]) return;

    const [removed] = events.splice(idx, 1);
    if (removed) {
        this.recordUndo({ type: 'deleteEvent', event: { ...removed } });
    }
    if (events.length === 0) delete this.db[this.selectedDate];

    if (removed && removed.id) {
        await this.deleteEventById(removed.id);
    }
    this.renderDay();
},

async deleteTransaction(idx) {
    const tx = this.transactions[idx];
    if (!tx) return;
    this.recordUndo({ type: 'deleteTransaction', tx: { ...tx } });
    this.transactions.splice(idx, 1);
    if (tx.id) {
        await this.deleteTransactionById(tx.id);
    }
    this.renderTransactions();
    this.renderDay();
},

async deleteTransactionById(txId) {
    if (!txId) return;
    await this.ensureUserStorage();
    const rowIndex = await this.findRowById(this.sheetNames.transactions, txId);
    if (!rowIndex || !this.sheetInfo || !this.sheetInfo[this.sheetNames.transactions]) return;
    await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: this.userSheetId,
        resource: {
            requests: [{
                deleteDimension: {
                    range: {
                        sheetId: this.sheetInfo[this.sheetNames.transactions],
                        dimension: 'ROWS',
                        startIndex: rowIndex - 1,
                        endIndex: rowIndex
                    }
                }
            }]
        }
    });
},
    
updateTimeline(shouldScroll = false) {
    const line = document.getElementById('time-now-line');
    if (!line) return;

    // Only show line for today
    const today = new Date().toISOString().split('T')[0];
    if (this.selectedDate !== today) {
        line.style.display = 'none';
        return;
    }

    line.style.display = 'block';
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const totalHours = hours + (minutes / 60) + (seconds / 3600);

    const topPos = totalHours * this.HOUR_HEIGHT;
    line.style.top = `${topPos}px`;

    if (shouldScroll) {
        const container = document.getElementById('ledger-container');
        if (container) {
            const scrollTarget = topPos - (container.clientHeight / 2);
            container.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }
    }
},

    renderWeek() {
        const container = document.getElementById('weekly-columns');
        if (!container) return;
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let html = '<div style="margin-top: 30px;">' + Array.from({length: 24}, (_, h) => `<div style="height:40px; font-size:9px; color:var(--text-dim); text-align:right; padding-right:10px;">${h.toString().padStart(2,'0')}:00</div>`).join('') + '</div>';
        days.forEach((day, i) => {
            html += `<div class="week-day-col"><div class="p-label" style="text-align:center;">${day}</div><div style="height:960px; position:relative; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05);"></div></div>`;
        });
        container.innerHTML = html;
    },

    renderMonth() {
        const container = document.getElementById('monthly-grid');
        if (!container) return;
        let html = '';
        for(let d=1; d<=31; d++) {
            html += `<div class="month-day-card"><div class="day-num">${d}</div></div>`;
        }
        container.innerHTML = html;
    },

    renderYear() {
        const container = document.getElementById('yearly-grid');
        if (!container) return;
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        container.innerHTML = months.map(m => `<div><div class="p-label">${m}</div><div class="cal-grid">${Array.from({length:31}, () => `<div class="dot"></div>`).join('')}</div></div>`).join('');
    },

    openSettings() {
        const overlay = document.getElementById('settings-overlay');
        if (!overlay) return;
        this.renderSettings();
        overlay.style.display = 'flex';
    },

    closeSettings() {
        const overlay = document.getElementById('settings-overlay');
        if (overlay) overlay.style.display = 'none';
    },

    logOut() {
        this.closeSettings();
        this.userEmail = null;
        this.userSheetId = null;
        try {
            localStorage.removeItem('ENGINE_LAST_USER');
        } catch (_) {}
        if (typeof gapi !== 'undefined' && gapi.client && gapi.client.setToken) {
            gapi.client.setToken(null);
        }
        if (typeof showLoginUI === 'function') showLoginUI();
    },

    renderSettings() {
        const renderList = (items, type) => items.map((item) => `
            <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 8px 10px; border-radius: 8px; gap: 10px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="font-size: 12px; color: #ffffff; font-weight: 600;">${item.name}</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.4); font-family:'SF Mono';">${item.id}</div>
                    ${type === 'profiles' ? `<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Email: ${item.email || ''}</div>` : ''}
                    ${type === 'teams' ? `<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Project: ${this.getProjectNameById(item.projectId) || 'Unassigned'}</div>` : ''}
                    ${type === 'teams' ? `<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Profiles: ${this.getProfileNamesByIds(item.profileIds).join(', ') || 'None'}</div>` : ''}
                    ${type === 'subcategories' ? `<div style="font-size: 10px; color: rgba(255,255,255,0.5);">Category: ${item.category || 'Unassigned'}</div>` : ''}
                    <div style="font-size: 10px; color: rgba(255,255,255,0.4);">${item.notes || ''}</div>
                </div>
                <div style="display:flex; gap:6px;">
                    <button onclick="ENGINE.openEditEntity('${type}', '${item.id}')" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); padding: 6px 10px; border-radius: 6px; font-size: 10px; cursor: pointer;">EDIT</button>
                <button onclick="ENGINE.removeEntity('${type}', '${item.id}')" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); padding: 6px 10px; border-radius: 6px; font-size: 10px; cursor: pointer;">REMOVE</button>
                </div>
            </div>
        `).join('');

        const teamList = document.getElementById('settings-team-list');
        const profileList = document.getElementById('settings-profile-list');
        const institutionList = document.getElementById('settings-institution-list');
        const projectList = document.getElementById('settings-project-list');
        const projectSelect = document.getElementById('settings-teams-project');
        const teamProfiles = document.getElementById('settings-teams-profiles');
        const categoryList = document.getElementById('settings-category-list');
        const subcategoryList = document.getElementById('settings-subcategory-list');
        const subcategoryCategorySelect = document.getElementById('settings-subcategories-category');

        if (teamList) teamList.innerHTML = this.teams.length ? renderList(this.teams, 'teams') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No teams yet.</div>';
        if (profileList) profileList.innerHTML = this.profiles.length ? renderList(this.profiles, 'profiles') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No profiles yet.</div>';
        if (institutionList) institutionList.innerHTML = this.institutions.length ? renderList(this.institutions, 'institutions') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No institutions yet.</div>';
        if (projectList) projectList.innerHTML = this.projects.length ? renderList(this.projects, 'projects') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No projects yet.</div>';
        if (categoryList) categoryList.innerHTML = this.categories.length ? renderList(this.categories, 'categories') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No categories yet.</div>';
        if (subcategoryList) subcategoryList.innerHTML = this.subcategories.length ? renderList(this.subcategories, 'subcategories') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No subcategories yet.</div>';
        if (projectSelect) {
            const options = ['<option value="">Link to Project</option>']
                .concat(this.projects.map(project => `<option value="${project.id}">${project.name}</option>`));
            projectSelect.innerHTML = options.join('');
        }
        if (subcategoryCategorySelect) {
            const options = ['<option value="">Link to Category</option>']
                .concat(this.categories.map(category => `<option value="${category.name}">${category.name}</option>`));
            subcategoryCategorySelect.innerHTML = options.join('');
        }
        if (teamProfiles) {
            teamProfiles.innerHTML = this.profiles.map(profile => `
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; color: rgba(255,255,255,0.7);">
                    <input type="checkbox" value="${profile.id}">
                    ${profile.name} (${profile.email || 'no email'})
                </label>
            `).join('');
        }
    },

    async addEntity(type) {
        const nameInput = document.getElementById(`settings-${type}-name`);
        const notesInput = document.getElementById(`settings-${type}-notes`);
        const projectSelect = document.getElementById('settings-teams-project');
        const teamProfiles = document.getElementById('settings-teams-profiles');
        const emailInput = document.getElementById('settings-profiles-email');
        const subcategoryCategorySelect = document.getElementById('settings-subcategories-category');
        if (!nameInput) return;
        const name = nameInput.value.trim();
        if (!name) return;
        const now = new Date().toISOString();
        const entity = {
            id: this.generateEntityId(this.getEntityPrefix(type)),
            name,
            notes: notesInput ? notesInput.value.trim() : '',
            createdAt: now,
            updatedAt: now
        };
        if (type === 'teams' && projectSelect) {
            entity.projectId = projectSelect.value || '';
        }
        if (type === 'teams' && teamProfiles) {
            entity.profileIds = Array.from(teamProfiles.querySelectorAll('input[type="checkbox"]:checked'))
                .map(input => input.value)
                .join(',');
        }
        if (type === 'profiles' && emailInput) {
            entity.email = emailInput.value.trim();
        }
        if (type === 'subcategories' && subcategoryCategorySelect) {
            entity.category = subcategoryCategorySelect.value || '';
        }
        this[type].unshift(entity);
        await this.saveEntity(type, entity);
        nameInput.value = '';
        if (notesInput) notesInput.value = '';
        if (projectSelect && type === 'teams') projectSelect.value = '';
        if (teamProfiles && type === 'teams') {
            teamProfiles.querySelectorAll('input[type="checkbox"]').forEach(input => { input.checked = false; });
        }
        if (emailInput && type === 'profiles') emailInput.value = '';
        if (subcategoryCategorySelect && type === 'subcategories') subcategoryCategorySelect.value = '';
        this.renderSettings();
    },

    openEditEntity(type, id) {
        const list = this[type];
        const entity = list.find(item => item.id === id);
        if (!entity) return;
        const overlay = document.getElementById('edit-entity-overlay');
        if (!overlay) return;
        const title = document.getElementById('edit-entity-title');
        const nameInput = document.getElementById('edit-entity-name');
        const emailInput = document.getElementById('edit-entity-email');
        const notesInput = document.getElementById('edit-entity-notes');
        const projectSelect = document.getElementById('edit-entity-project');
        const profileList = document.getElementById('edit-entity-profiles');
        const categorySelect = document.getElementById('edit-entity-category');

        overlay.dataset.type = type;
        overlay.dataset.id = id;
        overlay.dataset.mode = 'edit';
        if (title) title.textContent = `Edit ${type.slice(0, -1).toUpperCase()}`;
        if (nameInput) nameInput.value = entity.name || '';
        if (notesInput) notesInput.value = entity.notes || '';

        if (emailInput) {
            emailInput.style.display = type === 'profiles' ? 'block' : 'none';
            emailInput.value = entity.email || '';
        }
        if (projectSelect) {
            projectSelect.style.display = type === 'teams' ? 'block' : 'none';
            const options = ['<option value="">Link to Project</option>']
                .concat(this.projects.map(project => `<option value="${project.id}">${project.name}</option>`));
            projectSelect.innerHTML = options.join('');
            projectSelect.value = entity.projectId || '';
        }
        if (profileList) {
            profileList.style.display = type === 'teams' ? 'flex' : 'none';
            const selected = (entity.profileIds || '').split(',').filter(Boolean);
            profileList.innerHTML = this.profiles.map(profile => `
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; color: rgba(255,255,255,0.7);">
                    <input type="checkbox" value="${profile.id}" ${selected.includes(profile.id) ? 'checked' : ''}>
                    ${profile.name} (${profile.email || 'no email'})
                </label>
            `).join('');
        }
        if (categorySelect) {
            categorySelect.style.display = type === 'subcategories' ? 'block' : 'none';
            const options = ['<option value="">Link to Category</option>']
                .concat(this.categories.map(category => `<option value="${category.name}">${category.name}</option>`));
            categorySelect.innerHTML = options.join('');
            categorySelect.value = entity.category || '';
        }

        overlay.style.display = 'flex';
    },

    openCreateEntity(type) {
        const overlay = document.getElementById('edit-entity-overlay');
        if (!overlay) return;
        const title = document.getElementById('edit-entity-title');
        const nameInput = document.getElementById('edit-entity-name');
        const emailInput = document.getElementById('edit-entity-email');
        const notesInput = document.getElementById('edit-entity-notes');
        const projectSelect = document.getElementById('edit-entity-project');
        const profileList = document.getElementById('edit-entity-profiles');
        const categorySelect = document.getElementById('edit-entity-category');

        overlay.dataset.type = type;
        overlay.dataset.id = '';
        overlay.dataset.mode = 'create';
        if (title) title.textContent = `Create ${type.slice(0, -1).toUpperCase()}`;
        if (nameInput) nameInput.value = '';
        if (notesInput) notesInput.value = '';

        if (emailInput) {
            emailInput.style.display = type === 'profiles' ? 'block' : 'none';
            emailInput.value = '';
        }
        if (projectSelect) {
            projectSelect.style.display = type === 'teams' ? 'block' : 'none';
            const options = ['<option value="">Link to Project</option>']
                .concat(this.projects.map(project => `<option value="${project.id}">${project.name}</option>`));
            projectSelect.innerHTML = options.join('');
            projectSelect.value = '';
        }
        if (profileList) {
            profileList.style.display = type === 'teams' ? 'flex' : 'none';
            profileList.innerHTML = this.profiles.map(profile => `
                <label style="display:flex; align-items:center; gap:8px; font-size:11px; color: rgba(255,255,255,0.7);">
                    <input type="checkbox" value="${profile.id}">
                    ${profile.name} (${profile.email || 'no email'})
                </label>
            `).join('');
        }
        if (categorySelect) {
            categorySelect.style.display = type === 'subcategories' ? 'block' : 'none';
            const options = ['<option value="">Link to Category</option>']
                .concat(this.categories.map(category => `<option value="${category.name}">${category.name}</option>`));
            categorySelect.innerHTML = options.join('');
            categorySelect.value = '';
        }

        overlay.style.display = 'flex';
    },

    closeEditEntity() {
        const overlay = document.getElementById('edit-entity-overlay');
        if (overlay) overlay.style.display = 'none';
    },

    async saveEditEntity() {
        const overlay = document.getElementById('edit-entity-overlay');
        if (!overlay) return;
        const type = overlay.dataset.type;
        const id = overlay.dataset.id;
        const mode = overlay.dataset.mode || 'edit';
        const list = this[type];
        let entity = list.find(item => item.id === id);
        if (!entity && mode !== 'create') return;

        const nameInput = document.getElementById('edit-entity-name');
        const emailInput = document.getElementById('edit-entity-email');
        const notesInput = document.getElementById('edit-entity-notes');
        const projectSelect = document.getElementById('edit-entity-project');
        const profileList = document.getElementById('edit-entity-profiles');
        const categorySelect = document.getElementById('edit-entity-category');

        const nameValue = nameInput ? nameInput.value.trim() : '';
        const notesValue = notesInput ? notesInput.value.trim() : '';
        if (mode === 'create') {
            if (!nameValue) return;
            const now = new Date().toISOString();
            entity = {
                id: this.generateEntityId(this.getEntityPrefix(type)),
                name: nameValue,
                notes: notesValue,
                createdAt: now,
                updatedAt: now
            };
            list.unshift(entity);
        } else {
            entity.name = nameValue || entity.name;
            entity.notes = notesValue;
        }
        if (type === 'profiles' && emailInput) {
            entity.email = emailInput.value.trim();
        }
        if (type === 'teams' && projectSelect) {
            entity.projectId = projectSelect.value || '';
        }
        if (type === 'teams' && profileList) {
            entity.profileIds = Array.from(profileList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(input => input.value)
                .join(',');
        }
        if (type === 'subcategories' && categorySelect) {
            entity.category = categorySelect.value || '';
        }

        entity.updatedAt = new Date().toISOString();
        await this.saveEntity(type, entity);
        this.closeEditEntity();
        this.renderSettings();
    },

    async removeEntity(type, id) {
        const list = this[type];
        const idx = list.findIndex(item => item.id === id);
        if (idx === -1) return;
        const [removed] = list.splice(idx, 1);
        await this.deleteEntity(type, removed.id);
        this.renderSettings();
    },

    getProjectNameById(projectId) {
        if (!projectId) return '';
        const project = this.projects.find(item => item.id === projectId);
        return project ? project.name : '';
    },

    getProfileNamesByIds(profileIds) {
        if (!profileIds) return [];
        const ids = profileIds.split(',').filter(Boolean);
        return ids.map(id => {
            const profile = this.profiles.find(item => item.id === id);
            return profile ? profile.name : id;
        });
    },

getCategoryByName(name) {
    if (!name) return null;
    return this.categories.find(item => item.name === name) || null;
},

getSubcategoryByName(name) {
    if (!name) return null;
    return this.subcategories.find(item => item.name === name) || null;
},

getSubcategoriesForCategory(categoryName) {
    if (!categoryName) return this.subcategories;
    return this.subcategories.filter(item => item.category === categoryName);
},

populateSelectOptions(select, items, selectedValue, placeholder, includeManage = false) {
    if (!select) return;
    const normalizedItems = Array.from(new Set(items));
    if (selectedValue && !normalizedItems.includes(selectedValue)) {
        normalizedItems.unshift(selectedValue);
    }
    const options = [`<option value="">${placeholder}</option>`]
        .concat(normalizedItems.map(item => `<option value="${item}">${item}</option>`));
    if (includeManage) {
        options.push('<option value="__divider__" disabled>────────</option>');
        options.push('<option value="__create__">+ Create</option>');
        options.push('<option value="__edit__">✎ Edit selected</option>');
        options.push('<option value="__delete__">🗑 Delete selected</option>');
    }
    select.innerHTML = options.join('');
    select.value = selectedValue || '';
    if (selectedValue) select.dataset.last = selectedValue;
},

handleManagedSelect(select, type, onAfter) {
    if (!select) return;
    select.addEventListener('change', () => {
        const value = select.value;
        if (value === '__divider__') {
            select.value = select.dataset.last || '';
            return;
        }
        if (value === '__create__') {
            this.openCreateEntity(type);
            select.value = select.dataset.last || '';
            return;
        }
        if (value === '__edit__') {
            const current = select.dataset.last || '';
            const entity = type === 'categories' ? this.getCategoryByName(current) : this.getSubcategoryByName(current);
            if (entity) this.openEditEntity(type, entity.id);
            select.value = current;
            return;
        }
        if (value === '__delete__') {
            const current = select.dataset.last || '';
            const entity = type === 'categories' ? this.getCategoryByName(current) : this.getSubcategoryByName(current);
            if (entity) this.removeEntity(type, entity.id);
            select.value = '';
            select.dataset.last = '';
            if (onAfter) onAfter('');
            return;
        }
        select.dataset.last = value;
        if (onAfter) onAfter(value);
    });
},

initCategoryDropdowns(categorySelect, subcategorySelect, selectedCategory, selectedSubcategory) {
    if (!categorySelect || !subcategorySelect) return;
    const categoryNames = this.categories.map(item => item.name);
    this.populateSelectOptions(categorySelect, categoryNames, selectedCategory, 'Category', true);
    const subItems = this.getSubcategoriesForCategory(selectedCategory).map(item => item.name);
    const subSelected = subItems.includes(selectedSubcategory) ? selectedSubcategory : '';
    this.populateSelectOptions(subcategorySelect, subItems, subSelected, 'Subcategory', true);

    if (!categorySelect.dataset.bound) {
        this.handleManagedSelect(categorySelect, 'categories', (value) => {
            const updatedSubItems = this.getSubcategoriesForCategory(value).map(item => item.name);
            this.populateSelectOptions(subcategorySelect, updatedSubItems, '', 'Subcategory', true);
            if (!subcategorySelect.dataset.bound) {
                this.handleManagedSelect(subcategorySelect, 'subcategories');
                subcategorySelect.dataset.bound = 'true';
            }
        });
        categorySelect.dataset.bound = 'true';
    }
    if (!subcategorySelect.dataset.bound) {
        this.handleManagedSelect(subcategorySelect, 'subcategories');
        subcategorySelect.dataset.bound = 'true';
    }
},

    escapeHTML(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    },

    escapeAttribute(value) {
        return this.escapeHTML(value).replace(/`/g, '&#96;');
    },

    parseAmount(value) {
        const normalized = String(value ?? '').replace(/,/g, '').trim();
        if (!normalized) return null;
        const parsed = Number.parseFloat(normalized);
        return Number.isFinite(parsed) ? parsed : null;
    },

    formatDate(value) {
        if (!value) return '';
        const isoMatch = String(value).slice(0, 10);
        if (/^\d{4}-\d{2}-\d{2}$/.test(isoMatch)) return isoMatch;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    formatAmount(amount, decimals = 2) {
        if (amount === null || amount === undefined || Number.isNaN(amount)) return '';
        return Number(amount).toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    },

    decimalToTime(decimal) {
        if (decimal === null || decimal === undefined || Number.isNaN(decimal)) return '00:00';
        const hours = Math.floor(decimal);
        const mins = Math.round((decimal - hours) * 60);
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    },

    timeToDecimal(timeStr) {
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return (h || 0) + ((m || 0) / 60);
    },

    getDurationLabel(start, end) {
        const startDec = this.timeToDecimal(start);
        const endDec = this.timeToDecimal(end);
        const duration = Math.max(0, endDec - startDec);
        const hours = Math.floor(duration);
        const mins = Math.round((duration - hours) * 60);
        return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
    },

    getEventExpenses(eventId) {
        if (!eventId) return [];
        return this.transactions.filter(tx => tx.eventId === eventId);
    },

    addTimeblockExpense() {
        if (this.currentEventIdx === null) return;
        const events = this.db[this.selectedDate] || [];
        const event = events[this.currentEventIdx];
        if (!event) return;
        const itemInput = document.getElementById('timeblock-expense-item');
        const descInput = document.getElementById('timeblock-expense-desc');
        const amountInput = document.getElementById('timeblock-expense-amount');
        const budgetInput = document.getElementById('timeblock-budget');
        const categorySelect = document.getElementById('timeblock-expense-category');
        const subcategorySelect = document.getElementById('timeblock-expense-subcategory');
        const item = itemInput ? itemInput.value.trim() : '';
        const desc = descInput ? descInput.value.trim() : '';
        const amountVal = amountInput ? this.parseAmount(amountInput.value) : null;
        if ((!item && !desc) || amountVal === null) return;
        if (budgetInput) event.budget = budgetInput.value.trim();
        const signEl = document.getElementById('timeblock-expense-sign');
        const sign = signEl && signEl.dataset && signEl.dataset.sign ? parseInt(signEl.dataset.sign, 10) : -1;
        const category = categorySelect && categorySelect.value ? categorySelect.value : 'Timeblock';
        const subcategory = subcategorySelect && subcategorySelect.value ? subcategorySelect.value : '';
        const date = this.formatDate(document.getElementById('timeblock-date')?.value || this.selectedDate);
        const time = document.getElementById('timeblock-start')?.value || new Date().toTimeString().slice(0, 5);
        const signedAmount = sign === 1 ? Math.abs(amountVal) : -Math.abs(amountVal);
        this.addTransaction(item || desc, signedAmount, category, subcategory, date, time, event.id, item, desc);
        if (descInput) descInput.value = '';
        if (itemInput) itemInput.value = '';
        if (amountInput) amountInput.value = this.formatAmount(0);
        this.renderPanelExpenses();
    },

    setTimeblockExpenseSign(sign) {
        const signEl = document.getElementById('timeblock-expense-sign');
        if (!signEl) return;
        signEl.dataset.sign = String(sign);
        const typeEl = document.getElementById('timeblock-expense-type');
        if (typeEl) typeEl.textContent = sign === 1 ? 'Income' : 'Expense';
        const buttons = signEl.querySelectorAll('button');
        if (buttons.length >= 2) {
            const [minusBtn, plusBtn] = buttons;
            if (sign === 1) {
                plusBtn.style.background = 'rgba(255,255,255,0.06)';
                plusBtn.style.border = '1px solid rgba(255,255,255,0.12)';
                plusBtn.style.color = 'rgba(255,255,255,0.8)';
                minusBtn.style.background = 'rgba(255,255,255,0.02)';
                minusBtn.style.border = '1px solid rgba(255,255,255,0.08)';
                minusBtn.style.color = 'rgba(255,255,255,0.5)';
            } else {
                minusBtn.style.background = 'rgba(255,255,255,0.06)';
                minusBtn.style.border = '1px solid rgba(255,255,255,0.12)';
                minusBtn.style.color = 'rgba(255,255,255,0.8)';
                plusBtn.style.background = 'rgba(255,255,255,0.02)';
                plusBtn.style.border = '1px solid rgba(255,255,255,0.08)';
                plusBtn.style.color = 'rgba(255,255,255,0.5)';
            }
        }
    },

    renderPanelExpenses() {
        const list = document.getElementById('timeblock-expense-list');
        const ledger = document.getElementById('timeblock-transaction-ledger');
        const budgetDiffEl = document.getElementById('timeblock-budget-diff');
        if (!list && !ledger) return;
        const events = this.db[this.selectedDate] || [];
        const event = this.currentEventIdx !== null ? events[this.currentEventIdx] : null;
        const expenseItems = event ? this.getEventExpenses(event.id) : [];
        if (list) {
            list.innerHTML = expenseItems.length ? expenseItems.map(tx => {
                const categoryLabel = (tx.category || tx.subcategory)
                    ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
                    : '';
                return `
                <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 8px 10px; border-radius: 8px;">
                    <div>
                        <div style="font-size: 11px; color:white; font-weight:600;">${this.escapeHTML(tx.item || tx.desc)}</div>
                        <div style="font-family:'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.4);">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
                    </div>
                    <div style="font-family:'SF Mono'; font-size: 11px; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                        ${tx.amount >= 0 ? '+' : '-'}${this.formatAmount(Math.abs(tx.amount))}
                    </div>
                </div>
            `;
            }).join('') : '<div style="color: rgba(255,255,255,0.4); font-size: 11px;">No expenses yet.</div>';
        }
        if (ledger) {
            ledger.innerHTML = expenseItems.length ? expenseItems.map(tx => {
                const categoryLabel = (tx.category || tx.subcategory)
                    ? `${tx.category ? this.escapeHTML(tx.category) : ''}${tx.subcategory ? ` / ${this.escapeHTML(tx.subcategory)}` : ''}`
                    : '';
                return `
                <div class="data-row" style="display:flex; justify-content:space-between; align-items:center; padding: 6px 8px; border-radius: 8px;">
                    <div>
                        <div style="font-size: 10px; color:white; font-weight:600;">${this.escapeHTML(tx.item || tx.desc)}</div>
                        <div style="font-family:'SF Mono'; font-size: 8px; color: rgba(255,255,255,0.4);">${this.formatDate(tx.date)} ${this.escapeHTML(tx.time || '')}${categoryLabel ? ` • ${categoryLabel}` : ''}</div>
                    </div>
                    <div style="font-family:'SF Mono'; font-size: 10px; color: ${tx.amount >= 0 ? 'rgba(50, 215, 75, 0.7)' : 'rgba(255, 69, 58, 0.75)'};">
                        ${tx.amount >= 0 ? '+' : '-'}${this.formatAmount(Math.abs(tx.amount))}
                    </div>
                </div>
            `;
            }).join('') : '<div style="color: rgba(255,255,255,0.4); font-size: 10px;">No transactions yet.</div>';
        }
        const budgetDiffValueEl = document.getElementById('timeblock-budget-diff-value');
        if (budgetDiffValueEl) {
            const budgetInput = document.getElementById('timeblock-budget');
            const budgetFromInput = budgetInput && budgetInput.value.trim() ? this.parseAmount(budgetInput.value.trim()) : null;
            const budgetFromEvent = event && event.budget ? this.parseAmount(event.budget) : null;
            const budget = (budgetFromInput ?? budgetFromEvent ?? 0) || 0;
            const total = expenseItems.reduce((sum, tx) => sum + (tx.amount || 0), 0);
            const remaining = budget - total;
            budgetDiffValueEl.textContent = (remaining >= 0 ? '' : '-') + this.formatAmount(Math.abs(remaining));
            budgetDiffValueEl.style.color = remaining >= 0 ? 'rgba(50, 215, 75, 0.85)' : 'rgba(255, 69, 58, 0.9)';
        }
    },

    openTransactionModal(sign) {
        const overlay = document.getElementById('transaction-overlay');
        if (!overlay) return;
        const title = document.getElementById('transaction-title');
        const amountInput = document.getElementById('transaction-amount');
        const itemInput = document.getElementById('transaction-item');
        const descInput = document.getElementById('transaction-desc');
        const dateInput = document.getElementById('transaction-date');
        const timeInput = document.getElementById('transaction-time');
        const categoryInput = document.getElementById('transaction-category');
        const subcategoryInput = document.getElementById('transaction-subcategory');
        const typeInput = document.getElementById('transaction-type');

        overlay.dataset.sign = String(sign);
        delete overlay.dataset.txId;
        if (title) title.textContent = 'Add Transaction';
        if (amountInput) amountInput.value = this.formatAmount(0);
        if (itemInput) itemInput.value = '';
        if (descInput) descInput.value = '';
        const now = new Date();
        if (dateInput) dateInput.value = this.formatDate(now.toISOString().split('T')[0]);
        if (timeInput) timeInput.value = now.toTimeString().slice(0, 5);
        if (categoryInput && subcategoryInput) {
            this.initCategoryDropdowns(categoryInput, subcategoryInput, '', '');
        }
        if (typeInput) typeInput.value = sign > 0 ? 'INCOME' : 'EXPENSE';
        this.updateTransactionTypeUI(sign);
        overlay.style.display = 'flex';
    },

    openTransactionModalWithData(id, idx = null) {
        let tx = this.transactions.find(item => item.id === id);
        if (!tx && Number.isInteger(idx)) tx = this.transactions[idx];
        if (!tx) return;
        const overlay = document.getElementById('transaction-overlay');
        if (!overlay) return;
        const sign = tx.amount >= 0 ? 1 : -1;
        const title = document.getElementById('transaction-title');
        const amountInput = document.getElementById('transaction-amount');
        const itemInput = document.getElementById('transaction-item');
        const descInput = document.getElementById('transaction-desc');
        const dateInput = document.getElementById('transaction-date');
        const timeInput = document.getElementById('transaction-time');
        const categoryInput = document.getElementById('transaction-category');
        const subcategoryInput = document.getElementById('transaction-subcategory');
        const typeInput = document.getElementById('transaction-type');

        overlay.dataset.sign = String(sign);
        overlay.dataset.txId = tx.id;
        if (title) title.textContent = 'Edit Transaction';
        const amountVal = Number.isFinite(tx.amount) ? Math.abs(tx.amount) : parseFloat(String(tx.amount || '0').replace(/,/g, ''));
        if (amountInput) amountInput.value = this.formatAmount(amountVal);
        if (itemInput) itemInput.value = tx.item || '';
        if (descInput) descInput.value = tx.description || tx.desc || '';
        if (dateInput) dateInput.value = this.formatDate(tx.date);
        if (timeInput) timeInput.value = tx.time || '00:00';
        if (categoryInput && subcategoryInput) {
            this.initCategoryDropdowns(categoryInput, subcategoryInput, tx.category || '', tx.subcategory || '');
        }
        if (typeInput) typeInput.value = sign > 0 ? 'INCOME' : 'EXPENSE';
        this.updateTransactionTypeUI(sign);
        overlay.style.display = 'flex';
    },

    closeTransactionModal() {
        const overlay = document.getElementById('transaction-overlay');
        if (overlay) {
            delete overlay.dataset.txId;
            overlay.style.display = 'none';
        }
    },

    bindTransactionInputs() {
        const amountInput = document.getElementById('transaction-amount');
        if (!amountInput) return;
        const typeInput = document.getElementById('transaction-type');
        amountInput.addEventListener('blur', () => {
            const val = this.parseAmount(amountInput.value);
            amountInput.value = val === null ? this.formatAmount(0) : this.formatAmount(val);
        });
        amountInput.addEventListener('input', () => {
            amountInput.value = amountInput.value.replace(/[^\d.,]/g, '');
        });
        if (typeInput) {
            typeInput.addEventListener('change', () => {
                const sign = typeInput.value === 'INCOME' ? 1 : -1;
                const overlay = document.getElementById('transaction-overlay');
                if (overlay) overlay.dataset.sign = String(sign);
                this.updateTransactionTypeUI(sign);
            });
        }
        const inputIds = ['transaction-amount', 'transaction-item', 'transaction-desc', 'transaction-date', 'transaction-time', 'transaction-category', 'transaction-subcategory'];
        inputIds.forEach((id) => {
            const input = document.getElementById(id);
            if (!input) return;
            input.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                this.saveTransactionModal();
            });
        });
    },

    normalizeTimeInput(value) {
        if (!value) return '';
        const trimmed = String(value).trim();
        const ampmMatch = trimmed.match(/^(\d{1,2}):(\d{2})\s*([AaPp][Mm])$/);
        if (ampmMatch) {
            let hours = parseInt(ampmMatch[1], 10);
            const mins = parseInt(ampmMatch[2], 10);
            const isPM = ampmMatch[3].toLowerCase() === 'pm';
            if (isPM && hours < 12) hours += 12;
            if (!isPM && hours === 12) hours = 0;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        const match = trimmed.match(/^(\d{1,2}):(\d{2})$/);
        if (match) {
            const hours = Math.min(23, Math.max(0, parseInt(match[1], 10)));
            const mins = Math.min(59, Math.max(0, parseInt(match[2], 10)));
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        return '';
    },

    bindLedgerInteractions() {
        const container = document.getElementById('ledger-container');
        if (!container || container.dataset.bound === 'true') return;
        container.dataset.bound = 'true';
        container.onmousedown = (e) => this.handleMouseDown(e);
        container.oncontextmenu = (e) => this.handleContextMenu(e);
    },

    updateTransactionTypeUI(sign) {
        const signEl = document.getElementById('transaction-sign');
        if (!signEl) return;
        signEl.textContent = sign > 0 ? '+' : '-';
        signEl.style.opacity = '0.85';
    },

    bindInputEffects() {
        document.addEventListener('focusin', (e) => {
            const target = e.target;
            if (!(target instanceof HTMLElement)) return;
            const row = target.closest('.panel-section, .data-row, .meeting-panel');
            if (row) row.classList.add('active-input-row');
        });
        document.addEventListener('focusout', (e) => {
            const target = e.target;
            if (!(target instanceof HTMLElement)) return;
            const row = target.closest('.panel-section, .data-row, .meeting-panel');
            if (row) row.classList.remove('active-input-row');
            if (target.id === 'timeblock-start' || target.id === 'timeblock-end' || target.id === 'transaction-time') {
                const normalized = this.normalizeTimeInput(target.value);
                if (normalized) target.value = normalized;
            }
        });
        document.addEventListener('input', (e) => {
            this.triggerInputSpark(e);
        });
    },

    triggerInputSpark(e) {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        const x = e.clientX || target.getBoundingClientRect().right - 12;
        const y = e.clientY || target.getBoundingClientRect().top + 12;
        const spark = document.createElement('div');
        spark.className = 'input-spark';
        spark.style.left = `${x}px`;
        spark.style.top = `${y}px`;
        document.body.appendChild(spark);
        setTimeout(() => spark.remove(), 600);
    },

    pulseActiveInput() {
        const active = document.activeElement;
        if (!(active instanceof HTMLElement)) return;
        active.classList.remove('save-pulse');
        void active.offsetWidth;
        active.classList.add('save-pulse');
        setTimeout(() => active.classList.remove('save-pulse'), 800);
    },

    saveTransactionModal() {
        const overlay = document.getElementById('transaction-overlay');
        if (!overlay) return;
        const typeInput = document.getElementById('transaction-type');
        const sign = typeInput ? (typeInput.value === 'INCOME' ? 1 : -1) : parseInt(overlay.dataset.sign || '1', 10);
        const txId = overlay.dataset.txId || '';
        const amountInput = document.getElementById('transaction-amount');
        const itemInput = document.getElementById('transaction-item');
        const descInput = document.getElementById('transaction-desc');
        const dateInput = document.getElementById('transaction-date');
        const timeInput = document.getElementById('transaction-time');
        const categoryInput = document.getElementById('transaction-category');
        const subcategoryInput = document.getElementById('transaction-subcategory');

        const amountVal = amountInput ? this.parseAmount(amountInput.value) : null;
        if (!amountInput || amountVal === null) return;
        const item = itemInput && itemInput.value.trim() ? itemInput.value.trim() : '';
        const description = descInput && descInput.value.trim() ? descInput.value.trim() : '';
        const desc = item || description || (sign > 0 ? 'Income' : 'Expense');
        const date = dateInput ? this.formatDate(dateInput.value) : this.formatDate(new Date().toISOString().split('T')[0]);
        const time = timeInput ? timeInput.value : new Date().toTimeString().slice(0, 5);
        const category = categoryInput && categoryInput.value.trim() ? categoryInput.value.trim() : 'General';
        const subcategory = subcategoryInput && subcategoryInput.value.trim() ? subcategoryInput.value.trim() : '';

        if (txId) {
            const tx = this.transactions.find(item => item.id === txId);
            if (tx) {
                tx.desc = desc;
                tx.item = item;
                tx.description = description;
                tx.amount = sign * Math.abs(amountVal);
                tx.date = date;
                tx.time = time;
                tx.category = category;
                tx.subcategory = subcategory;
                void this.saveTransaction(tx);
                this.sortTransactions();
                this.renderTransactions();
                this.renderDay();
            }
        } else {
            this.addTransaction(desc, sign * Math.abs(amountVal), category, subcategory, date, time, '', item, description);
        }
        this.closeTransactionModal();
    },
commence() {
    this.isMeetingActive = !this.isMeetingActive;
    const btn = document.getElementById('commence-btn');
    
    if (this.isMeetingActive) {
        btn.innerText = "TERMINATE SESSION";
        btn.style.background = "rgba(255, 69, 58, 0.25)"; 
        btn.style.color = "rgba(255,255,255,0.9)";
        // Start recording time logic...
    } else {
        btn.innerText = "START";
        btn.style.background = "#FFFFFF";
        btn.style.color = "#000000";
        // Finalize transaction logic...
    }
}
    
};

// Global Execution Logic
setInterval(() => {
    const clock = document.getElementById('clock-display');
    if (clock) {
        const now = new Date();
        clock.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }
    // Update the red "Now" line on the ledger every minute
    if (new Date().getSeconds() === 0) ENGINE.updateTimeline();
}, 1000);

// Initialize the Engine on window load
window.onload = () => showLoginUI();

// Add this to your script to catch the end of a drag anywhere on the screen
window.addEventListener('mouseup', () => {
    if (ENGINE.isDragging) ENGINE.handleMouseUp();
});

// Auto-dismiss context menus on left click only
document.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    if (e.target.closest('#quick-create-menu') || e.target.closest('#block-context-menu')) return;
    if (ENGINE.hideQuickCreateMenu) ENGINE.hideQuickCreateMenu();
    if (ENGINE.hideBlockMenu) ENGINE.hideBlockMenu();
});
    
</script>

<!-- Modal Overlay - Centered Glass Panel -->
<div id="modal-overlay" oncontextmenu="event.preventDefault(); event.stopPropagation();">
    <div class="meeting-panel meeting-panel--editor" oncontextmenu="event.preventDefault(); event.stopPropagation();">
        <div class="meeting-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 id="modal-main-title" style="margin: 0; color: white; font-size: 20px; font-weight: 600;">NEW MEETING</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button id="edit-meeting-widgets-btn" onclick="ENGINE.openEditMeetingSettings()" aria-label="Edit Meeting widgets" style="background: transparent; border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); width: 32px; height: 32px; border-radius: 8px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">⚙</button>
                <button id="delete-event-btn" onclick="ENGINE.deleteCurrentEvent()" style="background: transparent; border: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.45); padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; cursor: pointer; display: none;">DELETE</button>
                <button onclick="ENGINE.closeModal()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer; transition: all 0.15s;">&times;</button>
            </div>
        </div>
        <div id="fixed-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 6px;"></div>
        <div id="dynamic-fields-container" class="meeting-panel-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; align-items: start; align-content: start;"></div>
        <div class="meeting-panel-footer" style="display: flex; gap: 12px; margin-top: 16px;">
            <button onclick="ENGINE.closeModal()" style="flex: 1; padding: 14px; background: transparent; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; color: rgba(255,255,255,0.45); font-weight: 600; cursor: pointer;">CANCEL</button>
            <button onclick="ENGINE.saveSession()" style="flex: 2; padding: 14px; background: var(--btn-accent-bg-strong); border: 1px solid var(--btn-accent-border); border-radius: 12px; color: var(--btn-accent-text); font-weight: 700; cursor: pointer;">SAVE</button>
        </div>
    </div>
</div>

<!-- Edit Meeting Widgets Settings Overlay -->
<div id="edit-meeting-settings-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); z-index: 1300; padding: 24px; flex-direction: column; justify-content: center; align-items: center;">
    <div class="meeting-panel" style="max-width: 480px; width: 100%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0; color:white; font-size: 18px; font-weight: 600;">Edit Meeting – Widgets</h2>
            <button onclick="ENGINE.closeEditMeetingSettings()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <p style="color: rgba(255,255,255,0.5); font-size: 11px; margin-bottom: 16px;">Default applies to new meetings. This meeting overrides when set.</p>
        <div id="edit-meeting-widgets-list" style="display:flex; flex-direction:column; gap: 12px;"></div>
    </div>
</div>

<!-- Settings Overlay -->
<div id="settings-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(16px); z-index: 1200; justify-content:center; align-items:center; padding: 40px;">
    <div class="meeting-panel" style="max-width: 820px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0; color:white; font-size: 20px; font-weight: 600;">Settings Registry</h2>
            <button onclick="ENGINE.closeSettings()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr; gap: 20px;">
            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">TEAMS</div>
                    <button onclick="ENGINE.addEntity('teams')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD TEAM</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-teams-name" placeholder="Team name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <input id="settings-teams-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div style="margin-bottom: 12px;">
                    <select id="settings-teams-project" class="subtle-select"></select>
                </div>
                <div id="settings-teams-profiles" style="display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; max-height: 140px; overflow-y: auto;"></div>
                <div id="settings-team-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">PROFILES</div>
                    <button onclick="ENGINE.addEntity('profiles')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD PROFILE</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-profiles-name" placeholder="Profile name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <input id="settings-profiles-email" placeholder="Email" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div style="margin-bottom: 12px;">
                    <input id="settings-profiles-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none; width: 100%;">
                </div>
                <div id="settings-profile-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">INSTITUTIONS</div>
                    <button onclick="ENGINE.addEntity('institutions')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD INSTITUTION</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-institutions-name" placeholder="Institution name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <input id="settings-institutions-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div id="settings-institution-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">PROJECTS</div>
                    <button onclick="ENGINE.addEntity('projects')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD PROJECT</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-projects-name" placeholder="Project name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <input id="settings-projects-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div id="settings-project-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">CATEGORIES</div>
                    <button onclick="ENGINE.addEntity('categories')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD CATEGORY</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-categories-name" placeholder="Category name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <input id="settings-categories-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div id="settings-category-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                    <div style="font-size: 12px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.6);">SUBCATEGORIES</div>
                    <button onclick="ENGINE.addEntity('subcategories')" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); padding:6px 12px; border-radius: 8px; font-size: 10px; font-weight: 700; cursor:pointer;">ADD SUBCATEGORY</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input id="settings-subcategories-name" placeholder="Subcategory name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                    <select id="settings-subcategories-category" class="subtle-select"></select>
                </div>
                <div style="margin-bottom: 12px;">
                    <input id="settings-subcategories-notes" placeholder="Notes (optional)" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
                </div>
                <div id="settings-subcategory-list" style="display:flex; flex-direction:column; gap: 8px;"></div>
            </div>

            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06);">
                <button onclick="ENGINE.logOut()" style="width: 100%; padding: 12px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 700; letter-spacing: 0.5px; cursor: pointer;">Log Out</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Entity Overlay -->
<div id="edit-entity-overlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(16px); z-index: 1300; justify-content:center; align-items:center; padding: 40px;">
    <div class="meeting-panel" style="max-width: 520px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 id="edit-entity-title" style="margin:0; color:white; font-size: 18px; font-weight: 600;">Edit</h2>
            <button onclick="ENGINE.closeEditEntity()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div style="display:flex; flex-direction:column; gap: 12px;">
            <input id="edit-entity-name" placeholder="Name" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
            <input id="edit-entity-email" placeholder="Email" style="display:none; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:10px; border-radius: 8px; font-size: 12px; outline:none;">
            <select id="edit-entity-project" class="subtle-select" style="display:none;"></select>
            <select id="edit-entity-category" class="subtle-select" style="display:none;"></select>
            <div id="edit-entity-profiles" style="display:none; flex-direction:column; gap:6px; max-height: 160px; overflow-y: auto;"></div>
            <textarea id="edit-entity-notes" placeholder="Notes" style="width: 100%; height: 100px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; color: white; outline: none; resize: none;"></textarea>
        </div>
        <div style="display:flex; gap: 12px; margin-top: 20px;">
            <button onclick="ENGINE.closeEditEntity()" style="flex: 1; padding: 12px; background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); border-radius: 12px; color: var(--btn-accent-text); font-weight: 600; cursor: pointer;">CANCEL</button>
            <button onclick="ENGINE.saveEditEntity()" style="flex: 1; padding: 12px; background: var(--btn-accent-bg-strong); border: 1px solid var(--btn-accent-border); border-radius: 12px; color: var(--btn-accent-text); font-weight: 700; cursor: pointer;">SAVE</button>
        </div>
    </div>
</div>

<!-- Transaction Overlay -->
<div id="transaction-overlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(16px); z-index: 1350; justify-content:center; align-items:center; padding: 40px;">
    <div class="meeting-panel" style="max-width: 520px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 id="transaction-title" style="margin:0; color:white; font-size: 18px; font-weight: 600;">Add Transaction</h2>
            <button onclick="ENGINE.closeTransactionModal()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div style="display:flex; flex-direction:column; gap: 12px;">
            <div style="display:grid; grid-template-columns: 1fr auto; gap: 10px;">
                <select id="transaction-type" class="subtle-select" style="font-size: 11px;">
                    <option value="EXPENSE">Expense</option>
                    <option value="INCOME">Income</option>
                </select>
                <div id="transaction-sign" style="min-width: 32px; height: 34px; display:flex; align-items:center; justify-content:center; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: rgba(255,255,255,0.7); font-weight: 800;">-</div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 0.6fr; gap: 8px;">
                <input id="transaction-item" placeholder="Item" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                <input id="transaction-desc" placeholder="Description" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                <input id="transaction-amount" type="text" placeholder="0.00" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input id="transaction-date" type="text" placeholder="YYYY-MM-DD" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
                <input id="transaction-time" type="text" placeholder="HH:MM" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color:white; padding:8px; border-radius: 8px; font-size: 11px; outline:none;">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <select id="transaction-category" class="subtle-select" style="font-size: 11px;"></select>
                <select id="transaction-subcategory" class="subtle-select" style="font-size: 11px;"></select>
            </div>
        </div>
        <div style="display:flex; gap: 12px; margin-top: 20px;">
            <button onclick="ENGINE.closeTransactionModal()" style="flex: 1; padding: 12px; background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); border-radius: 12px; color: var(--btn-accent-text); font-weight: 600; cursor: pointer;">CANCEL</button>
            <button onclick="ENGINE.saveTransactionModal()" style="flex: 1; padding: 12px; background: var(--btn-accent-bg-strong); border: 1px solid var(--btn-accent-border); border-radius: 12px; color: var(--btn-accent-text); font-weight: 700; cursor: pointer;">SAVE</button>
        </div>
    </div>
</div>

<!-- Audit Overlay -->
<div id="audit-overlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(16px); z-index: 1400; justify-content:center; align-items:center; padding: 40px;">
    <div class="meeting-panel" style="max-width: 720px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0; color:white; font-size: 18px; font-weight: 600;">Audit Ledger</h2>
            <button onclick="ENGINE.closeAudit()" style="background: var(--btn-accent-bg); border: 1px solid var(--btn-accent-border); color: var(--btn-accent-text); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div id="audit-transaction-list" style="display:flex; flex-direction:column; gap: 10px; max-height: 60vh; overflow-y: auto;"></div>
    </div>
</div>

</body>

</html>
