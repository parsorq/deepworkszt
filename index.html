<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/sf-pro-display">
<style>
    /* --- 1. SYSTEM CORE: Variables & Global Resets --- */
    :root {
        --bg-canvas: #000000; 
        --panel-bg: rgba(255, 255, 255, 0.05); 
        --border: rgba(255, 255, 255, 0.1); 
        --text-main: #ffffff; 
        --text-dim: #86868b; 
        --accent-blue: #007AFF; 
    }

    * {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif !important;
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
    }

body { 
    margin: 0; 
    background: var(--bg-canvas); 
    background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #000000 100%);
    /* Removed flex centering to prevent layout jitter */
    height: 100vh; 
    overflow: hidden; 
}

    #ledger-container::-webkit-scrollbar {
        width: 6px;
    }
    #ledger-container::-webkit-scrollbar-track {
        background: transparent;
    }
    #ledger-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    #ledger-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

/* --- 2. SHELL ARCHITECTURE: Fixed Grid Layout --- */
#tablet-shell { 
    display: grid; 
    grid-template-columns: 1fr 340px; /* Force the 2-column split */
    grid-template-rows: 100%;
    width: 98vw; 
    height: 95vh; 
    background: rgba(10, 10, 12, 0.98); 
    border-radius: 36px; 
    border: 1px solid rgba(255, 255, 255, 0.08); 
    overflow: hidden;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 50px 100px rgba(0,0,0,0.8);
    z-index: 1;
}

#content-area { 
    display: flex; 
    flex-direction: column; 
    padding: 40px; 
    overflow: hidden; 
    border-right: 1px solid rgba(255, 255, 255, 0.05);
    position: relative; /* Anchor for ledger items */
}

#engine-sidebar {
    height: 100%;
    background: rgba(255, 255, 255, 0.01);
    padding: 40px 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    overflow-y: auto;
    border-left: 1px solid rgba(255, 255, 255, 0.08); /* Visual separation */
}

    /* --- 3. NAVIGATION & IDENTITY: Brand and Controls --- */
    .header-top { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 24px; 
    }

    .brand, h1, #day-title {
        color: #ffffff !important;
    }

    .nav-tabs { 
        display: flex; 
        background: rgba(255, 255, 255, 0.08); 
        border-radius: 10px; 
        margin-bottom: 30px; 
        align-self: flex-start; 
        padding: 2px; 
        border: 0.5px solid rgba(255, 255, 255, 0.1);
    }

    .tab { 
        padding: 8px 18px; 
        font-size: 13px; 
        font-weight: 500; 
        cursor: pointer; 
        border-radius: 8px; 
        color: rgba(255, 255, 255, 0.5); 
        transition: 0.2s;
    }

    .tab.active { 
        background: rgba(255, 255, 255, 0.15); 
        color: #ffffff; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }

    .config-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 6px;
        font-family: "SF Mono", monospace;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.6);
        transition: all 0.2s ease;
        text-transform: uppercase;
    }

    .config-button:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #ffffff;
    }

    /* --- 4. DAILY LEDGER ARCHITECTURE: Grid & Interactive Blocks --- */
    #ledger-container {
        user-select: none;
        -webkit-user-select: none;
        overflow-y: auto; 
        flex: 1; 
        padding: 20px 20px 20px 60px; 
        position: relative;
    }

    .hour-row {
        display: flex;
        height: 100px; 
        border: none !important;
        background: transparent !important;
        position: relative;
        align-items: flex-start;
        cursor: crosshair;
    }

    .hour-label {
        color: rgba(255, 255, 255, 0.5) !important;
        font-family: 'SF Mono', monospace;
        font-size: 16px; 
        font-weight: 600;
        z-index: 2;
        padding-top: 10px;
        width: 60px;
    }

.block-space {
    position: absolute;
    left: 100px; /* Aligned with grid */
    right: 20px;  /* Pushed to the far right of the pane */
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%) !important;
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border-radius: 6px; 
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    display: flex;
    flex-direction: row; /* CRITICAL: Side-by-side columns */
    justify-content: space-between;
    align-items: stretch;
    padding: 0 !important; /* Managed by internal columns now */
    box-sizing: border-box;
    z-index: 30 !important;
    pointer-events: all !important; 
    cursor: pointer;
    overflow: hidden; /* Keeps the "receipt" column contained */
    transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s ease;
}

.block-space:hover {
    border-color: rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.block-space:hover .block-delete-btn {
    opacity: 1;
}

.block-delete-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    background: rgba(255, 59, 48, 0.9);
    border: none;
    border-radius: 4px;
    color: white;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: all;
}

.block-delete-btn:hover {
    background: #FF453A;
}

/* Two-column ledger layout */
.ledger-grid {
    display: grid;
    grid-template-columns: 1fr 200px;
    gap: 0;
    height: 100%;
}

.ledger-events-col {
    position: relative;
    border-right: 1px solid rgba(255, 255, 255, 0.05);
}

.ledger-transactions-col {
    position: relative;
    padding-left: 12px;
}

.transaction-marker {
    position: absolute;
    right: 0;
    left: 12px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    border-left: 2px solid transparent;
}

.transaction-marker.income {
    border-left-color: rgba(50, 215, 75, 0.5);
}

.transaction-marker.expense {
    border-left-color: rgba(255, 59, 48, 0.5);
}

    .type-pill {
        font-size: 9px;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3) !important;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
    }

    .type-pill-active {
        background: var(--pill-color) !important;
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .finance-meta-outer {
        position: absolute;
        right: 25px; 
        width: 150px;
        text-align: right;
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 13px;
        z-index: 10;
        pointer-events: none;
    }

    #time-now-line {
        position: absolute;
        left: 80px;
        right: 20px;
        height: 2px;
        background: linear-gradient(90deg, #ff3b30 0%, #ff3b30 100%);
        box-shadow: 0 0 12px rgba(255, 59, 48, 0.5);
        z-index: 100;
        pointer-events: none;
        transition: top 1s linear;
    }

    #time-now-line::before {
        content: '';
        position: absolute;
        left: -6px;
        top: -4px;
        width: 10px;
        height: 10px;
        background: #ff3b30;
        border-radius: 50%;
        box-shadow: 0 0 8px rgba(255, 59, 48, 0.6);
    }

.ghost-selection {
    position: absolute;
    left: 80px;
    right: 12px;
    background: rgba(0, 122, 255, 0.06);
    border-left: 3px solid #007AFF;
    border-radius: 6px;
    z-index: 50;
    pointer-events: none;
}

    /* --- 5. ENGINE SIDEBAR: Real-time Context & Focus --- */
    #engine-sidebar {
        background: transparent;
        border-left: 1px solid rgba(255, 255, 255, 0.08);
        padding: 40px 24px;
    }

    .timer-card {
        background: rgba(255, 255, 255, 0.03); 
        backdrop-filter: blur(30px) saturate(150%);
        -webkit-backdrop-filter: blur(30px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 28px;
        padding: 30px 20px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .timer-val { 
        color: #ffffff !important; 
        font-size: 38px; 
        margin: 15px 0;
    }

    .intent-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: 20px;
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
        margin-top: 12px;
    }

#graph-stage {
    flex: none; /* Don't let flexbox squish it */
    height: 180px; /* Fixed height for stability */
    background: rgba(255, 255, 255, 0.01) !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    border-radius: 20px;
    position: relative; /* REQUIRED to anchor the label */
    overflow: hidden;
    background-image: radial-gradient(rgba(0, 122, 255, 0.1) 1px, transparent 0) !important;
    background-size: 24px 24px !important;
    margin-top: 20px;
}

/* Add this new rule to your CSS to center the label inside the stage */
#graph-stage span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'SF Mono', monospace;
    font-size: 10px;
    color: var(--accent-blue);
    letter-spacing: 3px;
    text-transform: uppercase;
    opacity: 0.5;
    pointer-events: none;
}

    /* --- 6. MODAL SYSTEM: Centered Glass Panel --- */
#modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.meeting-panel {
    background: rgba(30, 30, 32, 0.85) !important;
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 28px;
    padding: 32px;
    width: 100%;
    max-width: 680px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset;
    animation: modalSlideIn 0.3s cubic-bezier(0.2, 0, 0, 1);
}

@keyframes modalSlideIn {
    from { transform: scale(0.95) translateY(20px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
}

/* Date Navigation */
.date-nav {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-nav-btn {
    background: rgba(255,255,255,0.08);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    color: rgba(255,255,255,0.6);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.date-nav-btn:hover {
    background: rgba(255,255,255,0.15);
    color: white;
}

.date-nav-btn:active {
    transform: scale(0.95);
}

.date-display-main {
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    min-width: 100px;
    text-align: center;
}

    .panel-section {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .meeting-panel textarea {
        width: 100%; height: 120px;
        background: rgba(255, 255, 255, 0.02) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 14px; padding: 18px; color: #ffffff;
        outline: none; resize: none; transition: all 0.3s ease;
        box-sizing: border-box;
    }

    .meeting-panel textarea:focus {
        background: rgba(255, 255, 255, 0.05) !important;
        border-color: var(--accent-blue) !important;
    }

    /* --- 7. UTILITIES & TYPOGRAPHY: Global Overrides --- */
    h1, .brand, .tab, .session-label, .p-label, .timer-val, h2 {
        font-weight: 700 !important;
        letter-spacing: -0.02em;
    }

    .p-label, label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 10px;
    opacity: 0.5;
    }

    .modal-title-input {
    caret-color: var(--accent-blue);
    }

    .modal-title-input::placeholder {
        color: rgba(255, 255, 255, 0.15);
    }

    .session-label {
        font-size: 18px !important;
    }

    .btn-focus { 
        width: 100%; padding: 16px; border-radius: 12px; border: none; 
        background: var(--text-main); color: #000; font-weight: 700; 
        cursor: pointer; font-size: 12px; transition: opacity 0.2s;
    }

    .btn-focus:active { opacity: 0.8; }

    #monthly-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }

    @keyframes modalScale {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

/* Container to keep squircle and menu aligned */
.type-lockup-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* The Menu: Positioned below with a vertical stack */
#type-selector-expanded {
    display: none; 
    position: absolute !important;
    top: 50px; /* Sits exactly below the 44px squircle */
    left: 0 !important;
    flex-direction: column; /* Stack vertically */
    width: 120px;
    background: rgba(28, 28, 30, 0.98) !important;
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 14px;
    padding: 6px;
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
}

/* List items inside the menu */
.initial-opt {
    width: 100%;
    padding: 10px 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    border-radius: 8px;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.5);
    transition: all 0.2s;
}

.initial-opt:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}


/* Note Popover (Google Sheets style) */
.preread-note-overlay {
    position: absolute;
    background: #1c1c1e;
    border: 1px solid var(--accent-blue);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    z-index: 3000;
    width: 300px;
    display: none;
}

/* Agenda List Styling */
.agenda-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

/* Cash Flow Grid */
.cashflow-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 15px;
}

.cash-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    font-size: 10px;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
}

/* Real-time Ticker */
#burn-ticker {
    font-family: 'SF Mono', monospace;
    color: #32D74B;
    font-size: 14px;
    background: rgba(50, 215, 75, 0.1);
    padding: 4px 10px;
    border-radius: 6px;
}


/* --- Agenda Scrolling System --- */
    .agenda-scroll-container {
        max-height: 288px; /* Approx 48px * 6 items */
        overflow-y: auto;
        padding-right: 8px;
        margin-bottom: 12px;
    }

    /* Match the Ledger scrollbar style */
    .agenda-scroll-container::-webkit-scrollbar { width: 4px; }
    .agenda-scroll-container::-webkit-scrollbar-track { background: transparent; }
    .agenda-scroll-container::-webkit-scrollbar-thumb { 
        background: rgba(255, 255, 255, 0.1); 
        border-radius: 10px; 
    }

    .agenda-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }

    .agenda-row:hover { background: rgba(255, 255, 255, 0.02); }

    .agenda-number {
        font-family: 'SF Mono', monospace;
        font-size: 10px;
        color: var(--accent-blue);
        opacity: 0.6;
        width: 20px;
    }

    .agenda-input {
        background: transparent;
        border: none;
        color: white;
        font-size: 13px;
        width: 100%;
        outline: none;
    }

    .add-point-btn {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.4);
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
    }

    .add-point-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent-blue);
        color: white;
    }
    

/* Ensure only the active tab is visible and takes up the full viewport space */
.view-content { 
    display: none; 
    height: 100%; 
    flex-direction: column; 
    overflow: hidden; 
    padding-bottom: 20px;
}

.view-content.active { 
    display: flex !important; 
    flex-direction: column;
    height: 100%;
}

/* This is the "kill switch" for inactive views */
.view-content:not(.active) {
    display: none !important;
}

/* Prevents the viewport from becoming a scroll-pit for the whole page */
#viewport {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden; 
    min-height: 0; 
}

#weekly-columns, #monthly-grid, #yearly-grid {
    overflow-y: auto;
    padding-right: 10px;
    scrollbar-width: thin;
}

/* Breathing Colons */
.colon-breathe {
    animation: breathe 2s infinite ease-in-out;
}

@keyframes breathe {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
}

/* Creation Animation (Top to Bottom Wipe) */
.block-creation-anim {
    animation: wipeDown 0.5s cubic-bezier(0.2, 0, 0, 1) forwards;
    transform-origin: top;
}

@keyframes wipeDown {
    from { transform: scaleY(0); opacity: 0; }
    to { transform: scaleY(1); opacity: 1; }
}

/* Subtle Financial Buttons */
.tx-btn {
    flex: 1;
    height: 44px;
    background: transparent;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tx-neg { border: 1px solid rgba(255, 69, 58, 0.2); color: rgba(255, 69, 58, 0.5); }
.tx-neg:hover { background: rgba(255, 69, 58, 0.1); color: #FF453A; border-color: #FF453A; }

.tx-pos { border: 1px solid rgba(50, 215, 75, 0.2); color: rgba(50, 215, 75, 0.5); }
.tx-pos:hover { background: rgba(50, 215, 75, 0.1); color: #32D74B; border-color: #32D74B; }

/* Subtle Select Dropdown */
.subtle-select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    outline: none;
    appearance: none;
}
    

</style>


</head>

<body class="mode-architect lens-both">
<div id="tablet-shell">
    <div id="content-area">
        <div class="header-top">
            <div class="brand">DEEPWORKSZT</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="config-button" id="cfg-level" onclick="ENGINE.cycle('scope')">LEVEL: INDIVIDUAL</button>
                <button class="config-button" id="cfg-role" onclick="ENGINE.cycle('role')">ROLE: ARCHITECT</button>
                <button class="config-button" id="cfg-lens" onclick="ENGINE.cycle('lens')">LENS: BOTH</button>
            </div>
        </div>

        <nav class="nav-tabs">
            <div class="tab" onclick="ENGINE.switchTab('year', this)">Yearly Audit</div>
            <div class="tab" onclick="ENGINE.switchTab('month', this)">Monthly Ledger</div>
            <div class="tab" onclick="ENGINE.switchTab('week', this)">Weekly Tactical</div>
            <div class="tab active" onclick="ENGINE.switchTab('day', this)">Daily Ledger</div>
        </nav>

<div id="viewport">
    <div id="day-view" class="view-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 id="day-title" style="margin: 0;">Daily Ledger</h1>
            <div class="date-nav">
                <button class="date-nav-btn" onclick="ENGINE.navigateDate(-1)">‹</button>
                <span id="current-date-display" class="date-display-main">2026-01-30</span>
                <button class="date-nav-btn" onclick="ENGINE.navigateDate(1)">›</button>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; height: calc(100% - 60px); gap: 16px;">
            <div id="ledger-wrapper" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
                <div id="ledger-container" 
                     onmousedown="ENGINE.handleMouseDown(event)" 
                     style="overflow-y: auto; flex: 1; padding: 20px 20px 20px 60px; position: relative; cursor: crosshair;">
                </div>
            </div>
            <div id="graph-stage" style="height: 180px; flex-shrink: 0;">
                <span>Audit Lens Stage</span>
            </div>
        </div>
    </div>

    <div id="week-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Weekly Tactical</h1>
            <div style="font-family:'SF Mono'; font-size: 12px; color: #007AFF;">WEEK 05 / 2026</div>
        </div>
        <div id="weekly-columns" style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 10px; flex: 1; overflow-y: auto;"></div>
    </div>

    <div id="month-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Monthly Analysis</h1>
            <div id="month-burn-total" style="font-family:'SF Mono'; font-weight:700; color:#32D74B;">TOTAL: $0.00</div>
        </div>
        <div id="monthly-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; flex: 1; overflow-y: auto;"></div>
    </div>

    <div id="year-view" class="view-content">
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px;">
            <h1>Yearly Audit</h1>
            <div style="font-family:'SF Mono'; font-size: 12px; color: var(--text-dim);">FY_2026_STRATEGY</div>
        </div>
        <div id="yearly-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; flex: 1; overflow-y: auto;"></div>
    </div>
</div>
        
    </div>

<aside id="engine-sidebar" style="background: rgba(10,10,10,0.8); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; padding: 30px 20px; position: relative;">

    <div style="margin-bottom: 40px; text-align: center;">
        <div id="clock-display" style="font-size: 42px; font-weight: 200; color: white; letter-spacing: -1px; opacity: 0.9;">16:07:22</div>
        <div id="date-display" style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 5px; letter-spacing: 1px;">
            03 FEB 2026 // SYSTEM_ACTIVE
        </div>
    </div>

    <div style="margin-bottom: 30px;">
        <label class="p-label" style="font-size: 9px; opacity: 0.4; margin-bottom: 8px; display: block;">STRATEGIC CONTEXT</label>
        <textarea id="sidebar-notes" 
            style="width: 100%; height: 100px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; padding: 12px; font-size: 13px; outline: none; resize: none;" 
            placeholder="Capture thoughts..."></textarea>
    </div>

    <div style="margin-bottom: 40px;">
        <button id="commence-btn" class="btn-focus" style="width: 100%; height: 50px; background: white; color: black; font-weight: 700; border-radius: 10px; margin-bottom: 15px; border: none; cursor: pointer;" onclick="ENGINE.commence()">START</button>
        
        <div class="search-container" style="position: relative;">
            <input type="text" id="project-search" 
                style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); height: 40px; border-radius: 8px; padding: 0 15px; color: white; font-size: 12px;" 
                placeholder="Search Projects..."
                onkeyup="ENGINE.filterProjects(this.value)">
            </div>

        <div id="active-intent-panel" style="margin-top: 15px; padding: 15px; background: rgba(0,122,255,0.05); border-left: 2px solid #007AFF; border-radius: 4px;">
            <div style="font-size: 10px; color: #007AFF; font-weight: 800; margin-bottom: 4px;">ACTIVE_INTENT</div>
            <div id="active-intent-label" style="font-size: 13px; color: white; font-weight: 500;">Infrastructure Refactoring</div>
        </div>
    </div>

    <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="ENGINE.quickTx(-1)" style="flex: 1; height: 44px; background: rgba(255,69,58,0.1); border: 1px solid #FF453A; color: #FF453A; border-radius: 8px; font-size: 18px;">-</button>
            <button onclick="ENGINE.quickTx(1)" style="flex: 1; height: 44px; background: rgba(50,215,75,0.1); border: 1px solid #32D74B; color: #32D74B; border-radius: 8px; font-size: 18px;">+</button>
        </div>

        <div id="recent-transactions" style="display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto;">
        </div>

        <button onclick="ENGINE.openAudit()" style="width: 100%; margin-top: 20px; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); padding: 10px; border-radius: 6px; font-size: 10px; font-weight: 800; letter-spacing: 1px;">AUDIT LEDGER</button>
    </div>
</aside>
</div>

<script>
const GOOGLE_CLIENT_ID = '199336032000-71cs5iokgfg8ondge7orb4e1brjv7lpi.apps.googleusercontent.com';
const MASTER_REGISTRY_SHEET_ID = '1SM8gIhluzuNX6HNRgZ149EBUypBq7v9ve8m5gTw8vg8';
const ENGINE_USER_FILE_NAME = 'ENGINE_USER_DATA_V1';
const GOOGLE_SCOPES = [
    'https://www.googleapis.com/auth/drive.file',
    'https://www.googleapis.com/auth/drive.metadata.readonly',
    'https://www.googleapis.com/auth/spreadsheets',
    'openid',
    'email',
    'profile'
].join(' ');
const GOOGLE_DISCOVERY_DOCS = [
    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
    'https://sheets.googleapis.com/$discovery/rest?version=v4'
];

let googleTokenClient = null;
let googleAccessToken = null;
let googleReadyPromise = null;
let loginOverlay = null;

function loadGoogleScript(src) {
    return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
            const isApi = src.includes('apis.google.com');
            const isGis = src.includes('accounts.google.com');
            if ((isApi && window.gapi) || (isGis && window.google)) {
                resolve();
                return;
            }
            existing.addEventListener('load', resolve, { once: true });
            existing.addEventListener('error', reject, { once: true });
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.defer = true;
        script.onload = () => {
            script.dataset.loaded = 'true';
            resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function ensureGoogleReady() {
    if (googleReadyPromise) return googleReadyPromise;
    googleReadyPromise = Promise.all([
        loadGoogleScript('https://apis.google.com/js/api.js').then(() => {
            return new Promise((resolve) => {
                gapi.load('client', async () => {
                    await gapi.client.init({ discoveryDocs: GOOGLE_DISCOVERY_DOCS });
                    resolve();
                });
            });
        }),
        loadGoogleScript('https://accounts.google.com/gsi/client').then(() => {
            googleTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: () => {}
            });
        })
    ]);
    return googleReadyPromise;
}

function setLoginStatus(message, isError = false) {
    const status = document.getElementById('engine-login-status');
    if (!status) return;
    status.textContent = message;
    status.style.color = isError ? '#ff453a' : 'rgba(255,255,255,0.7)';
}

async function fetchUserProfile() {
    const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: `Bearer ${googleAccessToken}` }
    });
    if (!res.ok) {
        throw new Error('Unable to load user profile.');
    }
    return res.json();
}

async function validateMasterRegistry(email) {
    const range = 'A:Z';
    const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: MASTER_REGISTRY_SHEET_ID,
        range
    });
    const rows = res.result.values || [];
    const target = email.trim().toLowerCase();
    return rows.some((row) =>
        row.some((cell) => String(cell || '').trim().toLowerCase() === target)
    );
}

async function handleLogin() {
    await ensureGoogleReady();
    return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
            reject(new Error('Google sign-in timed out. Check popup blockers or privacy settings.'));
        }, 15000);
        googleTokenClient.callback = async (response) => {
            clearTimeout(timeoutId);
            if (response.error) {
                reject(new Error('Google sign-in failed.'));
                return;
            }
            googleAccessToken = response.access_token;
            gapi.client.setToken({ access_token: googleAccessToken });
            try {
                const profile = await fetchUserProfile();
                const allowed = await validateMasterRegistry(profile.email);
                if (!allowed) {
                    reject(new Error('Access denied by Master Registry.'));
                    return;
                }
                ENGINE.userEmail = profile.email;
                await ENGINE.init();
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        googleTokenClient.requestAccessToken({ prompt: 'consent' });
    });
}

function showLoginUI() {
    if (document.getElementById('engine-login-overlay')) return;
    loginOverlay = document.createElement('div');
    loginOverlay.id = 'engine-login-overlay';
    loginOverlay.style.cssText = `
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.65);
        z-index: 2000;
        backdrop-filter: blur(12px);
    `;
    loginOverlay.innerHTML = `
        <div style="width: 100%; max-width: 420px; background: rgba(20,20,24,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 28px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.6);">
            <div style="font-size: 14px; letter-spacing: 2px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 10px;">SECURE ACCESS</div>
            <div style="font-size: 22px; color: #ffffff; font-weight: 700; margin-bottom: 10px;">Authenticate with Google</div>
            <div id="engine-login-status" style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 20px;">Sign in to sync with your Sheets ledger.</div>
            <button id="engine-login-btn" style="width: 100%; padding: 12px 16px; background: #007AFF; border: none; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer;">Sign in</button>
        </div>
    `;
    document.body.appendChild(loginOverlay);

    const btn = document.getElementById('engine-login-btn');
    btn.disabled = true;
    btn.style.opacity = '0.6';
    setLoginStatus('Loading Google services...');
    ensureGoogleReady().then(() => {
        btn.disabled = false;
        btn.style.opacity = '1';
        setLoginStatus('Sign in to sync with your Sheets ledger.');
    }).catch(() => {
        setLoginStatus('Unable to load Google services. Check blockers or network.', true);
    });
    btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        setLoginStatus('Connecting to Google...');
        try {
            await handleLogin();
            loginOverlay.remove();
        } catch (err) {
            setLoginStatus(err.message || 'Login failed.', true);
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    });
}

const ENGINE = {
    role: 'ARCHITECT',
    lens: 'BOTH',
    scope: 'INDIVIDUAL',
    activeType: 'MEETING',
    activeTypeContext: { isRemote: true },
    rates: { INDIVIDUAL: 150, TEAM: 1200, INSTITUTION: 8500 },
    selectedDate: new Date().toISOString().split('T')[0],
    currentEventIdx: null, // Track which event is being edited

    db: {},
    transactions: [],
    userEmail: null,
    userSheetId: null,
    sheetInfo: null,
    metaSaveTimer: null,
    sheetNames: {
        events: 'Events',
        transactions: 'Transactions',
        meta: 'Meta'
    },

    isDragging: false,
    dragStartH: null,
    dragEndH: null,
    meetingStartTime: null,
    burnRatePerSecond: 0,
    notesHistory: [],
    activeBurnRate: 150,
    currentNet: 23550.00,
    isMeetingActive: false,
    GRID_TOP_OFFSET: 0,
    HOUR_HEIGHT: 100,
    nextEventId: 100, // For generating unique IDs


async init() {
    await this.loadData();
    this.injectStyles();
    this.updateDateDisplay();
    this.render();
    this.renderTransactions();
    this.updatePanelContext();
    this.initFinancialPulse();
    this.startTimelineUpdater();

    // Global listeners for smooth drag
    window.addEventListener('mousemove', (e) => this.handleMouseMove(e));
    window.addEventListener('mouseup', () => this.handleMouseUp());

    // Modal close on Esc key
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('modal-overlay');
            if (modal && modal.style.display === 'flex') {
                this.closeModal();
            }
        }
    });

    // Modal close on click outside
    const modal = document.getElementById('modal-overlay');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeModal();
            }
        });
    }

    // Initial timeline position
    setTimeout(() => this.updateTimeline(true), 100);
},

// Date Navigation
navigateDate(delta) {
    const current = new Date(this.selectedDate);
    current.setDate(current.getDate() + delta);
    this.selectedDate = current.toISOString().split('T')[0];
    this.updateDateDisplay();
    this.renderDay();
},

updateDateDisplay() {
    const el = document.getElementById('current-date-display');
    if (el) el.textContent = this.selectedDate;
},

goToToday() {
    this.selectedDate = new Date().toISOString().split('T')[0];
    this.updateDateDisplay();
    this.renderDay();
    this.updateTimeline(true);
},

// Persistent red line updater
startTimelineUpdater() {
    // Update every second for smooth movement
    setInterval(() => {
        this.updateTimeline(false);
    }, 1000);
},

// Delete event functionality
async deleteCurrentEvent() {
    if (this.currentEventIdx === null) return;

    const events = this.db[this.selectedDate];
    if (!events || !events[this.currentEventIdx]) return;

    const [removed] = events.splice(this.currentEventIdx, 1);
    if (events.length === 0) delete this.db[this.selectedDate];

    if (removed && removed.id) {
        await this.deleteEventById(removed.id);
    }

    this.closeModal();
    this.renderDay();
},

// Generate unique event ID
generateEventId() {
    return `evt-${Date.now()}-${this.nextEventId++}`;
},

// Render recent transactions in sidebar
renderTransactions() {
    const container = document.getElementById('recent-transactions');
    if (!container) return;

    const recentTx = this.transactions.slice(0, 5);
    container.innerHTML = recentTx.map(tx => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(255,255,255,0.03); border-radius: 6px;">
            <div>
                <div style="font-size: 11px; color: white; font-weight: 500;">${tx.desc}</div>
                <div style="font-size: 9px; color: rgba(255,255,255,0.4); font-family: 'SF Mono';">${tx.date}</div>
            </div>
            <div style="font-family: 'SF Mono'; font-size: 12px; font-weight: 600; color: ${tx.amount >= 0 ? '#32D74B' : '#FF453A'};">
                ${tx.amount >= 0 ? '+' : ''}${tx.amount.toFixed(2)}
            </div>
        </div>
    `).join('');
},

// Add a new transaction
addTransaction(desc, amount, category = 'General') {
    const now = new Date();
    const tx = {
        id: `tx-${Date.now()}`,
        date: now.toISOString().split('T')[0],
        time: now.toTimeString().slice(0, 5),
        desc,
        amount: parseFloat(amount),
        category
    };
    this.transactions.unshift(tx);
    this.currentNet += tx.amount;
    void this.saveTransaction(tx);
    this.renderTransactions();
    return tx;
},

// Quick transaction buttons
quickTx(sign) {
    const amount = prompt(`Enter ${sign > 0 ? 'income' : 'expense'} amount:`);
    if (!amount || isNaN(parseFloat(amount))) return;

    const desc = prompt('Description:') || (sign > 0 ? 'Income' : 'Expense');
    this.addTransaction(desc, sign * Math.abs(parseFloat(amount)));
},

updateLifeClock() {
    const now = new Date();
    const blocks = this.db[this.selectedDate] || [];
    
    // Sum allocated time from blocks (ms)
    const allocatedMs = blocks.reduce((acc, b) => acc + (b.end - b.start) * 3600000, 0);
    
    // Current time in ms since start of day
    const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const currentTimeMs = now.getTime() - dayStart;
    
    // Available Life = Current Time - Used Time
    const lifeClockMs = Math.max(0, currentTimeMs - allocatedMs);
    
    // Formatting
    const hrs = Math.floor(lifeClockMs / 3600000).toString().padStart(2, '0');
    const mins = Math.floor((lifeClockMs % 3600000) / 60000).toString().padStart(2, '0');
    const secs = Math.floor((lifeClockMs % 60000) / 1000).toString().padStart(2, '0');

    const clockEl = document.getElementById('clock-display');
    if (clockEl) {
        // Toggle breathing class on colons if session is active
        const colonClass = this.isMeetingActive ? 'class="colon-breathe"' : '';
        clockEl.innerHTML = `${hrs}<span ${colonClass}>:</span>${mins}<span ${colonClass}>:</span>${secs}`;
    }
},

    
    
initFinancialPulse() {
    // 1. Prevent multiple intervals from running simultaneously
    if (this.fiscalInterval) clearInterval(this.fiscalInterval);

    // 2. Inject Styles safely (singleton pattern)
    if (!document.getElementById('engine-pulse-styles')) {
        const style = document.createElement('style');
        style.id = 'engine-pulse-styles';
        style.innerHTML = `
            @keyframes pulse-red {
                0%, 100% { color: #32D74B; opacity: 1; }
                50% { color: #ff453a; opacity: 0.7; }
            }
            .burning { animation: pulse-red 1.5s ease-in-out infinite; }
            .progress-line { 
                position: absolute; bottom: 0; left: 0; height: 4px; 
                background: #007AFF; transition: width 1s linear; 
                box-shadow: 0 0 10px rgba(0,122,255,0.5);
            }
        `;
        document.head.appendChild(style);
    }

    // 3. Set up the execution loop
    this.fiscalInterval = setInterval(() => {
        if (!this.isMeetingActive) {
            const sideBurn = document.getElementById('sidebar-burn');
            if (sideBurn) sideBurn.classList.remove('burning');
            return;
        }

        const totalBudget = 25000;
        const burnPerSec = this.activeBurnRate / 3600;
        
        // Update Internal State
        this.currentNet -= burnPerSec;

        // --- DOM UPDATES ---

        // A. Update Sidebar Text & Animation
        const sideBurn = document.getElementById('sidebar-burn');
        if (sideBurn) {
            sideBurn.innerText = `BURN: $${burnPerSec.toFixed(4)}/SEC`;
            sideBurn.classList.add('burning');
        }

        // B. Update Graph Stage (The Audit Lens)
        const stage = document.getElementById('graph-stage');
        if (stage) {
            const percent = (this.currentNet / totalBudget) * 100;
            
            // Update or Create the progress line
            let line = stage.querySelector('.progress-line');
            if (!line) {
                line = document.createElement('div');
                line.className = 'progress-line';
                stage.appendChild(line);
            }
            line.style.width = `${percent}%`;

            // Update the Label
            const label = stage.querySelector('span');
            if (label) label.innerText = `FISCAL_STABILITY: ${percent.toFixed(2)}%`;
        }

        // C. Update Ledger Display (If viewing the Ledger)
        const netDisplay = document.getElementById('net-remaining-display');
        if (netDisplay) {
            netDisplay.innerText = `$${this.currentNet.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        } else {
            // If we are in another tab, update the sidebar's net display instead
            const sideNet = document.getElementById('sidebar-net-total');
            if (sideNet) sideNet.innerText = `$${Math.floor(this.currentNet).toLocaleString()}`;
        }

        // 4. Auto-save meta periodically without spamming the API
        if (Math.floor(Date.now() / 1000) % 10 === 0) {
            this.queueMetaSave();
        }

    }, 1000);
},

setBurnGear(val) {
    this.activeBurnRate = parseFloat(val);
},

handleMouseDown(e) {
    // Ignore if clicking delete button
    if (e.target.closest('.block-delete-btn')) return;

    // If we click a block directly, handle it as a block click
    const block = e.target.closest('.block-space');
    if (block) {
        e.preventDefault();
        e.stopPropagation();
        const idx = parseInt(block.dataset.blockIdx, 10);
        this.openMeeting(idx);
        return;
    }

    // Only start drag on left mouse button in events column
    if (e.button !== 0) return;
    const eventsCol = e.target.closest('.ledger-events-col') || e.target.closest('#ledger-container');
    if (!eventsCol) return;

    const container = document.getElementById('ledger-container');
    const rect = container.getBoundingClientRect();
    const scrollTop = container.scrollTop;
    const offsetY = e.clientY - rect.top + scrollTop;

    // Calculate hour position
    const rawH = offsetY / this.HOUR_HEIGHT;

    this.isDragging = true;
    this.dragStartH = Math.max(0, Math.min(24, rawH));
    this.dragEndH = this.dragStartH;

    // Immediately show ghost for responsiveness
    requestAnimationFrame(() => this.updateGhost());
},

handleMouseMove(e) {
    if (!this.isDragging) return;

    const container = document.getElementById('ledger-container');
    if (!container) return;

    const rect = container.getBoundingClientRect();
    const scrollTop = container.scrollTop;
    const relativeY = e.clientY - rect.top + scrollTop;

    // Constrain to 0-24 hour range
    const rawH = relativeY / this.HOUR_HEIGHT;
    this.dragEndH = Math.max(0, Math.min(24, rawH));

    // Use requestAnimationFrame for smooth updates
    requestAnimationFrame(() => this.updateGhost());
},

    handleMouseOver(h, isHalf) {
        if (!this.isDragging) return;
        const val = isHalf ? h + 0.5 : h;
        if (this.dragEndH === val) return;
        this.dragEndH = val;
        this.renderDay();
    },

handleMouseUp() {
    if (!this.isDragging) return;

    const step = 0.25; // 15 min increments
    let start = Math.round(Math.min(this.dragStartH, this.dragEndH) / step) * step;
    let end = Math.round(Math.max(this.dragStartH, this.dragEndH) / step) * step;

    // Minimum duration of 15 mins if user just clicked
    if (start === end) end += 0.25;

    if (!this.db[this.selectedDate]) this.db[this.selectedDate] = [];

    const hasOverlap = this.db[this.selectedDate].some(s => (start < s.end && end > s.start));

    if (!hasOverlap && (end - start) >= 0.25) {
        const newEvent = {
            id: this.generateEventId(),
            start,
            end,
            label: "New Session",
            type: this.activeType || 'MEETING',
            isNew: true
        };
        this.db[this.selectedDate].push(newEvent);
        void this.saveEvent(newEvent);
    }

    // Clean up drag state
    this.isDragging = false;
    this.dragStartH = null;
    this.dragEndH = null;

    // Hide the ghost
    const ghost = document.getElementById('ghost-selection');
    if (ghost) ghost.style.display = 'none';

    this.renderDay();
},

updateGhost() {
    // Find the events column to append ghost to
    const eventsCol = document.querySelector('.ledger-events-col');
    if (!eventsCol) return;

    let g = document.getElementById('ghost-selection');
    if (!g) {
        g = document.createElement('div');
        g.id = 'ghost-selection';
        g.className = 'ghost-selection';
        eventsCol.appendChild(g);
    } else if (g.parentElement !== eventsCol) {
        eventsCol.appendChild(g);
    }

    if (!this.isDragging) {
        g.style.display = 'none';
        return;
    }

    const step = 0.25;
    const topH = Math.round(Math.min(this.dragStartH, this.dragEndH) / step) * step;
    let bottomH = Math.round(Math.max(this.dragStartH, this.dragEndH) / step) * step;
    if (topH === bottomH) bottomH += 0.25;

    const duration = bottomH - topH;
    const hours = Math.floor(duration);
    const mins = Math.round((duration - hours) * 60);
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

    g.style.display = 'block';
    g.style.top = `${topH * this.HOUR_HEIGHT}px`;
    g.style.height = `${duration * this.HOUR_HEIGHT}px`;

    g.innerHTML = `
        <div style="padding: 10px 12px; display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="color: #007AFF; font-size: 8px; font-weight: 900; letter-spacing: 1.5px; margin-bottom: 4px;">${this.activeType}</div>
                <div style="color: white; font-size: 13px; font-weight: 600;">New Session</div>
            </div>
            <div style="color: #007AFF; font-family: 'SF Mono'; font-size: 11px; font-weight: 600;">${timeStr}</div>
        </div>
    `;
},
    
    cycle(prop) {
        const options = {
            scope: ['INDIVIDUAL', 'TEAM', 'INSTITUTION'],
            role: ['ARCHITECT', 'SUPERVISOR'],
            lens: ['PROD', 'FINANCE', 'BOTH']
        };
        let current = this[prop];
        let idx = (options[prop].indexOf(current) + 1) % options[prop].length;
        let next = options[prop][idx];
        
        if(prop === 'scope') this.setLevel(next);
        if(prop === 'role') this.setRole(next);
        if(prop === 'lens') this.setLens(next);
    },

setLevel(level) {
    this.scope = level;
    this.activeBurnRate = this.rates[level]; // THIS LINE IS VITAL
    
    const btn = document.getElementById('cfg-level');
    if(btn) btn.innerText = `LEVEL: ${level}`;
    
    this.render();
},

    setRole(role) {
        this.role = role;
        const btn = document.getElementById('cfg-role');
        if(btn) btn.innerText = `ROLE: ${role}`;
        this.render();
    },

    setLens(lens) {
        this.lens = lens;
        const btn = document.getElementById('cfg-lens');
        if(btn) btn.innerText = `LENS: ${lens}`;
        document.body.className = `mode-${this.role.toLowerCase()} lens-${lens.toLowerCase()}`;
        this.render();
    },

switchTab(view, el) {
    // 1. Clear all active states
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
    
    // 2. Activate current
    el.classList.add('active');
    const target = document.getElementById(view + '-view');
    if (target) target.classList.add('active');

    // 3. Trigger specific renders
    if (view === 'day') this.renderDay();
    if (view === 'week') this.renderWeek();
    if (view === 'month') this.renderMonth();
    if (view === 'year') this.renderYear();
},

renderAuditGraph() {
    const stage = document.getElementById('graph-stage');
    if (!stage) return;
    
    const total = 25000;
    const percent = Math.max(0, (this.currentNet / total) * 100);
    
    // Clear and redraw with z-index protection
    stage.style.position = "relative";
    stage.innerHTML = `
        <div style="position:absolute; bottom:0; left:0; width:100%; height:4px; background:rgba(255,255,255,0.05);">
        </div>
        
        <div style="position:absolute; bottom:0; left:0; width:${percent}%; height:4px; background:#007AFF; box-shadow: 0 0 15px #007AFF; transition: width 0.5s ease; z-index: 2;">
        </div>

    `;
},
    
    render() {
        this.renderDay();
        this.renderMonth();
        this.renderYear();
    },

    toggleTypeMenu() {
      const menu = document.getElementById('type-selector-expanded');
      if (!menu) return;
      
      const isHidden = menu.style.display === 'none' || menu.style.display === '';
      
      if (isHidden) {
          menu.style.display = 'flex';
          menu.animate([
              { opacity: 0, transform: 'translateY(-10px)' },
              { opacity: 1, transform: 'translateY(0)' }
          ], { duration: 200, easing: 'cubic-bezier(0.2, 0, 0, 1)' });
      } else {
          menu.style.display = 'none';
      }
    },

    setType(type) {
        this.activeType = type;
        const avatar = document.getElementById('avatar-main-initial');
        const trigger = document.getElementById('type-avatar-trigger');
        const colors = { MEETING: '#007AFF', EVENT: '#FF9500', TASK: '#FF3B30' };
        const typeDisplay = document.getElementById('active-type-text');
        if (typeDisplay) typeDisplay.innerText = type;
        
        if (avatar) avatar.innerText = type.charAt(0);
        if (trigger) {
            trigger.style.color = colors[type];
            trigger.style.borderColor = colors[type];
        }

        document.getElementById('type-selector-expanded').style.display = 'none';
        this.updatePanelContext();
    },

    // Helper to add new agenda items dynamically
    addAgendaPoint() {
        const list = document.getElementById('agenda-items-list');
        const count = list.children.length + 1;
        const div = document.createElement('div');
        div.style.cssText = "display:flex; align-items:center; gap:12px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03);";
        div.innerHTML = `
            <span style="font-family:'SF Mono'; font-size:10px; color:#007AFF; opacity:0.4;">0${count}</span>
            <input type="text" placeholder="Set objective..." style="flex:1; background:transparent; border:none; color:white; font-size:13px; outline:none; opacity:0.8;">
            <div style="width:12px; height:12px; border: 1px solid rgba(255,255,255,0.1); border-radius:3px;"></div>
        `;
        list.appendChild(div);
    },

    // Financial Actions
    addExpense() { console.log("Expense added"); },
    addIncome() { console.log("Income added"); },
    audit() { alert("Strategic Audit Log: 24h cycle verified."); },
    
closeModal() {
    this.isMeetingActive = false;
    this.currentEventIdx = null;
    document.getElementById('modal-overlay').style.display = 'none';

    // Reset sidebar button
    const btn = document.querySelector('.btn-focus');
    if (btn) {
        btn.innerText = "START";
        btn.style.background = "white";
        btn.style.color = "black";
    }
},

injectStyles() {
    if (document.getElementById('engine-core-styles')) return;
    const style = document.createElement('style');
    style.id = 'engine-core-styles';
    style.innerHTML = `
        @keyframes breathe { ... }
        .breathing-roi { ... }
        #agenda-items-list::-webkit-scrollbar { ... }
    `;
    document.head.appendChild(style);
},

updatePanelContext() {
    const container = document.getElementById('dynamic-fields-container');
    const modalTitle = document.getElementById('modal-main-title');
    const activeColor = { MEETING: '#007AFF', EVENT: '#FF9500', TASK: '#FF3B30' }[this.activeType];
    
    // --- 0. INTERACTION LAYER FIX ---
    // Ensure the modal layer doesn't intercept drag events meant for the ledger
    container.style.pointerEvents = "none"; 
    container.style.zIndex = "100"; // High visual priority
    
    const now = new Date();
    const todayISO = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);

    const ledger = [
        { desc: 'Vercel Edge Config', amt: -20.00, time: '2026-02-02 16:42' },
        { desc: 'Retainer Deposit', amt: 2500.00, time: '2026-02-02 12:05' },
        { desc: 'S3 Storage Bucket', amt: -45.00, time: '2026-02-01 09:00' }
    ];

    const historicalNotes = [
        { date: '2026-02-02', text: 'Confirmed migration architecture.' },
        { date: '2026-02-01', text: 'Security audit passed.' },
        { date: '2026-01-28', text: 'Budget approval for Q1.' },
        { date: '2026-01-25', text: 'Initial scoping session.' },
        { date: '2026-01-20', text: 'Vendor compliance check.' },
        { date: '2026-01-15', text: 'Project kickoff.' }
    ];

    const totalBudget = 25000.00; 
    const netRemaining = 27435.00;

    modalTitle.innerText = `NEW ${this.activeType}`;

    if (ENGINE.activeTypeContext.isRemote === undefined) ENGINE.activeTypeContext.isRemote = true;
    const isRemote = ENGINE.activeTypeContext.isRemote;

    let html = '';
    
    // --- 1. HEADER (Strategic Objective) ---
    html += `
        <div style="grid-column: span 2; pointer-events: all; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px;">
            <div style="flex: 1;">
                <label style="color: ${activeColor}; font-weight: 800; font-size: 10px; letter-spacing: 2px; text-transform:uppercase;">Strategic Objective</label>
                <input type="text" value="Infrastructure Session" 
                       style="background:transparent; border:none; color:white; font-size:28px; font-weight:700; width:100%; outline:none; letter-spacing: -1px;">
            </div>
            <div style="display: flex; gap: 8px;">
                <input type="date" value="${todayISO}" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'SF Mono'; font-size: 11px; padding: 6px 10px; border-radius: 8px;">
                <input type="time" value="${currentTime}" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'SF Mono'; font-size: 11px; padding: 6px 10px; border-radius: 8px;">
            </div>
        </div>
    `;

    // --- 2. LOCATION / URL TOGGLE ---
    html += `
        <div style="grid-column: span 2; pointer-events: all; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.02); padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03);">
            <div style="display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 8px;">
                <button onclick="ENGINE.activeTypeContext.isRemote = !ENGINE.activeTypeContext.isRemote; ENGINE.updatePanelContext();" 
                        style="background: rgba(255,255,255,0.1); border: none; cursor: pointer; padding: 4px 10px; border-radius: 6px; font-size: 14px;">
                    ${isRemote ? '🌐' : '📍'}
                </button>
            </div>
            <div style="flex: 1;">
                <label style="opacity: 0.3; font-size: 8px; font-weight: 800; text-transform:uppercase; display: block;">${isRemote ? 'Meeting URL' : 'Location'}</label>
                <input type="text" id="modal-location" value="${isRemote ? 'deepworkszt.vercel.app' : 'Conference Room A'}" 
                       style="background: transparent; border: none; color: white; font-size: 12px; width: 100%; outline: none; font-family: 'SF Mono';">
            </div>
        </div>
    `;

    // --- 3. SESSION AGENDA ---
    html += `
        <div class="panel-section" style="grid-column: span 2; pointer-events: all; background: rgba(255,255,255,0.02); border-radius: 20px; padding: 14px 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
                <label style="opacity: 0.3; font-size: 9px; font-weight: 800; text-transform:uppercase;">Session Agenda</label>
                <button onclick="ENGINE.addAgendaPoint()" style="background:transparent; border:none; color:${activeColor}; font-size:9px; font-weight:800; cursor:pointer;">+ ADD POINT</button>
            </div>
            <div id="agenda-items-list" style="display: flex; flex-direction: column; max-height: 120px; overflow-y: auto;">
                ${[1, 2, 3, 4].map(i => `
                    <div style="display:flex; align-items:center; gap:12px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03);">
                        <span style="font-family:'SF Mono'; font-size:10px; color:${activeColor}; opacity:0.4;">0${i}</span>
                        <input type="text" placeholder="Set objective..." style="flex:1; background:transparent; border:none; color:white; font-size:13px; outline:none; opacity:0.8;">
                        <div style="width:12px; height:12px; border: 1px solid rgba(255,255,255,0.1); border-radius:3px;"></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // --- 4. STAKEHOLDERS & NOTES ---
    html += `
        <div style="grid-column: span 2; pointer-events: all; display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; margin-bottom: 12px;">
            <div class="panel-section" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 14px; border: 1px solid rgba(255,255,255,0.03);">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <label style="opacity: 0.3; font-size: 8px; font-weight: 800; text-transform:uppercase;">Stakeholders</label>
                    <span onclick="ENGINE.addStakeholder()" style="color:${activeColor}; font-size:8px; font-weight:800; cursor:pointer;">+ INVITE</span>
                </div>
                <div id="stakeholder-list" style="max-height: 105px; overflow-y: auto; display:flex; flex-direction:column; gap:8px;">
                    ${['S. Chen (Arch)', 'A. Marcus (Dev)', 'J. Doe (PM)', 'K. Sato (Sec)', 'L. Wright (Ops)'].map(name => `
                        <div style="font-size:11px; color:rgba(255,255,255,0.8); display:flex; align-items:center;">
                            <span style="color:${activeColor}; margin-right:8px;">●</span>${name}
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="panel-section" style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 14px; border: 1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column;">
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <input type="text" placeholder="Quick note..." style="flex:1; background:rgba(255,255,255,0.04); border:none; color:white; font-size:11px; padding: 6px 10px; border-radius: 6px; outline:none;">
                    <button style="background:${activeColor}; border:none; color:white; font-size:8px; font-weight:800; padding:0 12px; border-radius:6px;">SAVE</button>
                </div>
                <div id="notes-history" style="max-height: 85px; overflow-y: auto; opacity: 0.6;">
                    ${historicalNotes.map(n => `
                        <div style="font-size: 10px; margin-bottom: 8px; font-family:'SF Mono'; display: flex; gap: 32px;">
                            <span style="color:${activeColor}; font-weight:bold; white-space: nowrap;">[${n.date}]</span>
                            <span style="color: rgba(255,255,255,0.8);">${n.text}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    // --- 5. FINANCE BAR ---
    html += `
        <div class="panel-section" style="grid-column: span 2; pointer-events: all; background: rgba(255,255,255,0.015); border-radius: 20px; padding: 16px 20px; border: 1px solid rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 14px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div>
                        <label style="opacity:0.2; font-size: 8px; font-weight: 800; text-transform:uppercase; display:block; margin-bottom:2px;">Net Remaining</label>
                        <span style="color:white; font-size: 22px; font-weight: 600; font-family:'SF Mono';">$${netRemaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div style="height: 24px; width: 1px; background: rgba(255,255,255,0.08);"></div>
                    <div>
                        <label style="opacity:0.2; font-size: 8px; font-weight: 800; text-transform:uppercase; display:block; margin-bottom:2px;">Budget Cap</label>
                        <span style="color:rgba(255,255,255,0.4); font-size: 14px; font-family:'SF Mono';">$${totalBudget.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="ENGINE.addExpense()" style="background:rgba(255,59,48,0.1); border:1px solid rgba(255,59,48,0.2); color:#FF3B30; width:38px; height:38px; border-radius:10px; cursor:pointer; font-size:18px;">−</button>
                    <button onclick="ENGINE.addIncome()" style="background:rgba(50,215,75,0.1); border:1px solid rgba(50,215,75,0.2); color:#32D74B; width:38px; height:38px; border-radius:10px; cursor:pointer; font-size:18px;">+</button>
                    <button onclick="ENGINE.audit()" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:white; font-size:9px; font-weight:800; padding:0 18px; border-radius:10px; cursor:pointer; letter-spacing:1px;">AUDIT</button>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.04);">
                ${ledger.map(t => `
                    <div style="display:flex; flex-direction:column; flex: 1;">
                        <label style="opacity:0.15; font-size:7px; text-transform:uppercase; white-space:nowrap; margin-bottom:2px;">${t.desc}</label>
                        <span style="font-size:11px; font-family:'SF Mono'; font-weight:700; color:${t.amt > 0 ? '#32D74B' : 'rgba(255,255,255,0.7)'};">
                            ${t.amt > 0 ? '+' : ''}${t.amt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </span>
                        <span style="opacity:0.15; font-size:7px; font-family:'SF Mono'; margin-top:1px;">${t.time}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
},

    
// --- Restored Helper Methods ---

setLocMode(mode) {
    const input = document.getElementById('modal-location');
    if (!input) return;
    ENGINE.activeTypeContext.isRemote = (mode === 'web');
    this.updatePanelContext();
},

addStakeholder() {
    const name = prompt("Enter Stakeholder Name:");
    if (!name) return;
    const list = document.getElementById('stakeholder-list');
    const div = document.createElement('div');
    div.style.cssText = "display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-bottom:8px;";
    div.innerHTML = `<span><span style="color:${this.activeType === 'MEETING' ? '#007AFF' : '#FF9500'}; margin-right:8px;">●</span>${name}</span><span style="font-size:10px; opacity:0.2; cursor:pointer;" onclick="this.parentElement.remove()">✕</span>`;
    list.appendChild(div);
},

saveSession() {
    const titleInput = document.getElementById('strategic-objective-input');
    const title = titleInput ? titleInput.value : "New Infrastructure Session";
    
    // Logic to update the last session or create new
    if (!this.db[this.selectedDate]) this.db[this.selectedDate] = [];
    
    // If we just added one via handleMouseUp, update its label
    const sessions = this.db[this.selectedDate];
    if (sessions.length > 0) {
        sessions[sessions.length - 1].label = title;
        sessions[sessions.length - 1].type = this.activeType;
        void this.saveEvent(sessions[sessions.length - 1]);
    }

    document.getElementById('modal-overlay').style.display = 'none';
    this.renderDay(); // Refresh the ledger view
},

async ensureUserStorage() {
    if (this.userSheetId) return;

    const listRes = await gapi.client.drive.files.list({
        q: `name = '${ENGINE_USER_FILE_NAME}' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false`,
        fields: 'files(id, name)',
        spaces: 'drive'
    });
    const existing = listRes.result.files && listRes.result.files[0];
    if (existing) {
        this.userSheetId = existing.id;
    } else {
        const createRes = await gapi.client.drive.files.create({
            resource: { name: ENGINE_USER_FILE_NAME, mimeType: 'application/vnd.google-apps.spreadsheet' },
            fields: 'id'
        });
        this.userSheetId = createRes.result.id;
    }

    await this.ensureSheetStructure();
},

async ensureSheetStructure() {
    if (!this.userSheetId) return;
    const sheetRes = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: this.userSheetId
    });
    const sheets = sheetRes.result.sheets || [];
    const existingNames = new Set(sheets.map(s => s.properties.title));
    const requests = [];

    Object.values(this.sheetNames).forEach((title) => {
        if (!existingNames.has(title)) {
            requests.push({ addSheet: { properties: { title } } });
        }
    });

    if (requests.length) {
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: this.userSheetId,
            resource: { requests }
        });
    }

    const refreshed = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: this.userSheetId
    });
    const sheetInfo = {};
    (refreshed.result.sheets || []).forEach((sheet) => {
        sheetInfo[sheet.properties.title] = sheet.properties.sheetId;
    });
    this.sheetInfo = sheetInfo;

    await Promise.all([
        this.writeHeaders(this.sheetNames.events, ['id', 'date', 'start', 'end', 'label', 'type']),
        this.writeHeaders(this.sheetNames.transactions, ['id', 'date', 'time', 'desc', 'amount', 'category']),
        this.writeHeaders(this.sheetNames.meta, ['key', 'value'])
    ]);
},

async writeHeaders(sheetName, headers) {
    if (!this.userSheetId) return;
    await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: this.userSheetId,
        range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
        valueInputOption: 'RAW',
        resource: { values: [headers] }
    });
},

async loadData() {
    await this.ensureUserStorage();
    const [eventsRes, txRes, metaRes] = await Promise.all([
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A:F`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A:F`
        }),
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.meta}!A:B`
        })
    ]);

    const eventsRows = eventsRes.result.values || [];
    const txRows = txRes.result.values || [];
    const metaRows = metaRes.result.values || [];

    this.db = {};
    eventsRows.slice(1).forEach((row) => {
        if (row.length < 6) return;
        const [id, date, start, end, label, type] = row;
        if (!date) return;
        if (!this.db[date]) this.db[date] = [];
        this.db[date].push({
            id,
            start: parseFloat(start),
            end: parseFloat(end),
            label,
            type
        });
    });

    this.transactions = txRows.slice(1).map((row) => {
        const [id, date, time, desc, amount, category] = row;
        return {
            id,
            date,
            time,
            desc,
            amount: parseFloat(amount),
            category
        };
    }).filter(tx => tx.date);

    this.transactions.sort((a, b) => {
        const aStamp = `${a.date} ${a.time || '00:00'}`;
        const bStamp = `${b.date} ${b.time || '00:00'}`;
        return bStamp.localeCompare(aStamp);
    });

    const meta = {};
    metaRows.slice(1).forEach(([key, value]) => {
        if (key) meta[key] = value;
    });
    if (meta.currentNet) this.currentNet = parseFloat(meta.currentNet);
},

async saveEvent(event) {
    if (!event || !event.id) return;
    await this.ensureUserStorage();
    const date = event.date || this.selectedDate;
    const row = [event.id, date, event.start, event.end, event.label, event.type];
    const rowIndex = await this.findRowById(this.sheetNames.events, event.id);
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A${rowIndex}:F${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.events}!A:F`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
},

async deleteEventById(eventId) {
    if (!eventId) return;
    await this.ensureUserStorage();
    const rowIndex = await this.findRowById(this.sheetNames.events, eventId);
    if (!rowIndex || !this.sheetInfo || !this.sheetInfo[this.sheetNames.events]) return;

    await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: this.userSheetId,
        resource: {
            requests: [{
                deleteDimension: {
                    range: {
                        sheetId: this.sheetInfo[this.sheetNames.events],
                        dimension: 'ROWS',
                        startIndex: rowIndex - 1,
                        endIndex: rowIndex
                    }
                }
            }]
        }
    });
},

async saveTransaction(tx) {
    if (!tx || !tx.id) return;
    await this.ensureUserStorage();
    const row = [tx.id, tx.date, tx.time, tx.desc, tx.amount, tx.category];
    const rowIndex = await this.findRowById(this.sheetNames.transactions, tx.id);
    if (rowIndex) {
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A${rowIndex}:F${rowIndex}`,
            valueInputOption: 'RAW',
            resource: { values: [row] }
        });
    } else {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: this.userSheetId,
            range: `${this.sheetNames.transactions}!A:F`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [row] }
        });
    }
},

async saveMeta() {
    if (!this.userSheetId) return;
    await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: this.userSheetId,
        range: `${this.sheetNames.meta}!A2:B2`,
        valueInputOption: 'RAW',
        resource: { values: [['currentNet', this.currentNet.toString()]] }
    });
},

queueMetaSave() {
    if (this.metaSaveTimer) return;
    this.metaSaveTimer = setTimeout(async () => {
        this.metaSaveTimer = null;
        await this.saveMeta();
    }, 10000);
},

async findRowById(sheetName, id) {
    const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: this.userSheetId,
        range: `${sheetName}!A:A`
    });
    const values = res.result.values || [];
    const rowIndex = values.findIndex((row) => row[0] === id);
    return rowIndex >= 0 ? rowIndex + 1 : null;
},
    
openMeeting(idx) {
    this.isMeetingActive = true;
    this.currentEventIdx = idx;
    document.getElementById('modal-overlay').style.display = 'flex';

    // Show delete button for existing events
    const deleteBtn = document.getElementById('delete-event-btn');
    if (deleteBtn) {
        deleteBtn.style.display = idx !== null ? 'block' : 'none';
    }

    // Update modal title based on context
    const modalTitle = document.getElementById('modal-main-title');
    const events = this.db[this.selectedDate] || [];
    if (modalTitle && events[idx]) {
        modalTitle.textContent = events[idx].label || 'Edit Session';
    }

    // Sync the sidebar button state
    const btn = document.querySelector('.btn-focus');
    if (btn) {
        btn.innerText = "TERMINATE FOCUS";
        btn.style.background = "#ff453a";
        btn.style.color = "white";
    }

    this.updatePanelContext();
},

togglePreRead(el) {
    let popover = document.getElementById('preread-popover');
    if (!popover) {
        popover = document.createElement('div');
        popover.id = 'preread-popover';
        popover.style.cssText = "position:absolute; background:#1c1c1e; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:15px; box-shadow:0 20px 40px rgba(0,0,0,0.5); z-index:3000; width:280px; display:none;";
        popover.innerHTML = `
            <label style="color:rgba(255,255,255,0.4); margin-bottom:10px; display:block; font-weight:800; font-size:9px; letter-spacing:1px;">CONTEXT / PRE-READ</label>
            <textarea style="width:100%; height:100px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); color:white; font-size:12px; border-radius:8px; padding:10px; outline:none; resize:none;" placeholder="Links or briefing notes..."></textarea>
        `;
        document.body.appendChild(popover);
    }
    
    const isHidden = popover.style.display === 'none' || popover.style.display === '';
    if (isHidden) {
        const rect = el.getBoundingClientRect();
        popover.style.display = 'block';
        popover.style.top = `${rect.bottom + 10}px`;
        popover.style.left = `${rect.left - 200}px`;
    } else {
        popover.style.display = 'none';
    }
},

    startMeetingTicker(hourlyRate) {
        const ticker = document.getElementById('burn-ticker');
        if(!ticker) return;
        const ratePerSec = hourlyRate / 3600;
        let elapsedSec = 0;
        
        if(this.tickerInterval) clearInterval(this.tickerInterval);
        
        this.tickerInterval = setInterval(() => {
            elapsedSec++;
            ticker.innerText = `$${(elapsedSec * ratePerSec).toFixed(2)} LIVE`;
        }, 1000);
    },

renderDay() {
    const events = this.db[this.selectedDate] || [];
    const container = document.getElementById('ledger-container');
    if (!container) return;

    this.HOUR_HEIGHT = 100;
    const colors = { MEETING: '#007AFF', EVENT: '#FF9500', TASK: '#FF3B30' };

    // Format time helper
    const formatTime = (h) => {
        const hours = Math.floor(h);
        const mins = Math.round((h - hours) * 60);
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    };

    // Get transactions for today
    const todayTx = this.transactions.filter(tx => tx.date === this.selectedDate);

    // Build two-column layout
    let html = `
        <div class="ledger-grid" style="position: relative; height: ${24 * this.HOUR_HEIGHT}px;">
            <div class="ledger-events-col" style="position: relative;">
                <div id="time-now-line"></div>`;

    // Hour grid lines
    for (let h = 0; h <= 23; h++) {
        html += `
            <div class="hour-row" style="height:${this.HOUR_HEIGHT}px; border-bottom: 1px solid rgba(255,255,255,0.03); position:relative;">
                <div class="hour-label" style="width: 70px; color: rgba(255,255,255,0.12); font-family: 'SF Mono'; font-size: 10px; padding-top: 8px;">
                    ${h.toString().padStart(2, '0')}:00
                </div>
            </div>`;
    }

    // Event Blocks
    events.forEach((session, idx) => {
        const topPos = session.start * this.HOUR_HEIGHT;
        const height = (session.end - session.start) * this.HOUR_HEIGHT;
        const color = colors[session.type] || colors.MEETING;
        const duration = session.end - session.start;
        const durationStr = duration >= 1 ? `${Math.floor(duration)}h ${Math.round((duration % 1) * 60)}m` : `${Math.round(duration * 60)}m`;

        // Responsive content based on block height
        const isCompact = height <= 35;  // 15min or less
        const isMedium = height > 35 && height <= 60;  // 30min

        let blockContent = '';
        if (isCompact) {
            // Ultra-compact: just label
            blockContent = `
                <div style="padding: 4px 8px; pointer-events: none; display: flex; align-items: center; justify-content: space-between; height: 100%;">
                    <span style="color: white; font-weight: 600; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${session.label}</span>
                    <span style="font-family: 'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.4); margin-left: 8px;">${durationStr}</span>
                </div>`;
        } else if (isMedium) {
            // Medium: type + label
            blockContent = `
                <div style="padding: 6px 10px; pointer-events: none; height: 100%;">
                    <div style="color: ${color}; font-size: 8px; font-weight: 800; letter-spacing: 1px;">${session.type}</div>
                    <div style="color: white; font-weight: 600; font-size: 12px; margin-top: 2px;">${session.label}</div>
                </div>`;
        } else {
            // Full: all info
            blockContent = `
                <div style="padding: 10px 12px; pointer-events: none; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <div style="color: ${color}; font-size: 8px; font-weight: 800; letter-spacing: 1px; margin-bottom: 2px;">${session.type}</div>
                        <div style="color: white; font-weight: 600; font-size: 13px;">${session.label}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                        <span style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.4);">${formatTime(session.start)} – ${formatTime(session.end)}</span>
                        <span style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.3);">${durationStr}</span>
                    </div>
                </div>`;
        }

        html += `
            <div class="block-space ${session.isNew ? 'block-creation-anim' : ''}"
                data-block-idx="${idx}"
                style="
                    top: ${topPos}px;
                    height: ${height}px;
                    left: 80px;
                    right: 12px;
                    border-left: 3px solid ${color};
                    position: absolute;
                    cursor: pointer;
                    z-index: 60;
                    pointer-events: all;
                ">
                <button class="block-delete-btn" onclick="event.stopPropagation(); ENGINE.deleteEvent(${idx});" title="Delete">×</button>
                ${blockContent}
            </div>`;
        session.isNew = false;
    });

    html += `</div>`; // Close events column

    // Transactions column
    html += `<div class="ledger-transactions-col" style="position: relative;">`;

    // Hour guides for transactions (no lines, just spacing)
    for (let h = 0; h <= 23; h++) {
        html += `<div style="height:${this.HOUR_HEIGHT}px;"></div>`;
    }

    // Transaction markers
    todayTx.forEach(tx => {
        const [hours, mins] = tx.time.split(':').map(Number);
        const timeDecimal = hours + (mins / 60);
        const topPos = timeDecimal * this.HOUR_HEIGHT;
        const isIncome = tx.amount >= 0;

        html += `
            <div class="transaction-marker ${isIncome ? 'income' : 'expense'}" style="top: ${topPos}px;">
                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                    <span style="color: rgba(255,255,255,0.6); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">${tx.desc}</span>
                    <span style="font-family: 'SF Mono'; font-size: 10px; color: rgba(255,255,255,0.5); margin-left: 8px;">
                        ${isIncome ? '+' : ''}${tx.amount.toFixed(0)}
                    </span>
                </div>
                <div style="font-family: 'SF Mono'; font-size: 9px; color: rgba(255,255,255,0.25); margin-top: 2px;">${tx.time}</div>
            </div>`;
    });

    html += `</div></div>`; // Close transactions column and grid

    container.innerHTML = html;
    this.updateTimeline(false);
},

// Delete event directly from block
async deleteEvent(idx) {
    const events = this.db[this.selectedDate];
    if (!events || !events[idx]) return;

    const [removed] = events.splice(idx, 1);
    if (events.length === 0) delete this.db[this.selectedDate];

    if (removed && removed.id) {
        await this.deleteEventById(removed.id);
    }
    this.renderDay();
},
    
updateTimeline(shouldScroll = false) {
    const line = document.getElementById('time-now-line');
    if (!line) return;

    // Only show line for today
    const today = new Date().toISOString().split('T')[0];
    if (this.selectedDate !== today) {
        line.style.display = 'none';
        return;
    }

    line.style.display = 'block';
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const totalHours = hours + (minutes / 60) + (seconds / 3600);

    const topPos = totalHours * this.HOUR_HEIGHT;
    line.style.top = `${topPos}px`;

    if (shouldScroll) {
        const container = document.getElementById('ledger-container');
        if (container) {
            const scrollTarget = topPos - (container.clientHeight / 2);
            container.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }
    }
},

    renderWeek() {
        const container = document.getElementById('weekly-columns');
        if (!container) return;
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let html = '<div style="margin-top: 30px;">' + Array.from({length: 24}, (_, h) => `<div style="height:40px; font-size:9px; color:var(--text-dim); text-align:right; padding-right:10px;">${h.toString().padStart(2,'0')}:00</div>`).join('') + '</div>';
        days.forEach((day, i) => {
            html += `<div class="week-day-col"><div class="p-label" style="text-align:center;">${day}</div><div style="height:960px; position:relative; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05);"></div></div>`;
        });
        container.innerHTML = html;
    },

    renderMonth() {
        const container = document.getElementById('monthly-grid');
        if (!container) return;
        let html = '';
        for(let d=1; d<=31; d++) {
            html += `<div class="month-day-card"><div class="day-num">${d}</div></div>`;
        }
        container.innerHTML = html;
    },

    renderYear() {
        const container = document.getElementById('yearly-grid');
        if (!container) return;
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        container.innerHTML = months.map(m => `<div><div class="p-label">${m}</div><div class="cal-grid">${Array.from({length:31}, () => `<div class="dot"></div>`).join('')}</div></div>`).join('');
    },

commence() {
    this.isMeetingActive = !this.isMeetingActive;
    const btn = document.getElementById('commence-btn');
    
    if (this.isMeetingActive) {
        btn.innerText = "TERMINATE SESSION";
        btn.style.background = "#FF453A"; 
        btn.style.color = "white";
        // Start recording time logic...
    } else {
        btn.innerText = "START";
        btn.style.background = "#FFFFFF";
        btn.style.color = "#000000";
        // Finalize transaction logic...
    }
}
    
};

// Global Execution Logic
setInterval(() => {
    const clock = document.getElementById('clock-display');
    if (clock) {
        const now = new Date();
        clock.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }
    // Update the red "Now" line on the ledger every minute
    if (new Date().getSeconds() === 0) ENGINE.updateTimeline();
}, 1000);

// Initialize the Engine on window load
window.onload = () => showLoginUI();

// Add this to your script to catch the end of a drag anywhere on the screen
window.addEventListener('mouseup', () => {
    if (ENGINE.isDragging) ENGINE.handleMouseUp();
});
    
</script>

<!-- Modal Overlay - Centered Glass Panel -->
<div id="modal-overlay">
    <div class="meeting-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 id="modal-main-title" style="margin: 0; color: white; font-size: 20px; font-weight: 600;">NEW MEETING</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button id="delete-event-btn" onclick="ENGINE.deleteCurrentEvent()" style="background: rgba(255,59,48,0.1); border: 1px solid rgba(255,59,48,0.3); color: #FF453A; padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; display: none;">DELETE</button>
                <button onclick="ENGINE.closeModal()" style="background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.6); width: 32px; height: 32px; border-radius: 8px; font-size: 18px; cursor: pointer; transition: all 0.15s;">&times;</button>
            </div>
        </div>
        <div id="dynamic-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"></div>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button onclick="ENGINE.closeModal()" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: rgba(255,255,255,0.7); font-weight: 600; cursor: pointer;">CANCEL</button>
            <button onclick="ENGINE.saveSession()" style="flex: 2; padding: 14px; background: #007AFF; border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer;">SAVE SESSION</button>
        </div>
    </div>
</div>

</body>

</html>
